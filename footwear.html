<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Footwear - Fitrite</title>
  <!-- Google Font for header and headings -->
  <link href="https://fonts.googleapis.com/css2?family=Special+Elite&display=swap" rel="stylesheet">
  <style>
    /* CSS Reset and Box Model Standardization */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    /* Global Styles */
    body {
      margin: 0;
      padding: 0;
      background: #f4f4f4;
      font-family: Arial, sans-serif;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    
    /* Header Styles (Transparent with Special Elite font) */
    header {
      position: relative;
      z-index: 1000;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px;
      background-color: transparent;
      width: 100%;
      font-family: 'Special Elite', monospace;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    
    header .logo h1 {
      margin: 0;
      font-size: 1.5em;
      font-weight: normal;
      color: black;
    }
    
    header .logo p {
      margin: 3px 0 0;
      font-size: 0.8em;
      font-style: italic;
      color: black;
    }
    
    /* Mobile Menu Toggle */
    .menu-toggle {
      display: none;
      flex-direction: column;
      justify-content: space-between;
      width: 30px;
      height: 21px;
      cursor: pointer;
      z-index: 20;
      position: relative;
    }
    
    .menu-toggle span {
      display: block;
      position: absolute;
      left: 0;
      height: 3px;
      width: 100%;
      background-color: #000; /* darker black */
      border-radius: 3px;
      transition: transform 0.25s ease, opacity 0.25s ease;
    }
    .menu-toggle span:nth-child(1) { top: 0; }
    .menu-toggle span:nth-child(2) { top: 9px; }
    .menu-toggle span:nth-child(3) { top: 18px; }
    .menu-toggle.active span:nth-child(1) { transform: translateY(9px) rotate(45deg); }
    .menu-toggle.active span:nth-child(2) { opacity: 0; }
    .menu-toggle.active span:nth-child(3) { transform: translateY(-9px) rotate(-45deg); }
    
    header nav {
      padding-right: 0;
    }
    
    header nav ul {
      list-style: none;
      display: flex;
      gap: 15px;
      margin: 0;
      padding: 0;
    }
    
    header nav ul li a {
      color: black;
      text-decoration: none;
      font-weight: normal;
      transition: color 0.3s;
      pointer-events: auto;
      padding: 5px 10px;
      display: block;
    }
    
    header nav ul li a:hover {
      text-decoration: underline;
      color: black;
    }
    
    /* Search Bar */
    #search-bar {
      background-color: transparent;
      padding: 15px;
      text-align: center;
      border-bottom: 1px solid #ddd;
      width: 100%;
    }
    
    #searchInput {
      width: 90%;
      max-width: 600px;
      padding: 10px 15px;
      font-size: 1em;
      border: 1px solid #ccc;
      border-radius: 25px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      outline: none;
    }
    
    #searchInput:focus {
      border-color: #333;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }
    
    /* Products Grid - Now responsive like bargains page */
    .products {
      display: grid;
      grid-template-columns: repeat(4, 1fr); /* Default to 4 columns for desktop */
      gap: 20px;
      padding: 20px;
      background-color: #f4f4f4;
      width: 100%;
      max-width: 1400px;
      margin: 0 auto;
    }
    
    /* Product Box – White square that wraps an image container and text */
    .product {
      background-color: white;
      border: 1px solid #ddd;
      border-radius: 15px;
      box-shadow: 0px 4px 10px rgba(0,0,0,0.2);
      overflow: hidden;
      text-align: center;
      cursor: pointer;
      transition: transform 0.3s, box-shadow 0.3s;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 15px;
      touch-action: manipulation;
      width: 100%;
      height: auto;
      min-height: 300px;
      position: relative;
    }
    
    .product:hover {
      transform: scale(1.02);
      box-shadow: 0px 6px 15px rgba(0,0,0,0.3);
    }
    
    /* Image Container – Responsive instead of fixed size */
    .image-container {
      width: 100%;
      max-width: 200px;
      height: 180px;
      background: white;
      display: flex;
      justify-content: center;
      align-items: center;
      margin: 0 auto 15px;
      overflow: hidden;
    }
    
    .image-container img {
      max-width: 95%;
      max-height: 95%;
      object-fit: contain;
      display: block;
      border-radius: 15px; /* match modal/leather_jackets rounded corners */
    }
    
    /* Product Text */
    .product p {
      margin: 5px 0;
      font-weight: bold;
      font-size: 1.1em;
      font-family: 'Special Elite', monospace;
    }
    
    /* Heading for Footwear Section */
    #footwear h2 {
      font-family: 'Special Elite', monospace;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      text-align: center;
      margin-top: 20px;
    }
    
    /* Footer */
    footer {
      text-align: center;
      background-color: transparent;
      color: #333;
      font-size: 0.9em;
      margin: 20px 0;
      padding: 15px;
      width: 100%;
    }
    
    footer p {
      margin: 5px 0;
    }
    
    /* Modal Styles - Responsive */
    .modal {
      display: none;
      position: fixed;
      z-index: 999;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.4s ease;
      justify-content: center;
      align-items: center;
    }
    
    .modal.show {
      display: flex;
      opacity: 1;
      pointer-events: auto;
    }
    
    .modal-content {
      background-color: #fff;
      margin: 5% auto;
      padding: 1.5rem;
      border: 1px solid #888;
      width: 90%;
      max-width: 300px;
      border-radius: 15px;
      text-align: center;
      position: relative;
      animation: fadeInSlide 0.4s ease;
    }
    
    @keyframes fadeInSlide {
      0% {
        opacity: 0;
        transform: translateY(-50px);
      }
      100% {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .close-btn {
      position: absolute;
      top: 0.5rem;
      right: 0.75rem;
      font-size: 1.2rem;
      font-weight: bold;
      cursor: pointer;
      touch-action: manipulation;
    }
    
    .close-btn:hover {
      color: red;
    }
    
    /* Modal Product Image */
    #modalProductImage {
      width: 100%;
      max-width: 250px;
      height: auto;
      border-radius: 15px;
      margin-bottom: 1rem;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }
    
    .proceed-btn {
      background-color: #000;
      color: #fff;
      border: none;
      padding: 0.75rem 1.5rem;
      margin-top: 1rem;
      cursor: pointer;
      font-size: 1rem;
      border-radius: 15px;
      transition: background-color 0.3s;
      touch-action: manipulation;
      width: 100%;
    }
    
    .proceed-btn:hover {
      background-color: #333;
    }

    /* Size Selector Styles */
    .size-selector {
      background-color: #000; /* Match button background */
      color: #fff; /* Match button text color */
      border: none; /* Match button border */
      padding: 0.75rem; /* Adjust padding */
      margin-top: 1rem; /* Consistent margin */
      border-radius: 15px; /* Match button border-radius */
      font-size: 1rem; /* Match button font-size */
      width: 100%; /* Full width */
      cursor: pointer;
      -webkit-appearance: none; /* Remove default OS styling */
      -moz-appearance: none;
      appearance: none;
      background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23ffffff%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.4-5.4-13z%22%2F%3E%3C%2Fsvg%3E") ; /* Custom arrow (white) */
      background-repeat: no-repeat;
      background-position: right 0.7em top 50%, 0 0;
      background-size: 0.65em auto, 100%;
      text-align: center; /* Center the text */
      text-align-last: center; /* For Firefox */
      -moz-text-align-last: center; /* For Firefox */
      /* Make dropdown scrollable if too many options */
      max-height: 200px;
      overflow-y: auto;
    }

    .size-selector option {
        background-color: #333; /* Darker background for options */
        color: #fff;
    }

    /* Toast Notification */
    #toast {
      position: fixed;
      top: 20px;
      right: 20px;
      background-color: #333;
      color: #fff;
      padding: 10px 15px;
      border-radius: 15px;
      opacity: 0;
      transition: opacity 0.3s;
      pointer-events: none;
      z-index: 10000;
    }
    
    #toast.show {
      opacity: 1;
    }
    
    /* Empty slot styling */
    .empty-slot {
      min-height: 100px;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    
    /* Discount Tag Styles - ADDED FOR DISCOUNT SYSTEM */
    .discount-tag {
      position: absolute;
      top: 10px;
      left: 10px;
      padding: 5px 10px;
      border-radius: 3px;
      font-weight: bold;
      z-index: 5;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      text-align: center;
    }
    
    /* Red Tag (≤ 55%) */
    .discount-tag.red {
      background-color: #ff0000;
      color: white;
      font-size: 0.9em;
    }
    
    /* Gold Tag (> 55%) */
    .discount-tag.gold {
      background-color: gold;
      color: #333;
      font-size: 0.95em;
      padding: 6px 10px;
      font-weight: bold;
    }
    
    /* Price Display for Discounted Products */
    .original-price {
      text-decoration: line-through;
      color: #888;
      margin-right: 5px;
    }
    
    .new-price {
      color: green;
      font-weight: bold;
    }
    
    /* Media Queries for Responsive Design - Adapting like bags page */
    /* Large screens */
    @media (max-width: 1200px) {
      .products {
        grid-template-columns: repeat(3, 1fr);
        grid-gap: 20px;
      }
    }
    
    /* Medium screens */
    @media (max-width: 900px) {
      .products {
        grid-template-columns: repeat(2, 1fr);
        grid-gap: 15px;
      }
      
      header {
        padding: 20px;
      }
      
      header .logo h1 {
        font-size: 1.8em;
      }
      
      header .logo p {
        font-size: 0.9em;
        margin: 5px 0 0;
      }
      
      #search-bar {
        padding: 20px 15px;
      }
      
      #searchInput {
        width: 80%;
      }
      
      .image-container {
        height: 250px;
      }
      
      .modal-content {
        padding: 2rem;
        max-width: 350px;
      }
      
      .proceed-btn {
        width: auto;
        min-width: 200px;
      }
    }
    
    /* Smartphone displays - 2 per line as requested */
    @media (max-width: 600px) {
      .products {
        grid-template-columns: repeat(2, 1fr);
        grid-gap: 10px;
        padding: 10px;
      }
      
      .product {
        min-height: 250px;
        padding: 10px;
      }
      
      .image-container {
        height: 120px;
      }
      
      .modal-content {
        max-width: 300px;
      }
    }
    
    /* Very small screens - 1 per line */
    @media (max-width: 400px) {
      .products {
        grid-template-columns: 1fr;
      }
      
      header .logo h1 {
        font-size: 1.5em;
      }
    }
    
    /* Mobile Navigation */
    @media (max-width: 767px) {
      .menu-toggle {
        display: flex;
        position: fixed;
        top: 15px;
        right: 15px;
        z-index: 5001; /* keep above drawer */
      }
      
      header nav {
        position: fixed;
        top: 0;
        right: -100%;
        width: 80%;
        max-width: 300px;
        height: 100vh;
        background-color: white;
        z-index: 100;
        transition: right 0.3s ease;
        box-shadow: -5px 0 15px rgba(0,0,0,0.1);
        padding: 80px 20px 20px;
      }
      
      header nav.active {
        right: 0;
      }
      
      header nav ul {
        flex-direction: column;
      }
      
      header nav ul li {
        margin-right: 0;
        margin-bottom: 15px;
      }
      
      .basket-row .basket-minus-btn {
        opacity: 1 !important;
        pointer-events: auto !important;
      }
      
      .basket-desktop { display: none !important; }
      .basket-mobile { display: block !important; }
      .basket-btn-container #basketDropdown {
        right: 0 !important;
        left: auto !important;
        min-width: 260px !important;
        max-width: 95vw !important;
        width: auto !important;
        border-radius: 15px !important;
        box-shadow: 0 4px 16px rgba(0,0,0,0.15) !important;
        position: absolute !important;
        top: calc(100% + 10px) !important;
      }
      .basket-btn-container-mobile #basketDropdownMobile {
        left: 0 !important;
        right: auto !important;
        min-width: 200px !important;
        max-width: 95vw !important;
        width: 90vw !important;
        border-radius: 15px !important;
        box-shadow: 0 4px 16px rgba(0,0,0,0.15) !important;
        position: absolute !important;
        top: calc(100% + 10px) !important;
      }
    }

    .basket-row:not(:last-child) {
      border-bottom: 1px solid #eee;
    }

    /* Basket Dropdown Styles */
    #basketDropdown {
      opacity: 0;
      transform: translateY(-10px);
      pointer-events: none;
      transition: opacity 0.3s, transform 0.3s;
      display: block;
      max-height: 400px;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch; /* Momentum scrolling on iOS */
      overscroll-behavior: contain;      /* Keep scroll inside the basket */
    }
    
    #basketDropdown.show {
      opacity: 1;
      transform: translateY(0);
      pointer-events: auto;
    }
    
    .basket-fade-out {
      opacity: 0;
      transform: translateX(-20px) scale(0.95);
      background-color: rgba(255, 0, 0, 0.05);
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      pointer-events: none;
    }
    
    .basket-fade-in {
      opacity: 1;
      transform: translateX(0) scale(1);
      background-color: transparent;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .basket-row .basket-minus-btn {
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s;
    }
    
    .basket-row:hover .basket-minus-btn {
      opacity: 1;
      pointer-events: auto;
    }
    
    /* DESKTOP: Hide minus button by default inside the main basket dropdown */
    #basketDropdown .basket-minus-btn {
      opacity: 0; /* Hidden by default */
    }

    /* DESKTOP: Show minus button on hover inside the main basket dropdown */
    #basketDropdown .basket-row:hover .basket-minus-btn {
      opacity: 1; /* Visible on hover */
    }
    
    .basket-desktop { display: block; }
    .basket-mobile { display: none; }
    
    @media (max-width: 767px) {
      .basket-row .basket-minus-btn {
        opacity: 1 !important;
        pointer-events: auto !important;
      }
      
      .basket-desktop { display: none !important; }
      .basket-mobile { display: block !important; }
      
      /* Mobile basket dropdown positioning */
      .basket-mobile {
        position: relative !important;
      }
      
      #basketDropdown {
        position: absolute !important;
        top: 100% !important;
        left: 0 !important;
        right: 0 !important;
        width: 100% !important;
        min-width: auto !important;
        max-width: none !important;
        border-radius: 0 0 15px 15px !important;
        box-shadow: 0 4px 16px rgba(0,0,0,0.15) !important;
        z-index: 2000 !important;
        margin-top: 5px !important;
      }
    }
    
    .basket-mobile-btn:hover span:first-child {
      text-decoration: underline;
      color: black;
    }

    /* Only add border-bottom to basket rows except the last */
    .basket-row:not(:last-child) {
      border-bottom: 1px solid #eee;
    }
    
    /* Clear Basket Button Slide-up Animation */
    #basketDropdownFooter {
      transition: all 0.3s ease;
      transform: translateY(100%);
      opacity: 0;
      overflow: hidden;
      position: relative;
    }
    
    #basketDropdown:hover #basketDropdownFooter {
      transform: translateY(0);
      opacity: 1;
    }
    
    #clearBasketBtn {
      transition: all 0.2s ease;
    }
    
    #clearBasketBtn:hover {
      background: #a00 !important;
      transform: scale(1.05);
    }
    
    #basketDropdownFooterMobile {
      transition: all 0.3s ease;
      transform: translateY(100%);
      opacity: 0;
      overflow: hidden;
      position: relative;
      pointer-events: none; /* Do not capture taps while hidden */
    }
    
    #basketDropdownMobile:hover #basketDropdownFooterMobile {
      transform: translateY(0);
      opacity: 1;
      pointer-events: auto; /* Enable when revealed */
    }
    
    #clearBasketBtnMobile {
      transition: all 0.2s ease;
    }
    
    #clearBasketBtnMobile:hover {
      background: #a00 !important;
      transform: scale(1.05);
    }

    /* Mobile dropdown animation (cap size like belts/leather jackets) */
    #basketDropdownMobile {
      opacity: 0;
      transform: translateY(-10px);
      pointer-events: none;
      transition: opacity 0.3s, transform 0.3s;
      max-height: 250px;                 /* Cap height */
      overflow-y: auto;                  /* Scroll within dropdown */
      -webkit-overflow-scrolling: touch; /* Momentum scrolling on iOS */
      overscroll-behavior: contain;      /* Keep scroll inside the basket */
      max-width: 95vw;                   /* Constrain width */
      margin-left: auto;                 /* Center if narrower */
      margin-right: auto;
    }
    
    #basketDropdownMobile.show {
      opacity: 1;
      transform: translateY(0);
    }

    /* Basket Counter Styles */
    #basketCount:hover {
      transform: scale(1.1);
    }

    @media (max-width: 768px) {
      #basketCount {
        top: 15px;
        right: 15px;
        width: 25px;
        height: 25px;
        font-size: 12px;
      }
    }

    .basket-mobile-btn:hover span:first-child {
      text-decoration: underline;
      color: black;
    }

    #basketDropdownMobile {
      display: none;
      position: absolute;
      top: calc(100% + 10px);
      left: 0;
      width: auto;
      min-width: 200px;
      max-width: 95vw;
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 0 0 15px 15px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.15);
      z-index: 2000;
      padding: 15px 10px 10px 10px;
      opacity: 0;
      transform: translateY(-10px);
      transition: opacity 0.3s, transform 0.3s;
      max-height: 250px;                  /* Cap height */
      overflow-y: auto;                   /* Scroll within dropdown */
      -webkit-overflow-scrolling: touch;  /* Momentum scrolling on iOS */
      overscroll-behavior: contain;       /* Keep scroll inside the basket */
      pointer-events: none;               /* Prevent clicks when hidden */
    }
    
    #basketDropdownMobile.show {
      opacity: 1;
      transform: translateY(0);
      pointer-events: auto; /* Enable interaction when shown */
    }
    
    .basket-mobile-row {
      display: flex;
      align-items: center;
      margin-bottom: 8px;
      padding: 0 0 0 0;
      background: none;
      border-radius: 0;
      box-shadow: none;
      position: relative;
      min-height: 48px;
    }
    .basket-mobile-row:last-child {
      margin-bottom: 0;
    }
    .basket-mobile-row img {
      width: 38px;
      height: 38px;
      object-fit: contain;
      border-radius: 8px;
      margin-right: 8px;
      background: #fafafa;
    }
    .basket-mobile-row .basket-mobile-info {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
      min-width: 0;
    }
    .basket-mobile-row .basket-mobile-title {
      font-family: 'Special Elite', monospace;
      font-size: 1em;
      text-transform: uppercase;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .basket-mobile-row .basket-mobile-price {
      font-size: 1em;
      font-weight: bold;
      font-family: 'Special Elite', monospace;
      margin-right: 8px;
      display: inline-block;
    }
    .basket-mobile-row .basket-mobile-qty {
      font-size: 0.95em;
      color: #555;
      font-family: 'Special Elite', monospace;
      text-transform: uppercase;
      display: inline-block;
    }
    .basket-mobile-row .basket-mobile-size {
      font-size: 0.95em;
      color: #555;
      font-family: 'Special Elite', monospace;
      text-transform: uppercase;
      display: none;
    }
    .basket-minus-btn-mobile {
      background: #000;
      color: #fff;
      border: none;
      border-radius: 50%;
      width: 28px;
      height: 28px;
      font-size: 1.2em;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      position: absolute;
      top: 50%;
      right: 8px;
      transform: translateY(-50%);
      transition: background 0.2s;
    }
    .basket-minus-btn-mobile:hover {
      background: #333;
    }

    /* --- Refined Animated Size Selector Modal Logic --- */
    .size-selector-modal-group {
      position: relative;
      width: 100%;
      margin-top: 0.5rem;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .size-selector-anim {
      transition: transform 0.35s cubic-bezier(0.4,0,0.2,1), box-shadow 0.35s, z-index 0s;
      z-index: 10;
    }
    .size-selector-modal-buttons {
      transition: opacity 0.25s cubic-bezier(0.4,0,0.2,1);
      opacity: 1;
      pointer-events: auto;
    }
    .size-selector-modal-buttons.hide {
      opacity: 0;
      pointer-events: none;
    }
    /* Try-On additions */
    .upload-title { font-family: 'Special Elite', monospace; text-transform: uppercase; letter-spacing: 0.05em; color: #333; }
    .try-on-btn {
      background: linear-gradient(135deg, #a3d5ff 0%, rgba(255, 255, 255, 0.9) 100%);
      color: #fff;
      border: none;
      padding: 1rem 1.5rem;
      margin-top: 1rem;
      cursor: pointer;
      font-size: 1rem;
      border-radius: 30px;
      transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      touch-action: manipulation;
      width: 100%;
      text-align: center;
      position: relative;
      overflow: hidden;
      box-shadow: 0 10px 30px rgba(163, 213, 255, 0.4);
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 2px;
    }
    .try-on-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, 
          transparent, 
          rgba(255, 180, 180, 0.35), 
          rgba(255, 200, 160, 0.35), 
          rgba(255, 255, 200, 0.35), 
          rgba(200, 255, 200, 0.4), 
          rgba(200, 230, 255, 0.4), 
          rgba(230, 200, 255, 0.35), 
          rgba(255, 200, 230, 0.35), 
          rgba(255, 255, 255, 0.5),
          transparent);
      opacity: 1;
      z-index: 1;
      animation: glacier-rainbow-sweep 4s infinite;
    }
    @keyframes glacier-rainbow-sweep {
      0% { left: -100%; opacity: 0.4; }
      50% { left: 100%; opacity: 0.7; }
      100% { left: -100%; opacity: 0.4; }
    }
    .try-on-btn:hover:not(:disabled) {
      transform: translateY(-5px) scale(1.03);
      box-shadow: 0 20px 40px rgba(163, 213, 255, 0.6);
      background: linear-gradient(135deg, #87ceeb 0%, rgba(255, 255, 255, 0.95) 100%);
    }
    /* Camera icon hover tint (parity with leather_jackets) */
    .person-upload-area:hover .upload-icon svg { stroke: #007bff; }
    .try-on-btn:active:not(:disabled) {
      transform: translateY(-2px) scale(0.98);
      box-shadow: 0 10px 25px rgba(163, 213, 255, 0.4);
    }

    /* Upload section parity with leather_jackets */
    .model-upload-section { display: none; text-align: center; }
    .model-upload-section.show { display: block; }
    @media (max-width: 768px) {
      .model-upload-section { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) translateY(100vh); width: 90vw; max-width: 400px; margin: 0; z-index: 1004; transition: transform 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94); box-sizing: border-box; max-height: 90vh; overflow-y: auto; }
      .model-upload-section.show { transform: translate(-50%, -50%) translateY(0); }
      .model-upload-section.scroll-up { animation: scrollUpMobile 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards; }
      @keyframes scrollUpMobile { from { transform: translate(-50%, -50%) translateY(100vh); opacity: 0; } to { transform: translate(-50%, -50%) translateY(0); opacity: 1; } }
      .upload-container { margin: 0 0 20px 0; width: 100%; box-sizing: border-box; }
    }
    @media (min-width: 769px) {
      .model-upload-section { position: fixed; left: 65%; top: 50%; transform: translate(0, -50%); width: 300px; max-width: 35vw; display: none; animation: fadeInRight 0.6s ease-out; z-index: 1004; box-sizing: border-box; max-height: 90vh; overflow-y: auto; }
      .model-upload-section.show { display: block; }
      .upload-container { margin: 0 0 20px 0; width: 100%; box-sizing: border-box; }
      @keyframes fadeInRight { from { opacity: 0; transform: translate(30px, -50%); } to { opacity: 1; transform: translate(0, -50%); } }
    }
    .upload-container {
      background: white;
      border-radius: 15px;
      padding: 20px;
      margin: 20px auto;
      max-width: 500px;
      box-shadow: 0px 4px 10px rgba(0,0,0,0.2);
      transition: all 0.6s ease;
      position: relative;
    }
    .upload-container.has-photo { background: transparent; box-shadow: none; padding: 0; border-radius: 15px; overflow: hidden; width: 300px; height: 400px; }
    @media (max-width: 768px) { .upload-container.has-photo { width: 350px; height: 450px; } }
    .person-upload-area {
      position: relative;
      background: #f8f9fa;
      border: 3px dashed #dee2e6;
      border-radius: 12px;
      padding: 20px;
      cursor: pointer;
      width: 250px; height: 250px;
      display: flex; align-items: center; justify-content: center;
      overflow: hidden; margin: 0 auto;
    }
    /* Remove the dashed border and background once a photo is added */
    .person-upload-area.has-photo {
      border: none;
      background: transparent;
      padding: 0;
      /* Match leather_jackets: make area fill the container */
      width: 100%;
      height: 100%;
      position: absolute;
      top: 0;
      left: 0;
      margin: 0;
      border-radius: 0;
    }
    .person-upload-area.has-photo:hover { border: none; background: transparent; }
    .file-input { display: none; }
    .person-photo-preview { display: none; width: 100%; height: 100%; object-fit: cover; border-radius: 12px; }
    .person-photo-preview.show { display: block; }
    /* Remove photo button (match leather_jackets) */
    .remove-photo-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(0, 0, 0, 0.8);
      color: #fff;
      border: none;
      border-radius: 50%;
      width: 35px;
      height: 35px;
      font-size: 1.4em;
      font-weight: bold;
      cursor: pointer;
      opacity: 0;
      transition: all 0.3s ease;
      z-index: 1006;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.4);
      backdrop-filter: blur(4px);
      pointer-events: auto;
    }
    @media (hover: hover) {
      .upload-container:hover .remove-photo-btn.show { opacity: 1; }
      .remove-photo-btn.show { opacity: 0; }
      .remove-photo-btn:hover { background: rgba(0,0,0,1); transform: scale(1.1); box-shadow: 0 4px 12px rgba(0,0,0,0.6); }
    }
    @media (hover: none) { .remove-photo-btn.show { opacity: 1; } .remove-photo-btn:active { background: rgba(0,0,0,1); transform: scale(0.95); } }
    /* Continue button styles (match leather_jackets) */
    .continue-btn {
      background: linear-gradient(135deg, #a3d5ff 0%, rgba(255, 255, 255, 0.9) 100%);
      color: #fff;
      border: none;
      padding: 15px 30px;
      margin: 20px 0;
      border-radius: 30px;
      font-size: 1.1em;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 2px;
      cursor: pointer;
      transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      width: 100%;
      display: none;
      position: relative;
      overflow: hidden;
      box-shadow: 0 10px 30px rgba(163, 213, 255, 0.4);
      touch-action: manipulation;
      text-align: center;
      opacity: 0;
      transform: translateY(20px);
    }
    .continue-btn.show { display: block; animation: fadeInUp 0.6s ease-out forwards; }
    @keyframes fadeInUp { 0% { opacity: 0; transform: translateY(20px);} 100% { opacity: 1; transform: translateY(0);} }
    .continue-btn::before {
      content: '';
      position: absolute;
      top: 0; left: -100%; width: 100%; height: 100%;
      background: linear-gradient(90deg, 
        transparent, rgba(255,180,180,0.35), rgba(255,200,160,0.35), rgba(255,255,200,0.35), rgba(200,255,200,0.4), rgba(200,230,255,0.4), rgba(230,200,255,0.35), rgba(255,200,230,0.35), rgba(255,255,255,0.5), transparent);
      opacity: 1; z-index: 1; animation: glacier-rainbow-sweep 4s infinite;
    }
    .continue-btn:hover:not(:disabled) { transform: translateY(-5px) scale(1.03); box-shadow: 0 20px 40px rgba(163, 213, 255, 0.6); background: linear-gradient(135deg, #87ceeb 0%, rgba(255, 255, 255, 0.95) 100%); }
    .continue-btn:active:not(:disabled) { transform: translateY(-2px) scale(0.98); box-shadow: 0 10px 25px rgba(163, 213, 255, 0.4); }
    .continue-btn:disabled { background: #f5f5f5; color: #999; border: 1px solid rgba(0,0,0,0.05); box-shadow: none; }
    .continue-btn:disabled::before { display: none; }
    /* Fade-out effect on Activate AI click (parity with leather_jackets) */
    .continue-btn.fadeout {
      opacity: 0 !important;
      transform: translateY(-12px) !important;
      pointer-events: none !important;
      transition: opacity .6s ease, transform .6s ease;
      filter: blur(0.2px);
    }
    .result-in-place { display: none; position: relative; margin-top: 12px; }
    .result-in-place.show { display: block; }
    .result-image-in-place { width: 100%; height: auto; object-fit: contain; border-radius: 12px; }
    .result-back-btn { position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.7); color: #fff; border: 0; border-radius: 50%; width: 35px; height: 35px; cursor: pointer; display: none; }
    .result-back-btn.show { display: block; }
    .processing-overlay-local { position: fixed; left: 0; top: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.3); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); display: none; align-items: center; justify-content: center; z-index: 3000; }
    .processing-overlay-local.show { display: flex; }
    .processing-content-local { color: #fff; text-align: center; padding: 20px; }
    .processing-spinner { width: 40px; height: 40px; border-radius: 50%; margin: 0 auto 15px; position: relative; background: conic-gradient(from 0deg, rgba(255, 180, 180, 0.8), rgba(255, 200, 160, 0.8), rgba(255, 255, 200, 0.9), rgba(200, 255, 200, 0.8), rgba(200, 230, 255, 0.9), rgba(230, 200, 255, 0.8), rgba(255, 200, 230, 0.8), rgba(255, 255, 255, 0.9), rgba(255, 180, 180, 0.8)); animation: spin 1s linear infinite; }
    .processing-spinner::before { content: ''; position: absolute; top: 4px; left: 4px; right: 4px; bottom: 4px; background: rgba(0,0,0,0.3); border-radius: 50%; backdrop-filter: blur(8px); }
    @keyframes spin { 0% { transform: rotate(0); } 100% { transform: rotate(360deg); } }
    .progress-bar { width: 200px; height: 6px; background: rgba(255,255,255,0.25); border-radius: 3px; overflow: hidden; margin: 8px auto 0; box-shadow: inset 0 1px 3px rgba(0,0,0,0.1); }
    .progress-fill { width: 0%; height: 100%; background: linear-gradient(135deg, #a3d5ff 0%, rgba(255,255,255,0.9) 100%); transition: width .25s ease; box-shadow: 0 2px 6px rgba(163,213,255,0.4); }
    /* High-contrast loading text (parity with leather_jackets) */
    #processingPrimary { font-size: 1.1em; font-weight: 600; color: #fff; text-shadow: 0 1px 3px rgba(0,0,0,0.3); }
    #processingSecondary { font-size: 0.9em; color: rgba(255, 255, 255, 0.95); text-shadow: 0 1px 2px rgba(0,0,0,0.25); }

    /* Parity animations with leather_jackets */
    .fade-out-element { transition: opacity .6s ease, transform .6s ease; }
    .fade-out-element.hidden { opacity: 0 !important; transform: translateY(-12px); pointer-events: none; }
    @keyframes swipeUpMobile { 0% { transform: translateY(0); opacity: 1; } 100% { transform: translateY(-100vh); opacity: 0; } }
    .modal-content.try-on-swipe-up { animation: swipeUpMobile 1.0s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards; }
    .modal-content.try-on-container-fadeout { animation: containerFadeOut .8s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards; background: transparent !important; border-color: transparent !important; box-shadow: none !important; }
    @keyframes containerFadeOut { from { opacity: 1; transform: translateX(0); } to { opacity: 0; transform: translateX(-50px); } }
    #floatingProductImage { position: fixed; z-index: 1003; border-radius: 15px; box-shadow: 0 8px 32px rgba(0,0,0,0.15); object-fit: contain; transition: all .8s cubic-bezier(0.25, 0.46, 0.45, 0.94); }

    /* Desktop: Move left and reduce height animation (parity with leather_jackets) */
    @media (min-width: 769px) {
      .modal-content.try-on-move-left {
        animation: moveLeftAndReduceDesktop 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
      }
      /* Ensure image can render outside the shrinking container if needed */
      .modal-content.try-on-move-left,
      .modal-content.try-on-container-fadeout {
        overflow: visible;
      }
      /* Visually hide the white card when in try-on */
      .modal-content.try-on-move-left {
        background: transparent !important;
        border-color: transparent !important;
        box-shadow: none !important;
      }
      /* Hide close button while try-on animations are active */
      .modal-content.try-on-move-left .close-btn,
      .modal-content.try-on-container-fadeout .close-btn { display: none !important; }
      @keyframes moveLeftAndReduceDesktop {
        0% {
          transform: translateX(0);
          height: auto;
          min-height: auto;
        }
        100% {
          transform: translateX(-150px);
          height: 380px;
          min-height: 380px;
          /* overflow kept visible via rule above */
        }
      }
    }

    /* Keep product image visible while container fades (parity with leather_jackets) */
    @media (min-width: 769px) {
      .modal-content.try-on-container-fadeout #modalProductImage {
        position: absolute;
        z-index: 1003;
        opacity: 1 !important;
        transform: none !important;
        animation: productImageFloat 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
        width: 340px;
        height: auto;
        max-width: 340px;
        margin: 0 !important;
        border-radius: 15px;
        box-shadow: 0 8px 24px rgba(0,0,0,0.25);
      }
    }
    @keyframes productImageFloat {
      from { position: relative; z-index: 1; }
      to { position: absolute; z-index: 1002; left: 50%; top: 50%; transform: translate(-50%, -50%); }
    }

    /* Also hide close button on mobile swipe-up */
    .modal-content.try-on-swipe-up .close-btn { display: none !important; }

    /* Iridescent arrows (parity with leather_jackets) */
    .try-on-arrows { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 1001; display: none; pointer-events: none; }
    .try-on-arrows.show { display: block; }
    .arrow-top, .arrow-bottom { position: absolute; opacity: 0; transform: scale(0); animation: arrowCreate 1.2s ease-out forwards; overflow: hidden; }
    @keyframes arrowCreate { 0% { opacity: 0; transform: scale(0) rotate(-10deg); } 50% { opacity: .7; transform: scale(1.1) rotate(2deg); } 100% { opacity: 1; transform: scale(1) rotate(0deg); } }
    .arrow-top { top: -70px; left: -120px; animation-delay: .2s; }
    .arrow-bottom { top: 10px; left: -90px; animation-delay: .5s; }
    @keyframes arrow-rainbow-sweep { 0% { width: 0%; left: 0%; opacity: 0; } 10% { width: 0%; left: 0%; opacity: .8; } 70% { width: 100%; left: 0%; opacity: .8; } 100% { width: 100%; left: 0%; opacity: 0; } }
    .arrow-top::after, .arrow-bottom::after { content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, rgba(255,180,180,.4), rgba(255,200,160,.4), rgba(255,255,200,.5), rgba(200,255,200,.4), rgba(200,230,255,.5), rgba(230,200,255,.4), rgba(255,200,230,.4), rgba(255,255,255,.7)); opacity: 0; z-index: 2; animation: arrow-rainbow-sweep 2s infinite; pointer-events: none; }
    /* Clip the shimmering overlay to the arrow silhouettes (match leather_jackets) */
    .arrow-top::after { -webkit-clip-path: path('M52.5 35 Q40 35 40 50 Q40 65 52.5 65 L269.5 65 L269.5 85 L336 50 L269.5 15 L269.5 35 Z'); clip-path: path('M52.5 35 Q40 35 40 50 Q40 65 52.5 65 L269.5 65 L269.5 85 L336 50 L269.5 15 L269.5 35 Z'); }
    .arrow-bottom::after { -webkit-clip-path: path('M42 28 Q30 28 30 40 Q30 52 42 52 L210 52 L210 68 L268 40 L210 12 L210 28 Z'); clip-path: path('M42 28 Q30 28 30 40 Q30 52 42 52 L210 52 L210 68 L268 40 L210 12 L210 28 Z'); }
    @media (max-width: 768px) { .try-on-arrows { display: none !important; } }

    /* Final Result Screen */
    .final-result-screen { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 3000; justify-content: center; align-items: center; flex-direction: column; opacity: 0; transition: opacity .6s ease; }
    .final-result-screen.show { display: flex; opacity: 1; }
    .final-result-container { display: flex; flex-direction: column; align-items: center; max-width: 90%; max-height: 90%; }
    .final-result-image { max-width: 400px; max-height: 500px; width: auto; height: auto; border-radius: 15px; box-shadow: 0 10px 30px rgba(255,255,255,0.2); margin: 20px 0; }
    .final-image-wrap { position: relative; display: inline-block; }
    .final-result-actions-top { display: flex; gap: 20px; margin-bottom: 20px; }
    .final-result-actions-bottom { margin-top: 20px; }
    @keyframes glacier-rainbow-sweep { 0% { left: -100%; opacity: 0.4; } 50% { left: 0%; opacity: 0.7; } 100% { left: -100%; opacity: 0.4; } }
    .restart-circle-btn, .share-circle-btn, .back-circle-btn { background: linear-gradient(135deg, #a3d5ff 0%, rgba(255, 255, 255, 0.9) 100%); color: #fff; border: none; width: 50px; height: 50px; border-radius: 50%; cursor: pointer; transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); position: relative; overflow: hidden; box-shadow: 0 10px 30px rgba(163, 213, 255, 0.4); display: flex; align-items: center; justify-content: center; margin: 0; }
    .restart-circle-btn::before, .share-circle-btn::before, .back-circle-btn::before { content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255,180,180,0.35), rgba(255,200,160,0.35), rgba(255,255,200,0.35), rgba(200,255,200,0.4), rgba(200,230,255,0.4), rgba(230,200,255,0.35), rgba(255,200,230,0.35), rgba(255,255,255,0.5), transparent); opacity: 1; z-index: 1; animation: glacier-rainbow-sweep 4s infinite; border-radius: 50%; }
    .restart-circle-btn:hover:not(:disabled), .share-circle-btn:hover:not(:disabled), .back-circle-btn:hover:not(:disabled) { transform: translateY(-5px) scale(1.1); box-shadow: 0 20px 40px rgba(163, 213, 255, 0.6); background: linear-gradient(135deg, #87ceeb 0%, rgba(255, 255, 255, 0.95) 100%); }
    .restart-circle-btn:active:not(:disabled), .share-circle-btn:active:not(:disabled), .back-circle-btn:active:not(:disabled) { transform: translateY(-2px) scale(1.05); box-shadow: 0 10px 25px rgba(163, 213, 255, 0.4); }
    .buy-btn { background: linear-gradient(135deg, #a3d5ff 0%, rgba(255, 255, 255, 0.9) 100%); color: #fff; border: none; padding: 1rem 2rem; cursor: pointer; font-size: 1.1rem; border-radius: 30px; transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); position: relative; overflow: hidden; box-shadow: 0 10px 30px rgba(163, 213, 255, 0.4); font-weight: 700; text-transform: uppercase; letter-spacing: 2px; min-width: 200px; }
    .buy-btn::before { content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255,180,180,0.35), rgba(255,200,160,0.35), rgba(255,255,200,0.35), rgba(200,255,200,0.4), rgba(200,230,255,0.4), rgba(230,200,255,0.35), rgba(255,200,230,0.35), rgba(255,255,255,0.5), transparent); opacity: 1; z-index: 1; animation: glacier-rainbow-sweep 4s infinite; }
    .buy-btn:hover:not(:disabled) { transform: translateY(-5px) scale(1.03); box-shadow: 0 20px 40px rgba(163, 213, 255, 0.6); background: linear-gradient(135deg, #87ceeb 0%, rgba(255, 255, 255, 0.95) 100%); }
    .buy-btn:active:not(:disabled) { transform: translateY(-2px) scale(0.98); box-shadow: 0 10px 25px rgba(163, 213, 255, 0.4); }
    /* Watermark exactly like leather_jackets */
    .fitrite-watermark { position: absolute; right: 6px; bottom: 6px; display: flex; flex-direction: column; align-items: flex-end; font-family: Georgia, "Times New Roman", Times, serif; color: #fff; letter-spacing: 0.05em; text-shadow: none; z-index: 1005; pointer-events: none; text-transform: uppercase; font-size: clamp(11px, 1.3vw, 18px); font-weight: 300; text-align: center; }
    .fitrite-watermark .fit-line { display: block; width: 80px; height: 2px; background: #fff; margin: 0 0 3px 0; border-radius: 1px; align-self: center; }
    .ai-preview-disclaimer { position: fixed; left: 50%; bottom: 20px; transform: translateX(-50%) translateY(10px); background: #28a745; color: #fff; padding: 10px 16px; border-radius: 12px; box-shadow: 0 6px 18px rgba(0,0,0,0.25); opacity: 0; pointer-events: none; transition: opacity 0.4s ease, transform 0.4s ease; z-index: 5000; font-size: 0.95em; text-align: center; }
    .ai-preview-disclaimer.show { opacity: 1; transform: translateX(-50%) translateY(0); }
  </style>
</head>
<body>
  <!-- Header Section -->
  <header>
    <div class="logo">
      <h1>FITRITE</h1>
      <p>Footwear</p>
    </div>
    <!-- Mobile Menu Toggle -->
    <div class="menu-toggle" id="menuToggle">
      <span></span>
      <span></span>
      <span></span>
    </div>
    <nav id="mobileNav">
      <ul>
        <li><a href="index.html">HOME</a></li>
        <li><a href="page2.html">FITTING ROOM</a></li>
        <li><a href="page3.html">CHECKOUT</a></li>
        <li class="basket-desktop">
          <button id="basketDropdownBtn" style="background:none;border:none;cursor:pointer;position:relative;">
            🛒
            <span id="basketCount" style="font-size:0.8em;background:#000;color:#fff;border-radius:50%;padding:2px 6px;position:absolute;top:-8px;right:-10px;display:none;width:20px;height:20px;display:flex;align-items:center;justify-content:center;">0</span>
          </button>
              <div id="basketDropdown" style="display:none;position:absolute;right:0;top:40px;min-width:300px;max-width:350px;background:#fff;border:1px solid #ddd;border-radius:15px;box-shadow:0 4px 16px rgba(0,0,0,0.15);z-index:2000;padding:15px 10px 10px 10px;">
        <div id="basketDropdownContent" style="padding-top:20px;">Your basket is empty.</div>
        <div id="basketDropdownFooter" style="margin-top:15px;padding-top:15px;border-top:1px solid #eee;text-align:center;display:none;">
            <button id="clearBasketBtn" style="background:#c00;color:#fff;border:none;padding:8px 16px;border-radius:4px;cursor:pointer;font-family:'Special Elite',monospace;font-size:0.9em;text-transform:uppercase;">Clear Basket</button>
        </div>
    </div>
        </li>
        <li class="basket-mobile" style="display:none;width:100%;">
          <button id="basketDropdownBtnMobile" class="basket-mobile-btn" style="background:none;border:none;cursor:pointer;width:100%;padding:5px 10px;text-align:left;display:block;">
            <span style="font-family:'Special Elite',monospace;font-size:1.2em;letter-spacing:0.04em;vertical-align:middle;">BASKET</span>
            <span id="basketCountMobile" style="font-size:1em;background:#000;color:#fff;border-radius:50%;padding:2px 8px;margin-left:10px;vertical-align:middle;width:24px;height:24px;display:flex;align-items:center;justify-content:center;">0</span>
          </button>
          <div id="basketDropdownMobile" style="display:none;position:absolute;top:100%;left:0;right:0;width:100%;background:#fff;border:1px solid #ddd;border-radius:0 0 15px 15px;box-shadow:0 4px 16px rgba(0,0,0,0.15);z-index:2000;padding:15px 10px 10px 10px;">
            <div id="basketDropdownContentMobile" style="padding-top:20px;">Your basket is empty.</div>
            <div id="basketDropdownFooterMobile" style="margin-top:15px;padding-top:15px;border-top:1px solid #eee;text-align:center;display:none;">
                <button id="clearBasketBtnMobile" style="background:#c00;color:#fff;border:none;padding:8px 16px;border-radius:4px;cursor:pointer;font-family:'Special Elite',monospace;font-size:0.9em;text-transform:uppercase;">Clear Basket</button>
            </div>
          </div>
        </li>
      </ul>
    </nav>
  </header>

  <!-- Search Bar -->
  <section id="search-bar">
    <input type="text" id="searchInput" placeholder="Search footwear by name or price..." onkeyup="filterProducts()" />
  </section>

  <!-- Products Section -->
  <section id="footwear">
    <h2>AVAILABLE FOOTWEAR</h2>
    <div class="products" id="products-container">
      <!-- Products will be populated by JavaScript -->
    </div>
  </section>

  <!-- Footer Section -->
  <footer>
    <p>&copy; 2024 Fitrite. All rights reserved.</p>
  </footer>

  <!-- Modal (Pop-up) -->
  <div id="productModal" class="modal">
    <div class="modal-content">
      <span class="close-btn" id="closeModal">&times;</span>
      <img id="modalProductImage" src="" alt="Product Image">
      <h3 id="modalProductName" class="fade-out-element"></h3>
      <p id="modalProductPrice" class="fade-out-element"></p>
      <p style="margin: 1rem 0;" class="fade-out-element">Would you like to proceed with this product?</p>
      <div class="size-selector-modal-group">
        <div class="size-selector-modal-buttons fade-out-element" id="modalButtonsGroup">
          <button id="addToBasket" class="proceed-btn fade-out-element">Add to Basket</button>
          <button id="proceedToPayment" class="proceed-btn fade-out-element">Go to Payment Page</button>
        </div>
        <select id="sizeSelector" class="size-selector size-selector-anim fade-out-element">
          <option value="EU 38 / US M 5.5-6 / UK 5">EU 38 / US M 5.5-6 / UK 5</option>
          <option value="EU 39 / US M 6.5 / UK 6">EU 39 / US M 6.5 / UK 6</option>
          <option value="EU 40 / US M 7.5 / UK 7" selected>EU 40 / US M 7.5 / UK 7</option>
          <option value="EU 41 / US M 8.5 / UK 8">EU 41 / US M 8.5 / UK 8</option>
          <option value="EU 42 / US M 9 / UK 8.5">EU 42 / US M 9 / UK 8.5</option>
          <option value="EU 43 / US M 10 / UK 9.5">EU 43 / US M 10 / UK 9.5</option>
          <option value="EU 44 / US M 10.5 / UK 10">EU 44 / US M 10.5 / UK 10</option>
          <option value="EU 45 / US M 11.5 / UK 11">EU 45 / US M 11.5 / UK 11</option>
        </select>
        <button id="tryOnBtn" class="try-on-btn fade-out-element">Try On</button>
      </div>
    </div>
  </div>

  <!-- Toast Notification -->
  <div id="toast">Product added to basket!</div>

  <!-- Try-On UI -->
  <div id="modelUploadSection" class="model-upload-section">
    <div class="upload-container">
      <h2 class="upload-title">CLICK HERE TO ADD YOUR PHOTO</h2>
      <div class="person-upload-area" id="personUploadArea">
        <div class="person-upload-inner" id="personUploadInner">
          <div class="upload-prompt" id="uploadPrompt">
            <div class="upload-icon">
              <svg width="80" height="80" viewBox="0 0 120 120" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <!-- Flash unit (big flash on top) -->
                <rect x="35" y="5" width="50" height="25" rx="8" ry="8" fill="none"/>
                <rect x="40" y="10" width="40" height="15" rx="4" ry="4" fill="none"/>
                <!-- Flash reflector -->
                <ellipse cx="60" cy="17.5" rx="15" ry="8" fill="none" opacity="0.3"/>
                <!-- Flash connection -->
                <rect x="55" y="30" width="10" height="8" rx="2" ry="2"/>
                
                <!-- Camera body main -->
                <rect x="20" y="38" width="80" height="55" rx="6" ry="6"/>
                <!-- Camera top plate -->
                <rect x="25" y="33" width="70" height="10" rx="3" ry="3"/>
                
                <!-- Viewfinder prism -->
                <rect x="45" y="28" width="30" height="8" rx="2" ry="2"/>
                <rect x="50" y="25" width="20" height="6" rx="2" ry="2"/>
                
                <!-- Main lens mount -->
                <circle cx="60" cy="65" r="22"/>
                <!-- Lens outer ring -->
                <circle cx="60" cy="65" r="18"/>
                <!-- Lens middle ring -->
                <circle cx="60" cy="65" r="14"/>
                <!-- Lens inner -->
                <circle cx="60" cy="65" r="10"/>
                <!-- Lens center -->
                <circle cx="60" cy="65" r="6"/>
                <!-- Lens reflection -->
                <circle cx="57" cy="62" r="3" fill="currentColor" opacity="0.2"/>
                
                <!-- Camera controls -->
                <circle cx="85" cy="45" r="3"/>
                <circle cx="85" cy="55" r="2"/>
                <rect x="82" y="65" width="6" height="4" rx="1"/>
              </svg>
            </div>
            
          </div>
        </div>
        <button class="remove-photo-btn" id="removePhotoBtn">×</button>
        <input type="file" id="personFileInput" accept="image/*" class="file-input" />
        <img id="personPhotoPreview" class="person-photo-preview" alt="Person Preview">
      </div>
      <div class="result-in-place" id="resultInPlace">
        <img id="resultImageInPlace" class="result-image-in-place" alt="Virtual Try-On Result">
    <div class="fitrite-watermark"><div class="fit-line"></div>FITRITE</div>
        <button class="result-back-btn" id="resultBackBtn" title="Remove item">←</button>
      </div>
    </div>
    <button type="button" id="continueBtn" class="continue-btn" style="display:none" disabled>Activate AI</button>
  </div>

  <div id="processingOverlayLocal" class="processing-overlay-local">
    <div class="processing-content-local">
      <div class="processing-spinner"></div>
      <div id="processingPrimary" style="margin-top:12px;">Connecting to AI servers</div>
      <div id="processingSecondary" style="opacity:.85;">Starting AI processing...</div>
      <div class="progress-bar" style="margin-top:10px;"><div class="progress-fill" id="progressFill"></div></div>
    </div>
  </div>

  <!-- Try On Arrows -->
  <div id="tryOnArrows" class="try-on-arrows">
    <div class="arrow-top">
      <svg width="350" height="100" viewBox="0 0 350 100" fill="none">
        <defs>
          <linearGradient id="arrow-gradient" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" style="stop-color:#a3d5ff;stop-opacity:1" />
            <stop offset="100%" style="stop-color:rgba(255, 255, 255, 0.9);stop-opacity:1" />
          </linearGradient>
          <clipPath id="arrow-clip-top">
            <path d="M52.5 35 Q40 35 40 50 Q40 65 52.5 65 L269.5 65 L269.5 85 L336 50 L269.5 15 L269.5 35 Z"/>
          </clipPath>
        </defs>
        <path d="M30 35 Q15 35 15 50 Q15 65 30 65 L270 65 L270 85 L335 50 L270 15 L270 35 Z" fill="url(#arrow-gradient)" stroke="url(#arrow-gradient)" stroke-width="4" clip-path="url(#arrow-clip-top)"/>
      </svg>
    </div>
    <div class="arrow-bottom">
      <svg width="280" height="80" viewBox="0 0 280 80" fill="none">
        <defs>
          <linearGradient id="arrow-gradient-2" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" style="stop-color:#a3d5ff;stop-opacity:1" />
            <stop offset="100%" style="stop-color:rgba(255, 255, 255, 0.9);stop-opacity:1" />
          </linearGradient>
          <clipPath id="arrow-clip-bottom">
            <path d="M42 28 Q30 28 30 40 Q30 52 42 52 L210 52 L210 68 L268 40 L210 12 L210 28 Z"/>
          </clipPath>
        </defs>
        <path d="M24 28 Q12 28 12 40 Q12 52 24 52 L210 52 L210 68 L268 40 L210 12 L210 28 Z" fill="url(#arrow-gradient-2)" stroke="url(#arrow-gradient-2)" stroke-width="3.5" clip-path="url(#arrow-clip-bottom)"/>
      </svg>
    </div>
  </div>

  <div id="finalResultScreen" class="final-result-screen">
    <div class="final-result-container">
      <div class="final-result-actions-top">
        <button class="back-circle-btn" id="finalBackBtn">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="m12 19-7-7 7-7"></path><path d="m19 12H5"></path></svg>
        </button>
        <button class="share-circle-btn" id="finalShareBtn">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
        </button>
        <button class="restart-circle-btn" id="finalTryAgainBtn">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"></polyline><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path></svg>
        </button>
      </div>
      <div class="final-image-wrap" style="position:relative;display:inline-block;">
      <img id="finalResultImage" class="final-result-image" alt="Final Try-On Result">
        <div class="fitrite-watermark"><div class="fit-line"></div>FITRITE</div>
      </div>
      <div class="final-result-actions-bottom">
        <button class="buy-btn" id="finalBuyBtn">BUY</button>
      </div>
    </div>
    
  </div>

  <div id="aiPreviewDisclaimer" class="ai-preview-disclaimer" style="display:none;">Preview is for style visualization. Fit may not correspond to selected size.</div>

  <script>
    // Try On Button Functionality (mirrors leather_jackets flow exactly)
    (function(){
      const tryBtn = document.getElementById('tryOnBtn');
      if (!tryBtn) return;
      tryBtn.addEventListener('click', async function() {
        window.tryOnActive = true;
        // Scoped resume per product on Try On click
        try {
          const key = getCurrentProductKey();
          const job = key && loadJob(key);
          if (job && job.status === 'inflight') {
            if (job.predictionId) {
              try { hasActivatedAI = true; isProcessing = true; } catch(_) {}
              try { tryOnSceneryVisible = true; } catch(_) {}
              try { restoreTryOnSceneForResume(); } catch(_) {}
              try { showModelUpload(); } catch(_) {}
              try { applyTryOnLayout(); } catch(_) {}
              try { ensureTryOnConsistency(); } catch(_) {}
              try { ensureFloatingProductVisible(); } catch(_) {}
              try { allowProcessingOverlay = true; } catch(_) {}
              try { showProcessingFullScreen(); } catch(_) {}
              try {
                const a = document.getElementById('tryOnArrows');
                if (window.tryOnActive && a && window.innerWidth > 768) {
                  a.classList.add('show');
                  positionArrowsBetween();
                }
              } catch(_) {}
              try { allowProcessingOverlay = true; } catch(_) {}
              try { showProcessingFullScreen(); } catch(_) {}
              return resumePrediction(job);
            } else {
              clearJob(key);
            }
          }
          if (job && job.status === 'done') {
            // If a previous job finished, clear it and restart fresh like first-time
            try { const k = getCurrentProductKey(); if (k) clearJob(k); } catch(_) {}
            try { localStorage.removeItem(RESULT_STORAGE_KEY); } catch(_) {}
            try { hasActivatedAI = false; isProcessing = false; hasProcessingCompleted = false; } catch(_) {}
            // Fall through to normal fresh-start flow below
          }
        } catch (_) {}
        // First: Fade out all elements
        try { resetTryOnUI(); } catch(_) {}
        const fadeOutElements = document.querySelectorAll('.fade-out-element');
        fadeOutElements.forEach(element => { element.classList.add('hidden'); });

        // After fade out delay, start container animations
        setTimeout(() => {
          const modalContent = document.querySelector('.modal-content');
          const productImage = document.getElementById('modalProductImage');

          if (window.innerWidth <= 768) {
            // Mobile: Swipe up animation
            modalContent.classList.add('try-on-swipe-up');
          } else {
            // Desktop: Extract image first, then fade out container
            if (productImage) {
              const imageRect = productImage.getBoundingClientRect();
              const modalRect = document.getElementById('productModal').getBoundingClientRect();
              try {
                const existingFloating = document.getElementById('floatingProductImage');
                if (existingFloating) existingFloating.remove();
              } catch(_) {}
              const imageClone = productImage.cloneNode(true);
              imageClone.id = 'floatingProductImage';
              imageClone.style.position = 'fixed';
              imageClone.style.left = imageRect.left + 'px';
              imageClone.style.top = imageRect.top + 'px';
              imageClone.style.width = imageRect.width + 'px';
              imageClone.style.height = imageRect.height + 'px';
              imageClone.style.zIndex = '1003';
              imageClone.style.transition = 'all 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
              imageClone.style.borderRadius = '15px';
              imageClone.style.boxShadow = '0 8px 32px rgba(0, 0, 0, 0.15)';
              imageClone.style.objectFit = 'contain';
              document.body.appendChild(imageClone);
              productImage.style.opacity = '0';
              productImage.style.visibility = 'hidden';
              setTimeout(() => {
                let leftX = modalRect.left + modalRect.width * 0.25;
                const centerY = modalRect.top + modalRect.height / 2;
                // Product-specific layout tweaks
                let targetWidth = 300;
                try {
                  const productName = (document.getElementById('modalProductName')?.textContent || '').trim();
                  if (/^(Midnight Marcher|Rose Rebel)$/i.test(productName)) {
                    targetWidth = 340; // subtle bump for these SKUs
                    leftX -= 20;       // nudge a bit further left
                    try {
                      const upload = document.getElementById('modelUploadSection');
                      if (upload && window.innerWidth > 768) {
                        upload.style.left = '68%'; // push upload container slightly right
                      }
                    } catch(_) {}
                  } else {
                    try {
                      const upload = document.getElementById('modelUploadSection');
                      if (upload && window.innerWidth > 768) {
                        upload.style.left = '65%'; // default position
                      }
                    } catch(_) {}
                  }
                } catch(_) {}

                imageClone.style.left = leftX + 'px';
                imageClone.style.top = centerY + 'px';
                imageClone.style.width = targetWidth + 'px';
                imageClone.style.height = 'auto';
                imageClone.style.transform = 'translate(0, -50%)';
                try {
                  const a = document.getElementById('tryOnArrows');
                  if (window.tryOnActive && a && window.innerWidth > 768) {
                    a.classList.add('show');
                    positionArrowsBetween();
                  }
                } catch(_) {}
              }, 100);
            }
            // First shrink/move the white container, then fade it out
            modalContent.classList.remove('try-on-container-fadeout');
            modalContent.classList.add('try-on-move-left');
            setTimeout(() => {
            modalContent.classList.add('try-on-container-fadeout');
            }, 200);
          }

      // Show model upload section after container animation
          setTimeout(() => {
            showModelUpload();
            try { applyTryOnLayout(); } catch(_) {}
            try { ensureTryOnConsistency(); } catch(_) {}
            // Ensure arrows visible on desktop try-on scene
            try { const a = document.getElementById('tryOnArrows'); if (a && window.innerWidth > 768) a.classList.add('show'); } catch(_) {}
            try { fetch('https://api.fashn.ai/v1/', { mode: 'no-cors', keepalive: true }); } catch (e) {}
            try { positionArrowsBetween(); } catch(_) {}
            // Ensure the Execute AI button stays hidden on entry until a real upload
            try { ensureExecuteAIButtonVisible(); } catch(_) {}
          }, 600);
        }, 700);
      });
    })();

    // Upload area → open file picker; file change → preview + fade (mirror leather_jackets)
    (function(){
      const uploadArea = document.getElementById('personUploadArea');
      const fileInput = document.getElementById('personFileInput');
      const uploadPrompt = document.getElementById('uploadPrompt');
      const uploadTitle = document.querySelector('.upload-title');
      const personUploadInner = document.getElementById('personUploadInner');
      const uploadContainer = document.querySelector('.upload-container');
      const personPhotoPreview = document.getElementById('personPhotoPreview');
      const removeBtn = document.getElementById('removePhotoBtn');

      if (uploadArea && fileInput) {
        uploadArea.addEventListener('click', () => {
          if (!window.personFile) fileInput.click();
        });
        fileInput.addEventListener('change', (e) => {
          const file = e.target && e.target.files && e.target.files[0];
          if (!file) return;
          handlePersonFileSelect(file);
          // Fallback gating similar to leather_jackets
          setTimeout(() => {
            try { if (!isProcessing) ensureExecuteAIButtonVisible(); } catch (_) {}
          }, 1500);
        });
      }
      // Robust delegated fallback so upload area always opens picker after redo/return
      try {
        document.addEventListener('click', function(evt){
          const area = evt.target && evt.target.closest && evt.target.closest('#personUploadArea');
          if (!area) return;
          // Prevent other overlays from stealing the click
          evt.stopPropagation();
          try {
            if (!window.personFile) {
              const fi = document.getElementById('personFileInput');
              if (fi) fi.click();
            }
          } catch(_) {}
        }, true);
      } catch(_) {}
      // Remove photo button: use shared remover
      if (removeBtn) {
        removeBtn.addEventListener('click', () => {
          removePersonPhoto();
        });
      }
      // Delegated fallback to ensure X always removes photo
      try {
        document.addEventListener('click', function(e){
          const btn = e.target && e.target.closest && e.target.closest('#removePhotoBtn');
          if (!btn) return;
          e.preventDefault();
          e.stopPropagation();
          try { removePersonPhoto(); } catch(_) {}
        }, true);
      } catch(_) {}
    })();
      // Continue button mirrors leather_jackets: start try-on
      try {
        document.addEventListener('click', function(e){
          const btn = e.target.closest('#continueBtn');
          if (!btn) return;
          e.preventDefault();
          e.stopPropagation();
          // guard: if already processing, ignore
          if (window.isProcessing) return;
          // fadeout then disable
          try { btn.classList.add('fadeout'); } catch(_) {}
          try { btn.disabled = true; btn.style.pointerEvents = 'none'; } catch(_) {}
          // Use Product-to-Model starter for footwear
          startFootwearProductToModel();
        });
      } catch(_) {}
    // Filter Products
    function filterProducts() {
      const searchInput = document.getElementById("searchInput").value.toLowerCase();
      const productElements = document.querySelectorAll(".product");
      productElements.forEach((productEl) => {
        const nameText = productEl.querySelector("p:nth-of-type(1)") ? productEl.querySelector("p:nth-of-type(1)").textContent.toLowerCase() : "";
        const priceText = productEl.querySelector("p:nth-of-type(2)") ? productEl.querySelector("p:nth-of-type(2)").textContent.toLowerCase() : "";
        
        productEl.style.display = (nameText.includes(searchInput) || priceText.includes(searchInput)) ? "flex" : "none";
      });
    }
    
    /*************************************************************
     * Mobile Menu Toggle
     *************************************************************/
    (function(){
      const menuToggle = document.getElementById('menuToggle');
      const mobileNav = document.getElementById('mobileNav');
      if (menuToggle && mobileNav) {
        menuToggle.addEventListener('click', function(e){
          e.stopPropagation();
          mobileNav.classList.toggle('active');
          menuToggle.classList.toggle('active');
        });
        // Fallback via event delegation in case another script interferes
        document.addEventListener('click', function(e){
          const btn = e.target.closest('#menuToggle');
          if (!btn) return;
          e.stopPropagation();
          mobileNav.classList.toggle('active');
          btn.classList.toggle('active');
        }, true);
        document.addEventListener('click', function(e){
          if (!e.target.closest('#mobileNav') && !e.target.closest('#menuToggle')) {
            if (mobileNav.classList.contains('active')) {
              mobileNav.classList.remove('active');
              menuToggle.classList.remove('active');
            }
          }
        });
      }
    })();
    
    /*************************************************************
     * Modal Logic
     *************************************************************/
    const modal = document.getElementById("productModal");
    const closeModalBtn = document.getElementById("closeModal");
    const modalProductImage = document.getElementById("modalProductImage");
    const modalProductName = document.getElementById("modalProductName");
    const modalProductPrice = document.getElementById("modalProductPrice");
    const proceedBtn = document.getElementById("proceedToPayment");
    const sizeSelector = document.getElementById("sizeSelector"); // Added size selector
    
    function openModal(name, price, imgUrl, isDiscounted = false, originalPrice = null) {
      modalProductName.textContent = name;
      
      if (isDiscounted && originalPrice) {
        modalProductPrice.innerHTML = `<span class="original-price">${originalPrice}</span> <span class="new-price">${price}</span>`;
      } else {
        modalProductPrice.textContent = price;
      }
      
      modalProductImage.src = imgUrl;
      modalProductImage.alt = name;
      // Track current product for BUY parity with leather_jackets
      try { currentProductData = { name, price, imgUrl, isDiscounted, originalPrice }; } catch(_) {}
      modal.classList.add("show");
      modal.style.display = "flex";
      // (Reverted) No special spinner resume on open
    }
    
    function closeModal() {
      try { window.tryOnActive = false; } catch(_) {}
      modal.classList.remove("show");
      // Hide arrows
      try { const a = document.getElementById('tryOnArrows'); if (a) a.classList.remove('show'); } catch(_) {}
      // Reset any product-specific layout overrides
      try {
        const upload = document.getElementById('modelUploadSection');
        if (upload && window.innerWidth > 768) { upload.style.left = '65%'; }
      } catch(_) {}
      // Fade out model upload
      try {
        const modelUploadSection = document.getElementById('modelUploadSection');
        if (modelUploadSection) {
          modelUploadSection.classList.remove('show','scroll-up');
          modelUploadSection.style.transition = 'opacity 0.6s ease-out';
          modelUploadSection.style.opacity = '0';
          setTimeout(()=>{ modelUploadSection.style.display = 'none'; }, 600);
        }
      } catch(_) {}
      // Hide final result screen
      try {
        const finalResultScreen = document.getElementById('finalResultScreen');
        if (finalResultScreen && finalResultScreen.classList.contains('show')) {
          finalResultScreen.classList.remove('show');
          setTimeout(()=>{ finalResultScreen.style.display = 'none'; }, 1000);
        }
      } catch(_) {}
      // Clear inline result and external actions (parity with leather_jackets)
      try {
        const resultInPlace = document.getElementById('resultInPlace');
        const resultImgInPlace = document.getElementById('resultImageInPlace');
        const resultBackBtn = document.getElementById('resultBackBtn');
        const resultActionsExternal = document.getElementById('resultActionsExternal');
        const personPhotoPreview = document.getElementById('personPhotoPreview');
        if (resultInPlace) { resultInPlace.classList.remove('show'); resultInPlace.style.display = 'none'; }
        if (resultImgInPlace) resultImgInPlace.src = '';
        if (resultBackBtn) { resultBackBtn.classList.remove('show'); resultBackBtn.style.display = 'none'; }
        if (resultActionsExternal) { resultActionsExternal.classList.remove('show'); resultActionsExternal.style.display = 'none'; }
        if (personPhotoPreview) personPhotoPreview.classList.remove('fade-out','processing','processing-complete');
      } catch(_) {}
      // Fade floating product image
      try {
        const floating = document.getElementById('floatingProductImage');
        if (floating) { floating.style.transition = 'opacity 1s ease-out'; floating.style.opacity = '0'; setTimeout(()=>{ try{ floating.remove(); } catch(_){} }, 1000); }
      } catch(_) {}
      // Reset modal content animations and inline styles
      try {
        const modalContent = document.querySelector('.modal-content');
        if (modalContent) {
          modalContent.classList.remove('try-on-swipe-up','try-on-container-fadeout','try-on-move-left','modal-content-hidden');
          modalContent.style.opacity = '';
          modalContent.style.pointerEvents = '';
        }
      } catch(_) {}
      // Reset faded elements
      try {
        const fadeOutEls = document.querySelectorAll('.fade-out-element');
        fadeOutEls.forEach(el => el.classList.remove('hidden'));
        const originalImage = document.getElementById('modalProductImage');
        if (originalImage) { originalImage.style.opacity = '1'; originalImage.style.visibility = ''; }
      } catch(_) {}
      // Always hide processing overlay on close, even mid-load
      try {
        const ov = document.getElementById('processingOverlayLocal');
        if (ov) { ov.classList.remove('show'); ov.style.opacity=''; ov.style.pointerEvents=''; ov.style.display='none'; }
        try { if (typeof allowProcessingOverlay !== 'undefined') allowProcessingOverlay = false; } catch(_) {}
        try {
          if (typeof overlayOriginalParent !== 'undefined') {
            const node = document.getElementById('processingOverlayLocal');
            if (node && overlayOriginalParent && node.parentElement === document.body) {
              overlayOriginalParent.appendChild(node);
            }
          }
        } catch(_) {}
        // Persist a UI snapshot when closing mid-load so re-open can restore visuals
        try {
          const key = (typeof getCurrentProductKey === 'function') ? getCurrentProductKey() : '';
          const p1 = document.getElementById('processingPrimary') || document.getElementById('processingTextLocal');
          const p2 = document.getElementById('processingSecondary') || document.getElementById('processingSubtextLocal');
          const pf = document.getElementById('progressFill') || document.getElementById('progressFillLocal');
          if (key && (typeof window.isProcessing !== 'undefined') && window.isProcessing) {
            const width = (pf && pf.style && pf.style.width) ? parseFloat(pf.style.width) : NaN;
            const progress = Number.isFinite(width) ? Math.max(0, Math.min(100, width)) : 30;
            const snap = { text: (p1 && p1.textContent) || 'Processing...', subtext: (p2 && p2.textContent) || '', progress };
            saveUISnap(key, snap);
          }
        } catch(_) {}
      } catch(_) {}
      setTimeout(() => {
        modal.style.display = "none";
      }, 400);
    }
    
    closeModalBtn.onclick = () => closeModal();
    
    modal.addEventListener("click", (event) => {
      // Ignore clicks occurring on try-on overlays/buttons while active
      const clickedInTryOnOverlay = event.target.closest('#modelUploadSection') || event.target.closest('#resultActionsExternal') || event.target.closest('#continueBtn');
      const clickedInsideModalContent = event.target.closest('.modal-content');
      if (!clickedInsideModalContent && !clickedInTryOnOverlay) {
        closeModal();
        try { const a = document.getElementById('tryOnArrows'); if (a) a.classList.remove('show'); } catch(_) {}
        // Ensure container spinner is closed when user closes mid-load
        try { hideProcessing(); } catch(_) {}
        try { if (typeof allowProcessingOverlay !== 'undefined') allowProcessingOverlay = false; } catch(_) {}
      }
    });
    
    // Basket Handling
    const basketDropdownBtn = document.getElementById('basketDropdownBtn');
    const basketDropdownBtnMobile = document.getElementById('basketDropdownBtnMobile');
    const basketDropdown = document.getElementById('basketDropdown');
    const basketDropdownMobile = document.getElementById('basketDropdownMobile');
    const basketDropdownContent = document.getElementById('basketDropdownContent');
    const basketDropdownContentMobile = document.getElementById('basketDropdownContentMobile');
    const basketCount = document.getElementById('basketCount');
    const basketCountMobile = document.getElementById('basketCountMobile');

    // Firebase cart rendering
    function renderCart() {
      if (!window.FitRightFirebase) return;
      
      const cartItems = window.FitRightFirebase.getCartItems();
      const cartCount = window.FitRightFirebase.getCartCount();
      
      // Update counters
      basketCount.textContent = cartCount;
      basketCount.style.display = cartCount > 0 ? 'inline-block' : 'none';
      if (basketCountMobile) {
        basketCountMobile.textContent = cartCount;
        basketCountMobile.style.display = cartCount > 0 ? 'inline-block' : 'none';
      }
      
      // Update dropdown content
      if (cartItems.length === 0) {
        basketDropdownContent.innerHTML = '<div style="text-align:center;color:#888;">Your basket is empty.</div>';
        if (basketDropdownContentMobile) {
          basketDropdownContentMobile.innerHTML = '<div style="text-align:center;color:#888;">Your basket is empty.</div>';
        }
        return;
      }
      
      const basketHTML = cartItems.map((item, idx) => `
        <div class="basket-row" data-index="${idx}" data-id="${item.id || item.productId || idx}" style="display:flex;align-items:center;margin-bottom:12px;padding-bottom:8px;position:relative;">
          <div style="width:48px;height:48px;background:#fafafa;border-radius:10px;margin-right:12px;display:flex;align-items:center;justify-content:center;">
            <img src="${item.productImage || item.image || item.imgUrl}" alt="${item.productName || item.name}" style="width:100%;height:100%;object-fit:contain;border-radius:10px;" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
            <div style="display:none;width:100%;height:100%;align-items:center;justify-content:center;color:#999;font-size:12px;text-align:center;line-height:1.2;">📦</div>
          </div>
          <div style="flex:1;">
            <div style="font-family:'Special Elite',monospace;font-size:1em;">${item.productName || item.name}</div>
            <div style="font-size:1em;font-weight:bold;">${window.FitRightFirebase && window.FitRightFirebase.formatPrice && (item.productPrice != null || item.price != null) ? window.FitRightFirebase.formatPrice((item.productPrice ?? item.price)) : (item.newPrice || '£0.00')}</div>
            <div style="font-size:0.95em;color:#555;">Qty: <span class="basket-qty" data-id="${item.id || item.productId || idx}">${item.quantity || 1}</span></div>
            ${(() => { const s = ((item.selectedSize || item.size) || '').toString(); return s && s.toLowerCase() !== 'standard' ? `<div style=\"font-size:0.95em;color:#555;\">Size: ${s}</div>` : '' })()}
          </div>
          <button class="basket-minus-btn" data-index="${idx}" data-id="${item.id || item.productId || idx}" style="background:#000;color:#fff;border:none;border-radius:50%;width:22px;height:22px;font-size:1em;display:flex;align-items:center;justify-content:center;cursor:pointer;position:absolute;top:8px;right:8px;">&minus;</button>
        </div>
      `).join('');
      
      basketDropdownContent.innerHTML = basketHTML;
      if (basketDropdownContentMobile) {
        basketDropdownContentMobile.innerHTML = basketHTML;
      }
      
      // Add event listeners for basket minus buttons
      basketDropdownContent.querySelectorAll('.basket-minus-btn').forEach(btn => {
        btn.addEventListener('click', async function(e) {
          e.stopPropagation();
          const itemId = this.getAttribute('data-id');
          const currentQty = parseInt(this.parentElement.querySelector('.basket-qty').textContent);
          
          if (window.FitRightFirebase) {
            if (currentQty > 1) {
              await window.FitRightFirebase.updateQuantity(itemId, currentQty - 1);
            } else {
              await window.FitRightFirebase.removeFromCart(itemId);
            }
          } else {
            // Fallback to localStorage
            let basket = JSON.parse(localStorage.getItem("basket")) || [];
            const index = parseInt(this.getAttribute('data-index'));
            if (currentQty > 1) {
              basket[index].quantity = currentQty - 1;
            } else {
              basket.splice(index, 1);
            }
            localStorage.setItem("basket", JSON.stringify(basket));
            updateBasketDropdown();
          }
        });
      });
      
      // Add event listeners for mobile basket minus buttons
      if (basketDropdownContentMobile) {
        basketDropdownContentMobile.querySelectorAll('.basket-minus-btn').forEach(btn => {
          btn.addEventListener('click', async function(e) {
            e.stopPropagation();
            const itemId = this.getAttribute('data-id');
            const currentQty = parseInt(this.parentElement.querySelector('.basket-qty').textContent);
            
            if (window.FitRightFirebase) {
              if (currentQty > 1) {
                await window.FitRightFirebase.updateQuantity(itemId, currentQty - 1);
              } else {
                await window.FitRightFirebase.removeFromCart(itemId);
              }
            } else {
              // Fallback to localStorage
              let basket = JSON.parse(localStorage.getItem("basket")) || [];
              const index = parseInt(this.getAttribute('data-index'));
              if (currentQty > 1) {
                basket[index].quantity = currentQty - 1;
              } else {
                basket.splice(index, 1);
              }
              localStorage.setItem("basket", JSON.stringify(basket));
              updateBasketDropdown();
            }
          });
        });
      }
    }
    
    // Listen for cart updates
    window.addEventListener('cartUpdated', renderCart);
    
    // Load cart on page load
    document.addEventListener('DOMContentLoaded', function() {
      if (window.FitRightFirebase) {
        window.FitRightFirebase.loadCart().then(() => {
          renderCart();
        });
      }
    });
    
    function updateBasketDropdown() {
      // Get cart data from Firebase or localStorage fallback
      let cartItems, cartCount;
      
      if (window.FitRightFirebase && window.FitRightFirebase.isLoggedIn()) {
        cartItems = window.FitRightFirebase.getCartItems();
        cartCount = window.FitRightFirebase.getCartCount();
      } else {
        // Fallback to localStorage for guest mode
        const basket = JSON.parse(localStorage.getItem("basket")) || [];
        cartItems = basket;
        cartCount = basket.reduce((sum, item) => sum + (item.quantity || 1), 0);
      }
      
      if (cartItems.length === 0) {
        basketDropdownContent.innerHTML = '<div style="text-align:center;color:#888;">Your basket is empty.</div>';
        if (basketDropdownContentMobile) {
          basketDropdownContentMobile.innerHTML = '<div style="text-align:center;color:#888;">Your basket is empty.</div>';
        }
        basketCount.style.display = 'none';
        if (basketCountMobile) {
          basketCountMobile.textContent = '0';
          basketCountMobile.style.display = 'none';
        }
        
        // Hide clear basket buttons when basket is empty
        const basketDropdownFooter = document.getElementById('basketDropdownFooter');
        const basketDropdownFooterMobile = document.getElementById('basketDropdownFooterMobile');
        if (basketDropdownFooter) basketDropdownFooter.style.display = 'none';
        if (basketDropdownFooterMobile) basketDropdownFooterMobile.style.display = 'none';
        
        return;
      }
      
      // Update basket counters
      basketCount.textContent = cartCount;
      basketCount.style.display = cartCount > 0 ? 'inline-block' : 'none';
      if (basketCountMobile) {
        basketCountMobile.textContent = cartCount;
        basketCountMobile.style.display = cartCount > 0 ? 'inline-block' : 'none';
      }
      
      // Generate basket HTML
      const basketHTML = cartItems.map((item, idx) => `
        <div class="basket-row" data-index="${idx}" data-id="${item.id || item.productId || idx}" style="display:flex;align-items:center;margin-bottom:12px;padding-bottom:8px;position:relative;">
          <div style="width:48px;height:48px;background:#fafafa;border-radius:10px;margin-right:12px;display:flex;align-items:center;justify-content:center;">
            <img src="${item.productImage || item.image || item.imgUrl}" alt="${item.productName || item.name}" style="width:100%;height:100%;object-fit:contain;border-radius:10px;" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
            <div style="display:none;width:100%;height:100%;align-items:center;justify-content:center;color:#999;font-size:12px;text-align:center;line-height:1.2;">📦</div>
          </div>
          <div style="flex:1;">
            <div style="font-family:'Special Elite',monospace;font-size:1em;">${item.productName || item.name}</div>
            <div style="font-size:1em;font-weight:bold;">${window.FitRightFirebase && window.FitRightFirebase.formatPrice && (item.productPrice != null || item.price != null) ? window.FitRightFirebase.formatPrice((item.productPrice ?? item.price)) : (item.newPrice || '£0.00')}</div>
            <div style="font-size:0.95em;color:#555;">Qty: <span class="basket-qty" data-id="${item.id || item.productId || idx}">${item.quantity || 1}</span></div>
            ${(() => { const s = ((item.selectedSize || item.size) || '').toString(); return s && s.toLowerCase() !== 'standard' ? `<div style=\"font-size:0.95em;color:#555;\">Size: ${s}</div>` : '' })()}
          </div>
          <button class="basket-minus-btn" data-index="${idx}" data-id="${item.id || item.productId || idx}" style="background:#000;color:#fff;border:none;border-radius:50%;width:22px;height:22px;font-size:1em;display:flex;align-items:center;justify-content:center;cursor:pointer;position:absolute;top:8px;right:8px;">&minus;</button>
        </div>
      `).join('');

      basketDropdownContent.innerHTML = basketHTML;
      if (basketDropdownContentMobile) {
        basketDropdownContentMobile.innerHTML = basketHTML;
      }

      // Show clear basket buttons when basket has items
      const basketDropdownFooter = document.getElementById('basketDropdownFooter');
      const basketDropdownFooterMobile = document.getElementById('basketDropdownFooterMobile');
      if (basketDropdownFooter) basketDropdownFooter.style.display = 'block';
      if (basketDropdownFooterMobile) basketDropdownFooterMobile.style.display = 'block';

      // Add event listeners for minus buttons (desktop)
      basketDropdownContent.querySelectorAll('.basket-minus-btn').forEach(btn => {
        btn.addEventListener('click', async function(e) {
          e.stopPropagation();
          e.preventDefault();
          
          const cartItemId = this.getAttribute('data-id');
          const row = this.closest('.basket-row');
          
          if (window.FitRightFirebase && window.FitRightFirebase.isLoggedIn()) {
            // Firebase mode
            try {
              // Get current quantity
              const cartItems = window.FitRightFirebase.getCartItems();
              const currentItem = cartItems.find(item => (item.id || item.productId) === cartItemId);
              
              if (currentItem && currentItem.quantity > 1) {
                // Decrease quantity
                await window.FitRightFirebase.updateQuantity(cartItemId, currentItem.quantity - 1);
                console.log("Quantity decreased for item:", cartItemId);
              } else {
                // Remove item completely
                row.classList.remove('basket-fade-in');
                row.classList.add('basket-fade-out');
                setTimeout(async () => {
                  await window.FitRightFirebase.removeFromCart(cartItemId);
                  console.log("Item removed from cart:", cartItemId);
                }, 400);
              }
            } catch (error) {
              console.error("Error updating cart:", error);
              showToast("Error updating basket: " + error.message);
            }
          } else {
            // localStorage mode
            const idx = parseInt(this.getAttribute('data-index'));
            let basket = JSON.parse(localStorage.getItem("basket")) || [];
            
            if (basket[idx] && basket[idx].quantity > 1) {
              basket[idx].quantity -= 1;
              localStorage.setItem("basket", JSON.stringify(basket));
              // Update only the quantity number in the DOM
              const qtySpan = row.querySelector('.basket-qty');
              if (qtySpan) qtySpan.textContent = basket[idx].quantity;
              // Also update the basket counters
              const basketCount = document.getElementById('basketCount');
              const basketCountMobile = document.getElementById('basketCountMobile');
              const totalCount = basket.reduce((sum, item) => sum + (item.quantity || 1), 0);
              if (basketCount) {
                basketCount.textContent = totalCount;
                basketCount.style.display = totalCount > 0 ? 'inline-block' : 'none';
              }
              if (basketCountMobile) basketCountMobile.textContent = totalCount;
            } else {
              row.classList.remove('basket-fade-in');
              row.classList.add('basket-fade-out');
              setTimeout(() => {
                basket.splice(idx, 1);
                localStorage.setItem("basket", JSON.stringify(basket));
                updateBasketDropdown();
              }, 400);
            }
          }
        });
      });

      // Add event listeners for minus buttons (mobile)
      if (basketDropdownContentMobile) {
        basketDropdownContentMobile.querySelectorAll('.basket-minus-btn').forEach(btn => {
          btn.addEventListener('click', async function(e) {
            e.stopPropagation();
            e.preventDefault();
            
            const cartItemId = this.getAttribute('data-id');
            const row = this.closest('.basket-row');
            
            if (window.FitRightFirebase && window.FitRightFirebase.isLoggedIn()) {
              // Firebase mode
              try {
                // Get current quantity
                const cartItems = window.FitRightFirebase.getCartItems();
                const currentItem = cartItems.find(item => (item.id || item.productId) === cartItemId);
                
                if (currentItem && currentItem.quantity > 1) {
                  // Decrease quantity
                  await window.FitRightFirebase.updateQuantity(cartItemId, currentItem.quantity - 1);
                  console.log("Quantity decreased for item:", cartItemId);
                } else {
                  // Remove item completely
                  row.classList.remove('basket-fade-in');
                  row.classList.add('basket-fade-out');
                  setTimeout(async () => {
                    await window.FitRightFirebase.removeFromCart(cartItemId);
                    console.log("Item removed from cart:", cartItemId);
                  }, 400);
                }
              } catch (error) {
                console.error("Error updating cart:", error);
                showToast("Error updating basket: " + error.message);
              }
            } else {
              // localStorage mode
              const idx = parseInt(this.getAttribute('data-index'));
              let basket = JSON.parse(localStorage.getItem("basket")) || [];
              
              if (basket[idx] && basket[idx].quantity > 1) {
                basket[idx].quantity -= 1;
                localStorage.setItem("basket", JSON.stringify(basket));
                // Update only the quantity number in the DOM
                const qtySpan = row.querySelector('.basket-qty');
                if (qtySpan) qtySpan.textContent = basket[idx].quantity;
                // Also update the basket counters
                const basketCount = document.getElementById('basketCount');
                const basketCountMobile = document.getElementById('basketCountMobile');
                const totalCount = basket.reduce((sum, item) => sum + (item.quantity || 1), 0);
                if (basketCount) {
                  basketCount.textContent = totalCount;
                  basketCount.style.display = totalCount > 0 ? 'inline-block' : 'none';
                }
                if (basketCountMobile) basketCountMobile.textContent = totalCount;
              } else {
                row.classList.remove('basket-fade-in');
                row.classList.add('basket-fade-out');
                setTimeout(() => {
                  basket.splice(idx, 1);
                  localStorage.setItem("basket", JSON.stringify(basket));
                  updateBasketDropdown();
                }, 400);
              }
            }
          });
        });
      }
    }

    basketDropdownBtn.addEventListener('click', function(e) {
      e.stopPropagation();
      updateBasketDropdown();
      if (basketDropdown.classList.contains('show')) {
        basketDropdown.classList.remove('show');
        setTimeout(() => { basketDropdown.style.display = 'none'; }, 300);
      } else {
        basketDropdown.style.display = 'block';
        setTimeout(() => { basketDropdown.classList.add('show'); }, 10);
      }
    });
    
    if (basketDropdownBtnMobile) {
      basketDropdownBtnMobile.addEventListener('click', function(e) {
        e.stopPropagation();
        updateBasketDropdown();
        if (basketDropdownMobile.classList.contains('show')) {
          basketDropdownMobile.classList.remove('show');
          setTimeout(() => { basketDropdownMobile.style.display = 'none'; }, 300);
        } else {
          basketDropdownMobile.style.display = 'block';
          setTimeout(() => { basketDropdownMobile.classList.add('show'); }, 10);
        }
      });
    }
    
    document.addEventListener('click', function(e) {
      if (!basketDropdown.contains(e.target) && !basketDropdownMobile.contains(e.target) && 
          e.target !== basketDropdownBtn && e.target !== basketDropdownBtnMobile) {
        if (basketDropdown.classList.contains('show')) {
          basketDropdown.classList.remove('show');
          setTimeout(() => { basketDropdown.style.display = 'none'; }, 300);
        }
        if (basketDropdownMobile.classList.contains('show')) {
          basketDropdownMobile.classList.remove('show');
          setTimeout(() => { basketDropdownMobile.style.display = 'none'; }, 300);
        }
      }
    });
    
    // Clear basket button functionality
    const clearBasketBtn = document.getElementById('clearBasketBtn');
    const clearBasketBtnMobile = document.getElementById('clearBasketBtnMobile');

    function clearBasket() {
      if (window.FitRightFirebase && window.FitRightFirebase.isLoggedIn()) {
        // Firebase mode
        window.FitRightFirebase.clearCart().then(() => {
          updateBasketDropdown();
          showToast("Basket cleared!");
        }).catch(error => {
          console.error("Error clearing Firebase cart:", error);
          showToast("Error clearing basket: " + error.message);
        });
      } else {
        // localStorage mode
        localStorage.removeItem("basket");
        updateBasketDropdown();
        showToast("Basket cleared!");
      }
    }

    if (clearBasketBtn) {
      clearBasketBtn.addEventListener('click', function(e) {
        e.stopPropagation();
        if (confirm("Are you sure you want to clear your basket?")) {
          clearBasket();
        }
      });
    }

    if (clearBasketBtnMobile) {
      clearBasketBtnMobile.addEventListener('click', function(e) {
        e.stopPropagation();
        if (confirm("Are you sure you want to clear your basket?")) {
          clearBasket();
        }
      });
    }
    
    // Update basket count on page load
    updateBasketDropdown();
    // Update basket count when basket changes (listen to storage event for multi-tab)
    window.addEventListener('storage', function(e) {
      if (e.key === 'basket') updateBasketDropdown();
    });

    // Load basket items from localStorage on page load
    window.addEventListener('DOMContentLoaded', function() {
      loadProducts();
      updateBasketDropdown();
    });

    // Load products and apply discounts
    async function loadProducts() {
      try {
        // Instead of fetching from a file, we'll hardcode the products data to avoid CORS issues
        const discountedProducts = [
          {
            "id": "belt1",
            "name": "belt1",
            "category": "belts",
            "imagePath": "https://via.placeholder.com/150?text=Belt+1",
            "price": 50,
            "discount": true,
            "discountPercent": 30
          },
          {
            "id": "belt3",
            "name": "belt3",
            "category": "belts",
            "imagePath": "https://via.placeholder.com/150?text=Belt+3",
            "price": 60,
            "discount": true,
            "discountPercent": 40
          },
          {
            "id": "belt5",
            "name": "belt5",
            "category": "belts",
            "imagePath": "https://via.placeholder.com/150?text=Belt+5",
            "price": 70,
            "discount": true,
            "discountPercent": 65
          },
          {
            "id": "belt7",
            "name": "belt7",
            "category": "belts",
            "imagePath": "https://via.placeholder.com/150?text=Belt+7",
            "price": 80,
            "discount": true,
            "discountPercent": 25
          },
          {
            "id": "cap/hat1",
            "name": "cap/hat1",
            "category": "hats",
            "imagePath": "https://assets.onecompiler.app/42mhv938c/42mn3wcty/WhatsApp%20Image%202025-02-05%20at%2010.56.23_34edff8a.jpg",
            "price": 25,
            "discount": true,
            "discountPercent": 20
          },
          {
            "id": "footwear1",
            "name": "footwear1",
            "category": "footwear",
            "imagePath": "https://assets.onecompiler.app/42mhv938c/42mn3wcty/WhatsApp%20Image%202024-12-11%20at%2015.41.06_f2708529.jpg",
            "price": 120,
            "discount": true,
            "discountPercent": 50
          },
          {
            "id": "footwear2",
            "name": "footwear2",
            "category": "footwear",
            "imagePath": "https://assets.onecompiler.app/42mhv938c/42mn3wcty/WhatsApp%20Image%202024-12-11%20at%2015.41.07_65068fa5.jpg",
            "price": 25,
            "discount": true,
            "discountPercent": 30
          },
          {
            "id": "footwear3",
            "name": "footwear3",
            "category": "footwear",
            "imagePath": "https://assets.onecompiler.app/42mhv938c/42mn3wcty/WhatsApp%20Image%202024-12-11%20at%2015.41.07_ec433eab.jpg",
            "price": 35,
            "discount": true,
            "discountPercent": 60
          },
          {
            "id": "glove1",
            "name": "glove1",
            "category": "gloves",
            "imagePath": "https://assets.onecompiler.app/42mhv938c/42mn3wcty/WhatsApp%20Image%202025-02-05%20at%2010.56.21_c4614d2d.jpg",
            "price": 35,
            "discount": true,
            "discountPercent": 45
          },
          {
            "id": "leather_jacket1",
            "name": "leather_jacket1",
            "category": "leather jackets",
            "imagePath": "https://assets.onecompiler.app/42mhv938c/42mn3wcty/WhatsApp%20Image%202024-12-11%20at%2015.36.08_4f9bf797.jpg",
            "price": 200,
            "discount": true,
            "discountPercent": 60
          },
          {
            "id": "scarf1",
            "name": "scarf1",
            "category": "scarves",
            "imagePath": "https://via.placeholder.com/150?text=Scarf+1",
            "price": 50,
            "discount": true,
            "discountPercent": 35
          },
          {
            "id": "scarf3",
            "name": "scarf3",
            "category": "scarves",
            "imagePath": "https://via.placeholder.com/150?text=Scarf+3",
            "price": 60,
            "discount": true,
            "discountPercent": 40
          },
          {
            "id": "scarf5",
            "name": "scarf5",
            "category": "scarves",
            "imagePath": "https://via.placeholder.com/150?text=Scarf+5",
            "price": 70,
            "discount": true,
            "discountPercent": 60
          },
          {
            "id": "scarf7",
            "name": "scarf7",
            "category": "scarves",
            "imagePath": "https://via.placeholder.com/150?text=Scarf+7",
            "price": 80,
            "discount": true,
            "discountPercent": 25
          },
          {
            "id": "sunglasses1",
            "name": "sunglasses1",
            "category": "sunglasses",
            "imagePath": "https://assets.onecompiler.app/42mhv938c/42mn3wcty/WhatsApp%20Image%202024-12-11%20at%2015.41.07_15f0a57a.jpg",
            "price": 80,
            "discount": true,
            "discountPercent": 55
          },
          {
            "id": "sunglasses2",
            "name": "sunglasses2",
            "category": "sunglasses",
            "imagePath": "https://assets.onecompiler.app/42mhv938c/42mn3wcty/WhatsApp%20Image%202024-12-11%20at%2015.41.22_0cecf64c.jpg",
            "price": 55,
            "discount": true,
            "discountPercent": 30
          },
          {
            "id": "sunglasses3",
            "name": "sunglasses3",
            "category": "sunglasses",
            "imagePath": "https://assets.onecompiler.app/42mhv938c/42mn3wcty/WhatsApp%20Image%202024-12-11%20at%2015.41.22_03d2784a.jpg",
            "price": 60,
            "discount": true,
            "discountPercent": 65
          },
          {
            "id": "wallet1",
            "name": "wallet1",
            "category": "wallets",
            "imagePath": "https://via.placeholder.com/300x300?text=Wallet+1",
            "price": 40,
            "discount": true,
            "discountPercent": 25
          },
          {
            "id": "wallet2",
            "name": "wallet2",
            "category": "wallets",
            "imagePath": "https://via.placeholder.com/300x300?text=Wallet+2",
            "price": 45,
            "discount": true,
            "discountPercent": 70
          }
        ];
        
        // Create a map of discounted products for easy lookup
        const discountMap = {};
        discountedProducts.forEach(product => {
          discountMap[product.id] = product;
        });
        
        // Define footwear products with real images
        const footwearProducts = [
          {
            id: "footwear1",
            name: "Ridgewalker Classic",
            price: 95,
            imgUrl: "Cowboy-1.jpg"
          },
          {
            id: "footwear2",
            name: "Rose Rebel",
            price: 85,
            imgUrl: "Cowboy0.jpg"
          },
          {
            id: "footwear3",
            name: "Midnight Marcher",
            price: 135,
            imgUrl: "Cowboy49.jpg"
          },
          {
            id: "footwear4",
            name: "Ladies Ankle Boots",
            price: 35,
            imgUrl: "Cowboy55.jpg"
          },
          {
            id: "footwear5",
            name: "Goodyear Welted Suede Chelsea",
            price: 75,
            imgUrl: "Cowboy50.jpg"
          },
          {
            id: "footwear6",
            name: "Mens Leather Formal Comfort ",
            price: 65,
            imgUrl: "Cowboy51.jpg"
          },
          {
            id: "footwear7",
            name: "Mens Leather Formal Burgundy Casual",
            price: 75,
            imgUrl: "Cowboy52.jpg"
          },
          {
            id: "footwear8",
            name: "Mens Leather Formal",
            price: 40,
            imgUrl: "Cowboy53.jpg"
          },
          {
            id: "footwear9",
            name: "Mens Leather Casual Formal",
            price: 65,
            imgUrl: "Cowboy54.jpg"
          },
          {
            id: "footwear10",
            name: "Arizona Lo",
            price: 70,
            imgUrl: "Cowboy2.jpg"
          },
          {
            id: "footwear11",
            name: "Arizona",
            price: 180,
            imgUrl: "Cowboy1.jpg"
          },
          {
            id: "footwear12",
            name: "Austin",
            price: 145,
            imgUrl: "Cowboy3.jpg"
          },
          {
            id: "footwear13",
            name: "Bald Eagle",
            price: 175,
            imgUrl: "Cowboy4.jpg"
          },
          {
            id: "footwear14",
            name: "Buffalo",
            price: 180,
            imgUrl: "Cowboy5.jpg"
          },
          {
            id: "footwear15",
            name: "Bulldog ACS",
            price: 115,
            imgUrl: "Cowboy6.jpg"
          },
          {
            id: "footwear16",
            name: "Bulldog CS",
            price: 95,
            imgUrl: "Cowboy7.jpg"
          },
          {
            id: "footwear17",
            name: "Camelot CS",
            price: 105,
            imgUrl: "Cowboy8.jpg"
          },
          {
            id: "footwear18",
            name: "Cameron ACS",
            price: 145,
            imgUrl: "Cowboy9.jpg"
          },
          {
            id: "footwear19",
            name: "Carolina",
            price: 180,
            imgUrl: "Cowboy10.jpg"
          },
          {
            id: "footwear20",
            name: "Cedric CS",
            price: 115,
            imgUrl: "Cowboy11.jpg"
          },
          {
            id: "footwear21",
            name: "Charger",
            price: 155,
            imgUrl: "Cowboy12.jpg"
          },
          {
            id: "footwear22",
            name: "Charlie ACS",
            price: 145,
            imgUrl: "Cowboy13.jpg"
          },
          {
            id: "footwear23",
            name: "Chelsea ACS",
            price: 130,
            imgUrl: "Cowboy14.jpg"
          },
          {
            id: "footwear24",
            name: "Dakota",
            price: 175,
            imgUrl: "Cowboy15.jpg"
          },
          {
            id: "footwear25",
            name: "Dallas",
            price: 170,
            imgUrl: "Cowboy16.jpg"
          },
          {
            id: "footwear26",
            name: "Eagle Hi",
            price: 185,
            imgUrl: "Cowboy17.jpg"
          },
          {
            id: "footwear27",
            name: "Eagle Lo",
            price: 150,
            imgUrl: "Cowboy18.jpg"
          },
          {
            id: "footwear28",
            name: "El Paso",
            price: 170,
            imgUrl: "Cowboy19.jpg"
          },
          {
            id: "footwear29",
            name: "Falcon",
            price: 110,
            imgUrl: "Cowboy20.jpg"
          },
          {
            id: "footwear30",
            name: "Frontier",
            price: 170,
            imgUrl: "Cowboy21.jpg"
          },
          {
            id: "footwear31",
            name: "Galveston",
            price: 185,
            imgUrl: "Cowboy22.jpg"
          },
          {
            id: "footwear32",
            name: "Georgia",
            price: 145,
            imgUrl: "Cowboy23.jpg"
          },
          {
            id: "footwear33",
            name: "Harness Hi",
            price: 180,
            imgUrl: "Cowboy24.jpg"
          },
          {
            id: "footwear34",
            name: "Harness Lo",
            price: 145,
            imgUrl: "Cowboy25.jpg"
          },
          {
            id: "footwear35",
            name: "Herald CS",
            price: 190,
            imgUrl: "Cowboy26.jpg"
          },
          {
            id: "footwear36",
            name: "Hunter",
            price: 195,
            imgUrl: "Cowboy27.jpg"
          },
          {
            id: "footwear37",
            name: "Indiana",
            price: 200,
            imgUrl: "Cowboy28.jpg"
          },
          {
            id: "footwear38",
            name: "Jodhpur",
            price: 140,
            imgUrl: "Cowboy29.jpg"
          },
          {
            id: "footwear39",
            name: "Kansas",
            price: 210,
            imgUrl: "Cowboy30.jpg"
          },
          {
            id: "footwear40",
            name: "Kestrel",
            price: 120,
            imgUrl: "Cowboy31.jpg"
          },
          {
            id: "footwear41",
            name: "King CS",
            price: 115,
            imgUrl: "Cowboy32.jpg"
          },
          {
            id: "footwear42",
            name: "Louisiana",
            price: 180,
            imgUrl: "Cowboy33.jpg"
          },
          {
            id: "footwear43",
            name: "Maverick",
            price: 145,
            imgUrl: "Cowboy34.jpg"
          },
          {
            id: "footwear44",
            name: "Montana",
            price: 225,
            imgUrl: "Cowboy35.jpg"
          },
          {
            id: "footwear45",
            name: "Mustang",
            price: 145,
            imgUrl: "Cowboy36.jpg"
          },
          {
            id: "footwear46",
            name: "Nevada",
            price: 145,
            imgUrl: "Cowboy37.jpg"
          },
          {
            id: "footwear47",
            name: "Quad CS",
            price: 150,
            imgUrl: "Cowboy38.jpg"
          },
          {
            id: "footwear48",
            name: "Rebel",
            price: 175,
            imgUrl: "Cowboy39.jpg"
          },
          {
            id: "footwear49",
            name: "Regent CS",
            price: 80,
            imgUrl: "Cowboy40.jpg"
          },
          {
            id: "footwear50",
            name: "Renegade Hi",
            price: 170,
            imgUrl: "Cowboy41.jpg"
          },
          {
            id: "footwear51",
            name: "Renegade Lo",
            price: 135,
            imgUrl: "Cowboy42.jpg"
          },
          {
            id: "footwear52",
            name: "Ryan ACS",
            price: 150,
            imgUrl: "Cowboy43.jpg"
          },
          {
            id: "footwear53",
            name: "Stag ACS",
            price: 130,
            imgUrl: "Cowboy44.jpg"
          },
          {
            id: "footwear54",
            name: "Stag CS",
            price: 90,
            imgUrl: "Cowboy45.jpg"
          },
          {
            id: "footwear55",
            name: "Taylor CS",
            price: 145,
            imgUrl: "Cowboy46.jpg"
          },
          {
            id: "footwear56",
            name: "Wild One",
            price: 175,
            imgUrl: "Cowboy47.jpg"
          },
          {
            id: "footwear57",
            name: "Zip & Lace",
            price: 115,
            imgUrl: "Cowboy48.jpg"
          }
        ];
        
        // Generate additional footwear products (0 more since we've added all the cowboy images)
        const additionalFootwear = [];
        
        // Combine all footwear products
        const allFootwear = [...footwearProducts, ...additionalFootwear];
        
        // Clear existing products
        const productsContainer = document.getElementById("products-container");
        productsContainer.innerHTML = '';
        
        // Add all footwear to the page
        allFootwear.forEach(footwear => {
          const productDiv = document.createElement("div");
          productDiv.className = "product";
          
          // Check if this footwear is in the discounted products
          const discountInfo = discountMap[footwear.id];
          let productHTML = '';
          let priceDisplay = '';
          
          if (discountInfo && discountInfo.discount) {
            // Calculate discounted price
            const discountedPrice = footwear.price * (1 - discountInfo.discountPercent / 100);
            const formattedOriginalPrice = `£${footwear.price}`;
            const formattedDiscountedPrice = `£${discountedPrice.toFixed(2)}`;
            
            // Determine tag type based on discount percentage
            const tagType = discountInfo.discountPercent > 55 ? 'gold' : 'red';
            const tagText = tagType === 'gold' 
              ? `★★ ${discountInfo.discountPercent}% OFF – Bargain of the Day ★★`
              : `★ ${discountInfo.discountPercent}% OFF ★`;
            
            // Add discount tag
            productHTML += `<div class="discount-tag ${tagType}">${tagText}</div>`;
            
            // Price display with original and new price
            priceDisplay = `<p class="product-price"><span class="original-price">${formattedOriginalPrice}</span> <span class="new-price">${formattedDiscountedPrice}</span></p>`;
          } else {
            // Regular price display
            priceDisplay = `<p class="product-price">£${footwear.price}</p>`;
          }
          
          // Complete product HTML
          // Check if it's a placeholder image
          const isPlaceholder = footwear.imgUrl.includes('placeholder.com');
          const imgStyle = isPlaceholder ? 'style="opacity: 0;"' : '';
          
          productHTML += `
            <div class="image-container">
              <img src="${footwear.imgUrl}" alt="${footwear.name}" ${imgStyle}>
            </div>
            <p class="product-name">${footwear.name}</p>
            ${priceDisplay}
          `;
          
          productDiv.innerHTML = productHTML;
          productDiv.onclick = function() {
            if (discountInfo && discountInfo.discount) {
              const discountedPrice = footwear.price * (1 - discountInfo.discountPercent / 100);
              openModal(footwear.name, `£${discountedPrice.toFixed(2)}`, footwear.imgUrl, true, `£${footwear.price}`);
            } else {
              openModal(footwear.name, `£${footwear.price}`, footwear.imgUrl);
            }
          };
          
          productsContainer.appendChild(productDiv);
        });
        
      } catch (error) {
        console.error('Error loading products:', error);
      }
    }
    
    // Firebase Cart Integration
    let currentProductData = null;
    
    // Function to extract product data from modal
    function extractProductFromModal() {
      const name = modalProductName.textContent;
      const priceElement = modalProductPrice.querySelector(".new-price");
      const price = priceElement ? priceElement.textContent : modalProductPrice.textContent;
      const imgUrl = modalProductImage.src;
      const selectedSize = (sizeSelector && sizeSelector.value) ? sizeSelector.value : '';
      
      // Convert price to cents (preserve decimals accurately)
      const numericPrice = parseFloat(price.replace(/[£,]/g, ''));
      const priceInCents = Number.isFinite(numericPrice) ? Math.round(numericPrice * 100) : 0;
      
      return {
        id: `${name.toLowerCase().replace(/\s+/g, '-')}${selectedSize ? '_' + selectedSize.replace(/[^a-z0-9]+/gi,'-').toLowerCase() : ''}`,
        name: name,
        price: priceInCents,
        image: imgUrl,
        category: 'footwear',
        selectedSize: selectedSize
      };
    }
    
    // Firebase cart function
    async function addToBasketFirebase() {
      try {
        if (!window.FitRightFirebase) {
          console.error('FitRightFirebase not loaded');
          return;
        }
        
        const productData = extractProductFromModal();
        await window.FitRightFirebase.addProductToCart(productData, 1);
        showToast("Product added to basket!");
        console.log("Product added to Firebase cart:", productData);
      } catch (error) {
        console.error("Error adding to cart:", error);
        showToast("Error adding to basket: " + error.message);
      }
    }
    
    // BUY parity with leather_jackets: centralized buy handler
    function buyProduct() {
      try { hideProcessing?.(); } catch(_) {}
      const pd = (typeof currentProductData === 'object' && currentProductData) ? currentProductData : {
        name: (document.getElementById('modalProductName')?.textContent || '').trim(),
        price: (document.getElementById('modalProductPrice')?.querySelector('.new-price')?.textContent || document.getElementById('modalProductPrice')?.textContent || '').trim(),
        imgUrl: document.getElementById('modalProductImage')?.src || ''
      };
      if (!pd || !pd.name) { try { showToast('No product selected'); } catch(_) {} return; }
      const selectedSize = (document.getElementById('sizeSelector')?.value) || '';
      
      // Prefer Firebase cart when available; fallback to localStorage
      try {
        if (window.FitRightFirebase && typeof window.FitRightFirebase.addProductToCart === 'function') {
          const numericPrice = parseFloat(String(pd.price).replace(/[£,]/g, ''));
          const priceInCents = Number.isFinite(numericPrice) ? Math.round(numericPrice * 100) : 0;
          const productData = {
            id: `footwear_${pd.name.replace(/[^a-zA-Z0-9]/g, '_')}_${selectedSize.replace(/[^a-zA-Z0-9]/g, '_')}`,
            name: pd.name,
            price: priceInCents,
            image: pd.imgUrl,
            category: 'footwear',
            selectedSize: selectedSize
          };
          const items = (typeof window.FitRightFirebase.getCartItems === 'function') ? window.FitRightFirebase.getCartItems() : [];
          const existing = items.find(it => it.name === productData.name && (it.selectedSize || it.size) === productData.selectedSize);
          if (existing && typeof window.FitRightFirebase.updateQuantity === 'function') {
            window.FitRightFirebase.updateQuantity(existing.id || existing.productId, (existing.quantity || 1) + 1);
          } else {
            window.FitRightFirebase.addProductToCart(productData, 1);
          }
          try { showToast('Product added to basket!'); } catch(_) {}
          try { window.dispatchEvent(new CustomEvent('cartUpdated')); } catch(_) {}
          try { if (typeof updateBasketDropdown === 'function') updateBasketDropdown(); } catch(_) {}
          try { returnToCatalogue(); } catch(_) {}
          return;
        }
      } catch (_) { /* ignore and fallback */ }

      // Fallback: local storage
      try {
        addToBasket(pd.name, pd.price, pd.imgUrl, selectedSize, true);
        if (typeof updateBasketDropdown === 'function') updateBasketDropdown();
        returnToCatalogue();
      } catch(_) {}
    }

    // Basket Handling & Toast Notification
    function addToBasket(name, price, imgUrl, size, showMessage = true) {
      let basket = JSON.parse(localStorage.getItem("basket")) || [];
      const existingIndex = basket.findIndex(item => item.name === name);
      if (existingIndex !== -1) {
        const item = basket[existingIndex];
        item.quantity = (item.quantity || 1) + 1;
        localStorage.setItem("basket", JSON.stringify(basket));
        
        // Immediately update the basket counter
        const totalCount = basket.reduce((sum, item) => sum + (item.quantity || 1), 0);
        basketCount.textContent = totalCount;
        basketCount.style.display = 'inline-block';
        if (basketCountMobile) {
          basketCountMobile.textContent = totalCount;
          basketCountMobile.style.display = 'inline-block';
        }
        
        updateBasketDropdown();
        if (showMessage) showToast("Product quantity updated in basket!");
      } else {
        basket.push({ name, newPrice: price, imgUrl, size, quantity: 1 });
        localStorage.setItem("basket", JSON.stringify(basket));
        
        // Immediately update the basket counter
        const totalCount = basket.reduce((sum, item) => sum + (item.quantity || 1), 0);
        basketCount.textContent = totalCount;
        basketCount.style.display = 'inline-block';
        if (basketCountMobile) {
          basketCountMobile.textContent = totalCount;
          basketCountMobile.style.display = 'inline-block';
        }
        
        updateBasketDropdown();
        if (showMessage) showToast("Product added to basket!");
      }
    }
    
    document.getElementById("addToBasket").onclick = function () {
      // Use Firebase if available, otherwise fallback to localStorage
      if (window.FitRightFirebase) {
        addToBasketFirebase();
        closeModal();
      } else {
        const name = modalProductName.textContent;
        const priceElement = modalProductPrice.querySelector(".new-price");
        const price = priceElement ? priceElement.textContent : modalProductPrice.textContent;
        const imgUrl = modalProductImage.src;
        const selectedSize = sizeSelector.value; // Get selected size
        addToBasket(name, price, imgUrl, selectedSize, true); // Pass selected size
        closeModal();
      }
    };

  // BUY in final result → mirror leather_jackets by delegating to buyProduct()
  try {
    document.getElementById('finalBuyBtn')?.addEventListener('click', () => {
      try { buyProduct(); } catch (e) { try { showToast('Could not add to basket'); } catch(_) {} }
    });
  } catch(_) {}
    
    proceedBtn.addEventListener("click", () => {
      const name = modalProductName.textContent;
      const priceElement = modalProductPrice.querySelector(".new-price");
      const price = priceElement ? priceElement.textContent : modalProductPrice.textContent;
      const imageUrl = modalProductImage.src;
      const selectedSize = sizeSelector.value; // Get selected size
      addToBasket(name, price, imageUrl, selectedSize, false); // Pass selected size, no toast
      const queryString = `?name=${encodeURIComponent(name)}&price=${encodeURIComponent(price)}&imgUrl=${encodeURIComponent(imageUrl)}&size=${encodeURIComponent(selectedSize)}`; // Add size to query string
      window.location.href = "page3.html" + queryString;
    });
    
    function showToast(message) {
      const toastEl = document.getElementById("toast");
      toastEl.textContent = message;
      toastEl.classList.add("show");
      setTimeout(() => { toastEl.classList.remove("show"); }, 2000);
    }
  </script>
  <script>
    // Try-On logic removed
    

    function showToast(message) {
      const toastEl = document.getElementById("toast");
      toastEl.textContent = message;
      toastEl.classList.add("show");
      setTimeout(() => { toastEl.classList.remove("show"); }, 2000);
    }

    function ensureExecuteAIButtonVisible() {
      const continueBtn = document.getElementById('continueBtn');
      if (!continueBtn) { return; }

      // Hide when already activated, processing, or processing completed
      try {
        // Hard reset to hidden/disabled by default
        continueBtn.classList.remove('fadeout');
        continueBtn.disabled = true;
        continueBtn.style.pointerEvents = 'none';
        continueBtn.style.opacity = '';
        continueBtn.style.visibility = '';
        continueBtn.style.display = 'none';

        if (hasActivatedAI || isProcessing || hasProcessingCompleted) {
          continueBtn.style.display = 'none';
          continueBtn.classList.remove('show');
          continueBtn.disabled = true;
          return;
        }
      } catch (_) {}

      // Show when there is a selected person photo
      try {
        // Require a real upload preview or flag to avoid false positives after redo
        const uploadContainer = document.querySelector('.upload-container');
        const uploadArea = document.getElementById('personUploadArea');
        const preview = document.getElementById('personPhotoPreview');
        const hasPhotoClass = (uploadContainer && uploadContainer.classList.contains('has-photo')) || (uploadArea && uploadArea.classList.contains('has-photo'));
        const previewHasSrc = !!(preview && preview.src && preview.src.trim() !== '');
        const hasValidUpload = (typeof personFile !== 'undefined' && personFile) && (hasPhotoClass || previewHasSrc);

        if (hasValidUpload) {
          continueBtn.style.display = 'block';
          continueBtn.style.visibility = 'visible';
          continueBtn.style.opacity = '1';
          continueBtn.classList.add('show');
          continueBtn.classList.remove('hidden');
          continueBtn.disabled = false;
          continueBtn.style.pointerEvents = 'auto';

          // Final verification pass
          setTimeout(() => {
            const isVisible = continueBtn.style.display !== 'none' && continueBtn.classList.contains('show') && !continueBtn.disabled;
            try {
              if (!isVisible && !hasProcessingCompleted && !hasActivatedAI && !isProcessing) {
                continueBtn.style.display = 'block';
                continueBtn.classList.add('show');
                continueBtn.disabled = false;
                continueBtn.classList.remove('fadeout');
              }
            } catch (_) {}
          }, 100);
        } else {
          continueBtn.style.display = 'none';
          continueBtn.classList.remove('show');
          continueBtn.disabled = true;
          continueBtn.style.pointerEvents = 'none';
        }
      } catch (_) {
        // If something goes wrong, default to hidden/disabled
        continueBtn.style.display = 'none';
        continueBtn.classList.remove('show');
        continueBtn.disabled = true;
        continueBtn.style.pointerEvents = 'none';
      }
    }

    function validateFile(file) {
      try {
        const maxSize = 25 * 1024 * 1024; // 25MB
        const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/webp'];
        if (!allowedTypes.includes(file.type)) {
          try { showToast('Unsupported format. Use PNG, JPG, JPEG or WebP.'); } catch (_) {}
          return false;
        }
        if (file.size > maxSize) {
          try { showToast('File too large. Maximum 25MB.'); } catch (_) {}
          return false;
        }
      } catch (_) { /* ignore */ }
      return true;
    }

    function handlePersonFileSelect(file) {
      if (!validateFile(file)) return;

      try { window.personFile = file; } catch (_) {}
      try { hasProcessingCompleted = false; } catch (_) {}

      // Ensure upload UI section is visible
      try {
        const ms = document.getElementById('modelUploadSection');
        if (ms) { ms.classList.add('show'); ms.style.display = 'block'; ms.style.opacity = '1'; }
      } catch (_) {}

      const uploadPrompt = document.getElementById('uploadPrompt');
      const uploadTitle = document.querySelector('.upload-title');
      const personUploadInner = document.getElementById('personUploadInner');
      const uploadContainer = document.querySelector('.upload-container');
      const personUploadArea = document.getElementById('personUploadArea');
      const personPhotoPreview = document.getElementById('personPhotoPreview');
      const removeBtn = document.getElementById('removePhotoBtn');

      try {
        if (uploadPrompt) { uploadPrompt.style.transition = 'opacity 0.6s ease-out'; uploadPrompt.style.opacity = '0'; }
        if (uploadTitle) { uploadTitle.style.transition = 'opacity 0.6s ease-out'; uploadTitle.style.opacity = '0'; }
        if (personUploadInner) { personUploadInner.style.transition = 'opacity 0.6s ease-out'; personUploadInner.style.opacity = '0'; }
      } catch (_) {}

      const reader = new FileReader();
      reader.onload = (e) => {
        setTimeout(() => {
          try {
            if (uploadPrompt) { uploadPrompt.classList.add('hidden'); uploadPrompt.style.display = 'none'; }
            if (uploadTitle) uploadTitle.style.display = 'none';
            if (personUploadInner) personUploadInner.classList.add('hidden');
            if (uploadContainer) uploadContainer.classList.add('has-photo');
            if (personUploadArea) personUploadArea.classList.add('has-photo');
            if (personPhotoPreview) {
              // Prefer object URL for immediate rendering; fallback to base64
              try {
                const blobUrl = URL.createObjectURL(file);
                personPhotoPreview.src = blobUrl;
              } catch (_) { personPhotoPreview.src = e.target.result; }

              // Ensure the image layers above and fills the upload area
              personPhotoPreview.style.position = 'absolute';
              personPhotoPreview.style.top = '0';
              personPhotoPreview.style.left = '0';
              personPhotoPreview.style.width = '100%';
              personPhotoPreview.style.height = '100%';
              personPhotoPreview.style.objectFit = 'cover';
              personPhotoPreview.style.borderRadius = '15px';
              personPhotoPreview.style.zIndex = '1';
              personPhotoPreview.style.opacity = '0';
              personPhotoPreview.style.transition = 'opacity 0.8s ease-in-out';
              personPhotoPreview.style.display = 'block';

              // Fade-in
              requestAnimationFrame(() => {
                personPhotoPreview.classList.add('show');
                personPhotoPreview.style.opacity = '1';
              });
              if (removeBtn) removeBtn.classList.add('show');
              ensureExecuteAIButtonVisible();
            }
          } catch (_) {}
        }, 600);
      };
      try { reader.readAsDataURL(file); } catch (_) {}
    }

    // Ensure the camera SVG exists inside the upload prompt (recreate if removed)
    function ensureUploadPromptSVG() {
      try {
        const uploadPrompt = document.getElementById('uploadPrompt');
        if (!uploadPrompt) return;
        let iconWrap = uploadPrompt.querySelector('.upload-icon');
        if (!iconWrap) {
          iconWrap = document.createElement('div');
          iconWrap.className = 'upload-icon';
          uploadPrompt.appendChild(iconWrap);
        }
        const hasSVG = !!iconWrap.querySelector('svg');
        if (!hasSVG) {
          iconWrap.innerHTML = '<svg width="80" height="80" viewBox="0 0 120 120" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">\
                <rect x="35" y="5" width="50" height="25" rx="8" ry="8" fill="none"/>\
                <rect x="40" y="10" width="40" height="15" rx="4" ry="4" fill="none"/>\
                <ellipse cx="60" cy="17.5" rx="15" ry="8" fill="none" opacity="0.3"/>\
                <rect x="55" y="30" width="10" height="8" rx="2" ry="2"/>\
                <rect x="20" y="38" width="80" height="55" rx="6" ry="6"/>\
                <rect x="25" y="33" width="70" height="10" rx="3" ry="3"/>\
                <rect x="45" y="28" width="30" height="8" rx="2" ry="2"/>\
                <rect x="50" y="25" width="20" height="6" rx="2" ry="2"/>\
                <circle cx="60" cy="65" r="22"/>\
                <circle cx="60" cy="65" r="18"/>\
                <circle cx="60" cy="65" r="14"/>\
                <circle cx="60" cy="65" r="10"/>\
                <circle cx="60" cy="65" r="6"/>\
                <circle cx="57" cy="62" r="3" fill="currentColor" opacity="0.2"/>\
                <circle cx="85" cy="45" r="3"/>\
                <circle cx="85" cy="55" r="2"/>\
                <rect x="82" y="65" width="6" height="4" rx="1"/>\
              </svg>';
        }
        // Make sure it is visible
        uploadPrompt.style.display = 'block';
        uploadPrompt.style.opacity = '1';
      } catch(_) {}
    }

    function removePersonPhoto() {
      try { window.personFile = null; } catch (_) {}
      try { hasProcessingCompleted = false; hasActivatedAI = false; } catch (_) {}
      try { localStorage.removeItem(RESULT_STORAGE_KEY); } catch (_) {}

      try {
        const personPhotoPreview = document.getElementById('personPhotoPreview');
        const removeBtn = document.getElementById('removePhotoBtn');
        const uploadArea = document.getElementById('personUploadArea');
        const uploadContainer = document.querySelector('.upload-container');
        const uploadPrompt = document.getElementById('uploadPrompt');
        const uploadTitle = document.querySelector('.upload-title');
        const personUploadInner = document.getElementById('personUploadInner');

        if (personPhotoPreview) {
          personPhotoPreview.classList.remove('show');
        }
        if (removeBtn) removeBtn.classList.remove('show');

        // Hide button when no photo
        ensureExecuteAIButtonVisible();

        // Immediately restore the upload prompt state (mirror leather_jackets behavior)
        // so the camera SVG and texts are visible right away.
        if (uploadPrompt) {
          uploadPrompt.classList.remove('hidden');
          uploadPrompt.style.display = 'block';
          uploadPrompt.style.opacity = '1';
        }
        if (uploadTitle) {
          uploadTitle.style.display = 'block';
          uploadTitle.style.opacity = '1';
        }
        if (personUploadInner) {
          personUploadInner.classList.remove('hidden');
          personUploadInner.style.display = 'block';
          personUploadInner.style.opacity = '1';
        }
        // Ensure the camera SVG is present without waiting for the delayed cleanup
        try { ensureUploadPromptSVG(); } catch(_) {}
        // Critical: clear the file input immediately so selecting the SAME image triggers change
        try { const fi = document.getElementById('personFileInput'); if (fi) fi.value=''; } catch(_) {}

        setTimeout(() => {
          if (uploadArea) uploadArea.classList.remove('has-photo');
          if (uploadContainer) uploadContainer.classList.remove('has-photo');
          if (personPhotoPreview) { personPhotoPreview.style.display = 'none'; personPhotoPreview.src = ''; }
          if (uploadPrompt) { uploadPrompt.classList.remove('hidden'); uploadPrompt.style.display = 'block'; }
          if (uploadTitle) uploadTitle.style.display = 'block';
          if (personUploadInner) { personUploadInner.classList.remove('hidden'); personUploadInner.style.display = 'block'; }
          // Recreate camera SVG if it was removed by the browser/logic
          try { ensureUploadPromptSVG(); } catch(_) {}

          // Fade-in the texts
          if (uploadPrompt) uploadPrompt.style.opacity = '0';
          if (uploadTitle) uploadTitle.style.opacity = '0';
          if (personUploadInner) personUploadInner.style.opacity = '0';
          setTimeout(() => {
            if (uploadPrompt) uploadPrompt.style.transition = 'opacity 0.6s ease-in', uploadPrompt.style.opacity = '1';
            if (uploadTitle) uploadTitle.style.transition = 'opacity 0.6s ease-in', uploadTitle.style.opacity = '1';
            if (personUploadInner) personUploadInner.style.transition = 'opacity 0.6s ease-in', personUploadInner.style.opacity = '1';
          }, 50);
        }, 800);
      } catch (_) {}
    }

    function openTryOnUI() {}

    // Keep arrows/layout consistent across viewport & interactions (parity helpers)
    function applyTryOnLayout() {
      const modelUploadSection = document.getElementById('modelUploadSection');
      const modal = document.getElementById('productModal');
      const modalContent = document.querySelector('.modal-content');
      const productImage = document.getElementById('modalProductImage');
      const tryOnArrows = document.getElementById('tryOnArrows');
      if (!modelUploadSection || !modal || !modalContent) return;

      const isMobile = window.innerWidth <= 768;
      modalContent.classList.remove('try-on-swipe-up', 'try-on-container-fadeout');
      modelUploadSection.classList.remove('scroll-up');
      modelUploadSection.style.opacity = '';

      if (isMobile) {
        if (tryOnArrows) tryOnArrows.classList.remove('show');
        modalContent.style.opacity = '';
        modalContent.style.pointerEvents = '';
        modalContent.classList.add('try-on-swipe-up');
        if (productImage) { productImage.style.opacity = '1'; }
        requestAnimationFrame(() => {
          modelUploadSection.classList.add('show', 'scroll-up');
          modelUploadSection.style.opacity = '1';
        });
      } else {
        if (window.tryOnActive && tryOnArrows) tryOnArrows.classList.add('show');
        modelUploadSection.classList.add('show');
        modelUploadSection.style.opacity = '1';
      }
    }

    function ensureTryOnConsistency() {
      if (!window.tryOnActive) return;
      const isMobile = window.innerWidth <= 768;
      const arrows = document.getElementById('tryOnArrows');
      if (arrows) {
        if (isMobile) arrows.classList.remove('show'); else arrows.classList.add('show');
      }
      try { positionArrowsBetween(); } catch(_) {}
    }

    // Position the upload panel to the right (match leather_jackets: 65% viewport X, centered Y)
    function positionUploadNextToModal() {}

    // Center the arrows between product image and upload panel (match leather_jackets)
    function positionArrowsBetween() {
      try {
        const arrows = document.getElementById('tryOnArrows');
        if (!arrows) return;
        const upload = document.getElementById('modelUploadSection');
        const floating = document.getElementById('floatingProductImage');
        const productImage = document.getElementById('modalProductImage');
        if (!upload) return;

        const sourceRect = (floating || productImage)?.getBoundingClientRect?.();
        const targetRect = upload.getBoundingClientRect();
        if (!sourceRect || !targetRect) return;

        // Bias toward the product side so arrows sit more to the left within the gap
        const gapLeft = sourceRect.right;
        const gapRight = targetRect.left;
        const gapWidth = gapRight - gapLeft;
        const bias = 0.18; // 18% from product toward upload (even further left)
        const posX = gapWidth > 0 ? (gapLeft + gapWidth * bias) : ((gapLeft + gapRight) / 2);
        const posY = (sourceRect.top + sourceRect.bottom + targetRect.top + targetRect.bottom) / 4;

        arrows.style.left = posX + 'px';
        arrows.style.top = posY + 'px';
        arrows.style.transform = 'translate(-50%, -50%)';
      } catch(_) {}
    }

    // Explicitly position the product image on desktop (match leather_jackets: 25% of modal width from left, centered vertically)
    function positionProductImage() {}

    // Try-on helper stubs to mirror leather_jackets usage
    function restoreTryOnSceneForResume() {
      try {
        const fadeOutEls = document.querySelectorAll('.fade-out-element');
        fadeOutEls.forEach(el => el.classList.add('hidden'));
      } catch(_) {}
      // Ensure we present the same layout as initial try-on while resuming mid-load
      try { window.tryOnActive = true; } catch(_) {}
      try {
        const modalContent = document.querySelector('.modal-content');
        if (modalContent) {
          if (window.innerWidth <= 768) {
            modalContent.classList.add('try-on-swipe-up');
          } else {
            modalContent.classList.add('try-on-move-left');
            setTimeout(() => { try { modalContent.classList.add('try-on-container-fadeout'); } catch(_) {} }, 150);
          }
        }
      } catch(_) {}
      try { ensureFloatingProductVisible(); } catch(_) {}
      try { showProcessingFullScreen(); } catch(_) {}
      // Restore snapshot of overlay text/subtext/progress so visuals match exactly
      try {
        const key = (typeof getCurrentProductKey === 'function') ? getCurrentProductKey() : '';
        const snapStr = key ? localStorage.getItem('tryon:ui:' + key) : null;
        const snap = snapStr ? JSON.parse(snapStr) : null;
        if (snap && typeof snap.progress === 'number') {
          updateProcessing(snap.text || 'Processing...', snap.subtext || '', Math.max(0, Math.min(100, snap.progress)));
        }
      } catch(_) {}
    }
    function showModelUpload() { try { document.getElementById('modelUploadSection')?.classList.add('show'); } catch(_) {} }
    function ensureFloatingProductVisible() {
      try {
        const modal = document.getElementById('productModal');
        const productImage = document.getElementById('modalProductImage');
        if (!productImage) return;
        // Make sure modal is visible enough to compute layout on resume
        if (modal) { modal.style.display = 'flex'; modal.style.opacity = '1'; }

        let floating = document.getElementById('floatingProductImage');
        const modalRect = (document.getElementById('productModal') || document.body).getBoundingClientRect();
        if (!floating) {
          // Create a floating clone like the initial try-on animation
          const imageRect = productImage.getBoundingClientRect();
          floating = productImage.cloneNode(true);
          floating.id = 'floatingProductImage';
          floating.style.position = 'fixed';
          floating.style.left = imageRect.left + 'px';
          floating.style.top = imageRect.top + 'px';
          floating.style.width = imageRect.width + 'px';
          floating.style.height = imageRect.height + 'px';
          floating.style.zIndex = '1003';
          floating.style.transition = 'all 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
          floating.style.borderRadius = '15px';
          floating.style.boxShadow = '0 8px 32px rgba(0, 0, 0, 0.15)';
          floating.style.objectFit = 'contain';
          document.body.appendChild(floating);
        }

        // Hide the original product image to avoid double rendering
        productImage.style.opacity = '0';
        productImage.style.visibility = 'hidden';

        // Position to the left side of the modal, vertically centered (desktop)
        if (window.innerWidth > 768) {
          let targetWidth = 300;
          let leftX = modalRect.left + modalRect.width * 0.25;
          const centerY = modalRect.top + modalRect.height / 2;
          try {
            const productName = (document.getElementById('modalProductName')?.textContent || '').trim();
            if (/^(Midnight Marcher|Rose Rebel)$/i.test(productName)) {
              targetWidth = 340; leftX -= 20;
              try {
                const upload = document.getElementById('modelUploadSection');
                if (upload) upload.style.left = '68%';
              } catch(_) {}
            }
          } catch(_) {}
          floating.style.left = leftX + 'px';
          floating.style.top = centerY + 'px';
          floating.style.width = targetWidth + 'px';
          floating.style.height = 'auto';
          floating.style.transform = 'translate(0, -50%)';
        } else {
          // On mobile, keep centered; the swipe-up layout handles the rest
          floating.style.left = '50%';
          floating.style.top = '45%';
          floating.style.transform = 'translate(-50%, -50%)';
        }
      } catch(_) {}
    }
    function showProcessingFullScreen() {
      try {
        const ov = document.getElementById('processingOverlayLocal');
        if (!ov) return;
        try { allowProcessingOverlay = true; } catch(_) {}
        if (ov.parentElement !== document.body) { try { document.body.appendChild(ov); } catch(_) {} }
        ov.classList.add('show');
        // Clear any prior inline hides applied during close, then force visible
        ov.style.display = 'flex';
        ov.style.opacity = '1';
        ov.style.pointerEvents = 'auto';
        // Ensure spinner animation restarts on resume
        try {
          const sp = ov.querySelector('.processing-spinner');
          if (sp) {
            const clone = sp.cloneNode(true);
            sp.replaceWith(clone);
          }
        } catch(_) {}
      } catch(_) {}
    }

    // Hook modal open to remember product
    // keep modal open behavior unchanged

    // Ensure try-on framework is fully reset
    function resetTryOnUI() {
      try { window.tryOnActive = false; } catch(_) {}
      try { const a = document.getElementById('tryOnArrows'); if (a) a.classList.remove('show'); } catch(_) {}
      try {
        const modelUploadSection = document.getElementById('modelUploadSection');
        if (modelUploadSection) {
          modelUploadSection.classList.remove('show','scroll-up');
          modelUploadSection.style.opacity = '';
          modelUploadSection.style.display = '';
        }
      } catch(_) {}
      try {
        const floating = document.getElementById('floatingProductImage');
        if (floating) floating.remove();
      } catch(_) {}
      try {
        const modalContent = document.querySelector('.modal-content');
        if (modalContent) {
          modalContent.classList.remove('try-on-swipe-up','try-on-container-fadeout','try-on-move-left','modal-content-hidden');
          modalContent.style.opacity = '';
          modalContent.style.pointerEvents = '';
        }
      } catch(_) {}
      try {
        const originalImage = document.getElementById('modalProductImage');
        if (originalImage) { originalImage.style.opacity = '1'; originalImage.style.visibility = ''; }
      } catch(_) {}
      try {
        const upload = document.getElementById('modelUploadSection');
        if (upload && window.innerWidth > 768) { upload.style.left = '65%'; }
      } catch(_) {}
      try {
        const ov = document.getElementById('processingOverlayLocal');
        if (ov) { ov.classList.remove('show'); ov.style.opacity=''; ov.style.pointerEvents=''; }
      } catch(_) {}
    }

    // Try On click → show upload UI with per-product resume
    // Try-on trigger removed

    // Upload interactions removed

    // Processing overlay helpers (parity with leather_jackets)
    let allowProcessingOverlay = true;
    function getOverlayAnchor() {
      try {
        const personImg = document.getElementById('personPhotoPreview');
        if (personImg && personImg.src) return personImg;
        const uploadArea = document.getElementById('personUploadArea');
        if (uploadArea) return uploadArea;
        const floating = document.getElementById('floatingProductImage');
        if (floating) return floating;
        return document.getElementById('modalProductImage');
      } catch(_) { return null; }
    }
    function positionOverlayToArea(overlayEl) {
      try {
        if (!overlayEl) return;
        const anchor = getOverlayAnchor();
        if (!anchor) { return; }
        const rect = anchor.getBoundingClientRect();
        const vw = Math.max(document.documentElement.clientWidth || 0, window.innerWidth || 0);
        const vh = Math.max(document.documentElement.clientHeight || 0, window.innerHeight || 0);
        const left = Math.max(0, Math.min(rect.left, vw));
        const top = Math.max(0, Math.min(rect.top, vh));
        const width = Math.min(rect.width, vw);
        const height = Math.min(rect.height, vh);
        overlayEl.style.position = 'fixed';
        overlayEl.style.left = left + 'px';
        overlayEl.style.top = top + 'px';
        overlayEl.style.width = width + 'px';
        overlayEl.style.height = height + 'px';
      } catch(_) {}
    }
    function showProcessing(text, subtext, progress) {
      try {
        if (!allowProcessingOverlay) return;
        const ov = document.getElementById('processingOverlayLocal');
        if (!ov) return;
        // Reparent to body and anchor to area only when UI is active
        if (ov.parentElement !== document.body) { try { document.body.appendChild(ov); } catch(_) {} }
        if (window.tryOnActive) {
          positionOverlayToArea(ov);
          ov.classList.add('show');
          ov.style.display = 'flex';
          ov.style.opacity = '1';
          ov.style.pointerEvents = 'auto';
        }
        // Text + progress
        const p1 = document.getElementById('processingPrimary') || document.getElementById('processingTextLocal');
        const p2 = document.getElementById('processingSecondary') || document.getElementById('processingSubtextLocal');
        const pf = document.getElementById('progressFill') || document.getElementById('progressFillLocal');
        if (p1 && text) p1.textContent = text;
        if (p2 && typeof subtext === 'string') p2.textContent = subtext;
        if (pf && typeof progress === 'number') pf.style.width = Math.max(0, Math.min(100, progress)) + '%';
        // Persist UI snapshot for exact visual restoration on resume mid-load
        try {
          const key = (typeof getCurrentProductKey === 'function') ? getCurrentProductKey() : '';
          if (key && typeof progress === 'number') {
            const snap = {
              text: text || (p1 && p1.textContent) || 'Processing...',
              subtext: (typeof subtext === 'string') ? subtext : (p2 && p2.textContent) || '',
              progress: Math.max(0, Math.min(100, progress))
            };
            saveUISnap(key, snap);
          }
        } catch(_) {}
      } catch(_) {}
    }
    function updateProcessing(text, subtext, progress) {
      try {
        if (!allowProcessingOverlay) return;
        const ov = document.getElementById('processingOverlayLocal');
        if (!ov) return;
        if (window.tryOnActive) {
          positionOverlayToArea(ov);
          ov.classList.add('show');
          ov.style.display = 'flex';
          ov.style.opacity = '1';
          ov.style.pointerEvents = 'auto';
        }
        const p1 = document.getElementById('processingPrimary') || document.getElementById('processingTextLocal');
        const p2 = document.getElementById('processingSecondary') || document.getElementById('processingSubtextLocal');
        const pf = document.getElementById('progressFill') || document.getElementById('progressFillLocal');
        if (p1 && text) p1.textContent = text;
        if (p2 && typeof subtext === 'string') p2.textContent = subtext;
        if (pf && typeof progress === 'number') pf.style.width = Math.max(0, Math.min(100, progress)) + '%';
        // Persist on every update so resume has most recent values
        try {
          const key = (typeof getCurrentProductKey === 'function') ? getCurrentProductKey() : '';
          if (key && typeof progress === 'number') {
            saveUISnap(key, {
              text: text || (p1 && p1.textContent) || 'Processing...',
              subtext: (typeof subtext === 'string') ? subtext : (p2 && p2.textContent) || '',
              progress: Math.max(0, Math.min(100, progress))
            });
          }
        } catch(_) {}
      } catch(_) {}
    }
    function hideProcessing() {
      try {
        const ov = document.getElementById('processingOverlayLocal');
        if (!ov) return;
        ov.classList.remove('show');
        ov.style.opacity = '';
        ov.style.pointerEvents = '';
        ov.style.display = 'none';
        ov.style.position = '';
        ov.style.zIndex = '';
        ov.style.left = '';
        ov.style.top = '';
        ov.style.width = '';
        ov.style.height = '';
      } catch(_) {}
    }

    // Simple API handler
    /* Removed API handler */
    class FashnAPIHandler {
      constructor(apiKey) {
        this.apiKey = apiKey;
        this.baseURL = 'https://api.fashn.ai/v1';
      }
      async makeRequest(endpoint, options = {}) {
        const res = await fetch(this.baseURL + endpoint, {
          headers: { 'Authorization': `Bearer ${this.apiKey}`, 'Content-Type': 'application/json', ...(options.headers||{}) },
          method: options.method || 'GET',
          body: options.body
        });
        if (!res.ok) throw new Error('HTTP ' + res.status);
        return res.json();
      }
      async startProductToModel(productImage, modelImage = null) {
        const inputs = { 
          product_image: productImage,
          output_format: "png",
          return_base64: false
        };
        if (modelImage) inputs.model_image = modelImage;
      
        const payload = { model_name: 'product-to-model', inputs };
        const r = await this.makeRequest('/run', { method: 'POST', body: JSON.stringify(payload) });
        return r.id;
      }
      // Parity wrapper with leather_jackets: startTryOn using tryon-v1.6
      async startTryOn(modelImage, garmentImage, options = {}) {
        const requestData = {
          model_name: options.modelVersion || 'tryon-v1.6',
          inputs: {
            model_image: modelImage,
            garment_image: garmentImage,
            category: options.category || 'auto',
            segmentation_free: options.segmentationFree !== false,
            moderation_level: options.moderationLevel || 'conservative'
          }
        };
        const result = await this.makeRequest('/run', { method: 'POST', body: JSON.stringify(requestData) });
        return result.id;
      }
      
      async status(id) { return this.makeRequest('/status/' + id); }
      delay(ms) { return new Promise(r => setTimeout(r, ms)); }
      async waitForResult(id, onProgress, deadlineAt = null) {
        const started = performance.now();
        const MAX_ATTEMPTS = 200;
        let attempt = 0;
        while (true) {
          attempt++;
          const now = performance.now();
          if (deadlineAt && now >= deadlineAt) return { success: false, error: 'SLA exceeded (15s)', metadata: { status: 'timeout', attempts: attempt } };
          try {
            const st = await this.status(id);
            if (onProgress) {
              const elapsed = now - started;
              const est = Math.min(0.98, elapsed / 14000);
              onProgress({ status: st.status, progress: typeof st.progress === 'number' ? st.progress : est });
            }
            if (st.status === 'completed') return { success: true, output: st.output, metadata: st };
            if (st.status === 'failed') return { success: false, error: st.error || 'failed', metadata: st };
          } catch(_) {}
          const elapsed = performance.now() - started;
          const wait = elapsed < 10000 ? 700 : 1200;
          await this.delay(wait);
          if (attempt >= MAX_ATTEMPTS) return { success: false, error: 'Timeout waiting for result', metadata: null };
        }
      }
      async processTryOn(modelImage, garmentImage, options = {}) {
        try {
          const predictionId = await this.startTryOn(modelImage, garmentImage, options);
          const result = await this.waitForResult(predictionId, options.onProgress, options.deadlineAt);
          return result;
        } catch (error) {
          return { success: false, error: error.message, metadata: null };
        }
      }
      async optimizeImage(dataUrl, max=1536) {
        return new Promise((resolve, reject) => {
          const img = new Image();
          img.onload = () => {
            let w = img.width, h = img.height;
            if (w>max || h>max) { if (w>h) { h = Math.round(h*max/w); w=max; } else { w=Math.round(w*max/h); h=max; } }
            const c = document.createElement('canvas'); c.width=w; c.height=h;
            c.getContext('2d').drawImage(img,0,0,w,h);
            resolve(c.toDataURL('image/jpeg', 0.92));
          };
          img.onerror = reject; img.src = dataUrl;
        });
      }
    }

    const FASHN_API_KEY = 'fa-BWEKaWHoO0YD-KDW0kUKgK6eEPOzgKh0M1oC0';
    // Instantiate API clients (alias retained for resumePrediction parity)
    const fashn = new FashnAPIHandler(FASHN_API_KEY);
    const fashnAPI = new FashnAPIHandler(FASHN_API_KEY);
    // Lightweight helpers to call FASHN.AI directly (product-to-model) with timeout + nice errors
    const API_BASE = 'https://api.fashn.ai/v1';
    const DEFAULT_TIMEOUT_MS = 45000; // restore default run timeout
    function parseJSONSafe(text) { try { return JSON.parse(text); } catch { return null; } }
    function pickErrMessage(obj, fallback) {
      if (!obj) return fallback || 'Request failed';
      try { return obj.message || obj.error || obj.detail || fallback || JSON.stringify(obj); } catch(_) { return fallback || 'Request failed'; }
    }
    async function fetchWithTimeout(url, opts = {}, timeoutMs = DEFAULT_TIMEOUT_MS) {
      const useTimeout = typeof timeoutMs === 'number' && timeoutMs > 0 && Number.isFinite(timeoutMs);
      const ctrl = useTimeout ? new AbortController() : null;
      const to = useTimeout ? setTimeout(() => ctrl.abort(), timeoutMs) : null;
      try {
        const res = await fetch(url, ctrl ? { ...opts, signal: ctrl.signal } : opts);
        const raw = await res.text();
        const data = parseJSONSafe(raw) ?? raw;
        if (!res.ok) throw new Error(pickErrMessage(data, `HTTP ${res.status}`));
        return data;
      } finally { if (to) clearTimeout(to); }
    }
    async function apiRun(body) {
      return fetchWithTimeout(`${API_BASE}/run`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${FASHN_API_KEY}`
        },
        body: JSON.stringify(body)
      });
    }
    async function apiStatus(id) {
      return fetchWithTimeout(`${API_BASE}/status/${id}`, {
        headers: { 'Authorization': `Bearer ${FASHN_API_KEY}` }
      }, 60000);
    }
    
    // ---- helpers to turn local images into base64 data URLs (works with file://) ----
    async function fileToDataURL(file) {
      if (!file) return null;
      const reader = new FileReader();
      return await new Promise((resolve, reject) => {
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }
    async function urlToDataURL(url) {
      const res = await fetch(url);
      if (!res.ok) throw new Error('fetch ' + res.status);
      const blob = await res.blob();
      return await fileToDataURL(blob);
    }
    // ---- nicer error text for your toast ----
    function toNiceError(err) {
      try {
        if (typeof err === 'string') return err;
        if (err && err.message) return err.message;
        if (err && err.error && err.error.message) return err.error.message;
        return JSON.stringify(err);
      } catch (_) { return 'Unknown error'; }
    }

    function fileToBase64(file) { return new Promise((res, rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file); }); }
    // Light enhancement to improve segmentation
    async function enhanceForSegmentation(imageDataURL) {
      return new Promise((resolve) => {
        try {
          const img = new Image();
          img.decoding = 'async';
          img.onload = () => {
            const maxDim = 1024;
            let w = img.width, h = img.height;
            if (w > h && w > maxDim) { h = Math.round(h * maxDim / w); w = maxDim; }
            else if (h >= w && h > maxDim) { w = Math.round(w * maxDim / h); h = maxDim; }
            const cnv = document.createElement('canvas'); cnv.width = w; cnv.height = h;
            const ctx = cnv.getContext('2d');
            ctx.filter = 'contrast(1.12) brightness(1.05) saturate(1.04)';
            ctx.drawImage(img, 0, 0, w, h);
            resolve(cnv.toDataURL('image/jpeg', 0.9));
          };
          img.onerror = () => resolve(imageDataURL);
          img.src = imageDataURL;
        } catch(_) { resolve(imageDataURL); }
      });
    }

    async function ensureResultImageReady(url) {
      if (!url) return url;
      try {
        const img = new Image();
        img.decoding = 'sync'; img.loading = 'eager';
        img.src = url;
        if (img.decode) await img.decode().catch(()=>{});
      } catch(_) {}
      return url;
    }

    // ---- Watermark helpers (parity with leather_jackets) ----
    function ensureWatermarkInContainer(containerEl) {
      if (!containerEl) return null;
      if (getComputedStyle(containerEl).position === 'static') {
        containerEl.style.position = 'relative';
      }
      let wm = containerEl.querySelector('.fitrite-watermark');
      if (!wm) {
        wm = document.createElement('div');
        wm.className = 'fitrite-watermark';
        wm.innerHTML = '<div class="fit-line"></div>FITRITE';
        containerEl.appendChild(wm);
      }
      // Hide until positioned to avoid any flash outside the image
      try { wm.style.visibility = 'hidden'; } catch(_) {}
      return wm;
    }
    function positionWatermarkForImage(imgEl, containerEl, wmEl) {
      try {
        if (!imgEl || !containerEl || !wmEl) return;
        const imgRect = imgEl.getBoundingClientRect();
        const hostRect = containerEl.getBoundingClientRect();
        const margin = 14;
        const rightOffset = Math.max(0, (hostRect.right - imgRect.right) + margin);
        const bottomOffset = Math.max(0, (hostRect.bottom - imgRect.bottom) + margin);
        wmEl.style.position = 'absolute';
        wmEl.style.left = '';
        wmEl.style.top = '';
        wmEl.style.right = rightOffset + 'px';
        wmEl.style.bottom = bottomOffset + 'px';
        wmEl.style.transform = '';
        wmEl.style.visibility = 'visible';
      } catch(_) {}
    }
    function bindWatermarkToImage(imgEl, containerEl) {
      const wm = ensureWatermarkInContainer(containerEl);
      const handler = () => positionWatermarkForImage(imgEl, containerEl, wm);
      try {
        if (imgEl && (imgEl.complete || imgEl.naturalWidth)) {
          setTimeout(handler, 0);
        } else if (imgEl) {
          imgEl.addEventListener('load', handler, { once: true });
        }
        window.addEventListener('resize', handler, { passive: true });
        const ResizeObs = window.ResizeObserver || null;
        if (ResizeObs && imgEl) {
          try { new ResizeObs(() => handler()).observe(imgEl); } catch(_) {}
        }
      } catch(_) {}
      return handler;
    }

    function getCurrentProductKey() {
      try {
        const name = (document.getElementById('modalProductName')?.textContent || '').trim();
        const img = document.getElementById('modalProductImage')?.src || '';
        return encodeURIComponent('footwear|' + name + '|' + img);
      } catch (_) { return ''; }
    }
    function loadJob(key) { try { return JSON.parse(localStorage.getItem('tryon:job:' + key) || 'null'); } catch(_) { return null; } }
    function saveJob(key, job) { try { localStorage.setItem('tryon:job:' + key, JSON.stringify(job)); } catch(_) {} }
    function clearJob(key) { try { localStorage.removeItem('tryon:job:' + key); } catch(_) {} }
    // Snapshot helpers for overlay UI state (text, subtext, progress)
    function loadUISnap(key) { try { return JSON.parse(localStorage.getItem('tryon:ui:' + key) || 'null'); } catch(_) { return null; } }
    function saveUISnap(key, snap) { try { localStorage.setItem('tryon:ui:' + key, JSON.stringify(snap)); } catch(_) {} }
    function clearUISnap(key) { try { localStorage.removeItem('tryon:ui:' + key); } catch(_) {} }

    async function getCurrentProductImageFile() {
      const productImage = document.getElementById('modalProductImage');
      if (!productImage || !productImage.src) throw new Error('No product image');
      try {
        const proxy = `https://api.allorigins.win/raw?url=${encodeURIComponent(productImage.src)}`;
        const resp = await fetch(proxy);
        if (resp.ok) {
          const blob = await resp.blob();
          return new File([blob], 'product.jpg', { type: blob.type || 'image/jpeg' });
        }
      } catch(_) {}
      const resp2 = await fetch(productImage.src);
      const blob2 = await resp2.blob();
      return new File([blob2], 'product.jpg', { type: blob2.type || 'image/jpeg' });
    }

    function showResultInPlace(url) {
      hasProcessingCompleted = true;
      hideProcessing();
      const wrap = document.getElementById('resultInPlace');
      const img = document.getElementById('resultImageInPlace');
      const back = document.getElementById('resultBackBtn');
      if (img) img.src = url;
      if (wrap) wrap.classList.add('show');
      if (back) back.classList.add('show');
      try { if (img && wrap) bindWatermarkToImage(img, wrap); } catch(_) {}
      try { localStorage.setItem(RESULT_STORAGE_KEY, url); } catch(_) {}
      // Also show final screen like leather_jackets
      try { showFinalResultScreen(url); } catch(_) {}
    }

    async function startTryOn() {
      try {
        // 1) gather inputs
        const modelFile = window.personFile;
        const productImageUrl = document.getElementById('modalProductImage')?.src;
        if (!modelFile || !productImageUrl) { showToast('Add your photo and open a product first.'); return; }

        // 2) show overlay/progress
        hasActivatedAI = true; isProcessing = true;
        // Match leather_jackets messaging cadence
        showProcessing('Connecting to AI servers', 'Starting AI processing...', 10);
        try { fetch('https://api.fashn.ai/v1/', { mode:'no-cors', keepalive: true }); } catch(_) {}

        // 3) convert model file to data URL
        const modelAsDataURL = await new Promise((res, rej) => { const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(modelFile); });

        // 4) start Product-to-Model (convert garment to data URL when possible to avoid file:// issues)
        let garmentData = null; try { garmentData = (function(){ const el=document.getElementById('modalProductImage'); if(!el) return null; const c=document.createElement('canvas'); const w=el.naturalWidth||el.width||0; const h=el.naturalHeight||el.height||0; if(!w||!h) return null; c.width=w; c.height=h; c.getContext('2d').drawImage(el,0,0); return c.toDataURL('image/jpeg',0.92); })(); } catch(_) {}
        const jobId = await fashn.startProductToModel(garmentData || productImageUrl, modelAsDataURL);

        // 5) poll status
        let doneUrl = null, pct = 15;
        while (!doneUrl) {
          await fashn.delay(1200);
          pct = Math.min(95, pct + 7);
          updateProcessing('Processing...', 'Generating preview…', pct);
          const s = await fashn.status(jobId);
          if (s?.status === 'succeeded' && s.output?.image_url) { doneUrl = s.output.image_url; break; }
          if (s?.status === 'failed') throw new Error(s.error || 'Generation failed');
        }

        // 6) show result
        hideProcessing();
        isProcessing = false; hasProcessingCompleted = true;
        showFinalResultScreen(doneUrl);
      } catch (err) {
        isProcessing = false;
        hideProcessing();
        const msg = err && err.message ? err.message : (typeof err === 'string' ? err : JSON.stringify(err));
        showToast('AI try-on failed: ' + msg);
      }
    }

    // Product-to-Model footwear starter
    // ---------- Robust footwear try-on (no localhost fetches; resilient parsing) ----------
    async function urlToBase64(src) {
      const r = await fetch(src, { credentials: 'omit' });
      if (!r.ok) throw new Error(`Fetch product image failed: HTTP ${r.status}`);
      const b = await r.blob();
      return await new Promise((res, rej) => { const fr = new FileReader(); fr.onload = () => res(fr.result); fr.onerror = rej; fr.readAsDataURL(b); });
    }
    async function fileToBase64(file) {
      return await new Promise((res, rej) => { const fr = new FileReader(); fr.onload = () => res(fr.result); fr.onerror = rej; fr.readAsDataURL(file); });
    }
    function pickResultURL(statusJson) {
      if (statusJson?.output_url) return statusJson.output_url;
      if (statusJson?.result_url) return statusJson.result_url;
      if (statusJson?.output?.url) return statusJson.output.url;
      if (Array.isArray(statusJson?.output)) {
        const first = statusJson.output[0];
        if (typeof first === 'string') return first;
        if (first?.url) return first.url;
        if (first?.image_url) return first.image_url;
      }
      if (Array.isArray(statusJson?.result?.images) && statusJson.result.images[0]) return statusJson.result.images[0];
      const b64 = statusJson?.output_base64 || statusJson?.base64 || statusJson?.result?.base64;
      if (b64) return 'data:image/png;base64,' + b64.replace(/^data:image\/\w+;base64,/, '');
      return null;
    }
    async function pollStatusUntilDone(predictionId, onProgress, timeoutMs = 180000) {
      const t0 = Date.now();
      let lastPct = 0;
      while (true) {
        const sRes = await fetch(`${API_BASE}/status/${encodeURIComponent(predictionId)}`, { headers: { 'Authorization': `Bearer ${FASHN_API_KEY}` } });
        let s; try { s = await sRes.json(); } catch { s = null; }
        const pct = typeof s?.progress === 'number' ? Math.round(s.progress * 100) : Math.min(95, lastPct + 4); lastPct = pct;
        onProgress?.(s, pct);
        const st = (s?.status || '').toLowerCase();
        if (st === 'completed' || st === 'succeeded') return s;
        if (st === 'failed' || st === 'error' || st === 'canceled') throw new Error(s?.error || s?.message || JSON.stringify(s));
        if (Date.now() - t0 > timeoutMs) throw new Error('Timed out waiting for AI result');
        await new Promise(r => setTimeout(r, 1500));
      }
    }

    async function startFootwearProductToModel() {
      try {
        // Ensure try-on scene is treated as active so the loader is allowed to show
        try { window.tryOnActive = true; } catch(_) {}
        try { allowProcessingOverlay = true; } catch(_) {}
        showProcessing('Processing…', 'Submitting job to AI', 8);
        window.isProcessing = true; hasActivatedAI = true;
        const personFile = window.personFile; if (!personFile) throw new Error('Please upload your photo first.');
        const prodEl = document.getElementById('modalProductImage'); if (!prodEl?.src) throw new Error('Open a product first.');
        const model_image = await fileToBase64(personFile);
        const product_image = await urlToDataURL(prodEl.src);

        updateProcessing('Processing…', 'Creating your try-on…', 18);
        const runRes = await fetch(`${API_BASE}/run`, { method: 'POST', headers: { 'Authorization': `Bearer ${FASHN_API_KEY}`, 'Content-Type': 'application/json' }, body: JSON.stringify({ model_name: 'product-to-model', inputs: { product_image, model_image, output_format: 'png', return_base64: false } }) });
        if (!runRes.ok) throw new Error(`Run failed: HTTP ${runRes.status} ${await runRes.text()}`);
        const run = await runRes.json(); if (!run?.id) throw new Error('No prediction id returned');
        try {
          const key = getCurrentProductKey();
          if (key) saveJob(key, { status: 'inflight', predictionId: run.id });
        } catch(_) {}

        const status = await pollStatusUntilDone(run.id, (s, pct)=> updateProcessing('Generating try-on preview…', (s?.status||'processing'), Math.max(20, pct)), 180000);
        try { const key = getCurrentProductKey(); if (key) saveJob(key, { status: 'done', resultUrl: pickResultURL(status) }); } catch(_) {}
        const resultUrl = pickResultURL(status); if (!resultUrl) throw new Error('Finished but no image URL/base64 returned');

        hideProcessing(); window.isProcessing = false; hasProcessingCompleted = true;
        try {
          // Leather jackets: show inline first, then full-screen
          const container = document.getElementById('resultInPlace');
          const resultImg = document.getElementById('resultImageInPlace');
          if (container && resultImg) {
            resultImg.src = resultUrl;
            container.style.display = 'block';
            container.classList.add('show');
          }
          // brief delay to mirror LJ flow before opening final
          setTimeout(()=>{ try { showFinalResultScreen(resultUrl); } catch(_) {} }, 400);
        } catch (_) { try { showFinalResultScreen(resultUrl); } catch(_) {} }
      } catch (err) {
        hideProcessing(); window.isProcessing = false; hasActivatedAI = false;
        showToast('AI try-on failed: ' + (err?.message || String(err)));
        try { console.error(err); } catch(_) {}
      }
    }

    async function resumePrediction(job) {
      try {
        try { allowProcessingOverlay = true; } catch(_) {}
        try { showProcessingFullScreen(); } catch(_) {}
        const SLA_MS = 45000; const deadlineAt = performance.now() + SLA_MS;
        const result = await fashnAPI.waitForResult(job.predictionId, (p)=>{
          const pct = 30 + (Math.min(0.98, p.progress||0)*60);
          updateProcessing('Processing...', p.status||'', Math.round(pct));
        }, deadlineAt);
        if (result && result.success && Array.isArray(result.output) && result.output[0]) {
          const url = result.output[0];
          try { const key = getCurrentProductKey(); if (key) saveJob(key, { status: 'done', resultUrl: url }); } catch(_) {}
          // Clear any persisted UI snapshot now that we have a result
          try { const key = (typeof getCurrentProductKey === 'function') ? getCurrentProductKey() : ''; if (key) clearUISnap(key); } catch(_) {}
          await ensureResultImageReady(url);
          hideProcessing();
          showResultInPlace(url);
          try { showFinalResultScreen(url); } catch(_) {}
          // Do not clear saved job; keep it to restore on reopen
        } else {
          hideProcessing(); showToast('Processing failed. Please try again.');
          try { const key = getCurrentProductKey(); if (key) { clearJob(key); clearUISnap(key); } } catch(_) {}
        }
      } catch(_) {
        hideProcessing(); showToast('Processing error. Please try again.');
        try { const key = getCurrentProductKey(); if (key) { clearJob(key); clearUISnap(key); } } catch(_) {}
      } finally { isProcessing = false; }
    }

    // Removed continue/result handlers

    // Consistent hide of inline try-on result (parity with leather_jackets)
    function hideResultInPlace() {
      try {
        const resultInPlace = document.getElementById('resultInPlace');
        const resultImg = document.getElementById('resultImageInPlace');
        const resultBackBtn = document.getElementById('resultBackBtn');
        const resultActionsExternal = document.getElementById('resultActionsExternal');
        const personPhotoPreview = document.getElementById('personPhotoPreview');

        if (resultInPlace) { resultInPlace.classList.remove('show'); resultInPlace.style.display = 'none'; }
        if (resultBackBtn) { resultBackBtn.classList.remove('show'); resultBackBtn.style.display = 'none'; }
        if (resultActionsExternal) { resultActionsExternal.classList.remove('show'); resultActionsExternal.style.display = 'none'; }
        if (resultImg) { resultImg.src = ''; }
        if (personPhotoPreview) { personPhotoPreview.classList.remove('fade-out'); }

        try { if (typeof ensureExecuteAIButtonVisible === 'function') ensureExecuteAIButtonVisible(); } catch(_) {}

        setTimeout(() => {
          try {
            if (window.personFile && personPhotoPreview) {
              personPhotoPreview.classList.add('show');
            }
          } catch(_) {}
        }, 100);
      } catch(_) {}
    }

    function showFinalResultScreen(resultUrl) {
      const finalResultScreen = document.getElementById('finalResultScreen');
      const finalResultImage = document.getElementById('finalResultImage');
      const modal = document.getElementById('productModal');
      const modelUploadSection = document.getElementById('modelUploadSection');
      const floatingImage = document.getElementById('floatingProductImage');
      const tryOnArrows = document.getElementById('tryOnArrows');
      const modalContent = document.querySelector('.modal-content');
      const modalProductImageEl = document.getElementById('modalProductImage');
      const resultInPlace = document.getElementById('resultInPlace');
      const resultBackBtn = document.getElementById('resultBackBtn');
      const resultActionsExternal = document.getElementById('resultActionsExternal');
      const personPhotoPreview = document.getElementById('personPhotoPreview');

      if (resultUrl) { window.resultImageUrl = resultUrl; }
      if (finalResultImage) finalResultImage.src = window.resultImageUrl || '';

      try { hideResultInPlace(); } catch(_) {}
      if (personPhotoPreview) personPhotoPreview.classList.add('fade-out');
      if (modalProductImageEl) { modalProductImageEl.style.transition = 'opacity 300ms ease'; modalProductImageEl.style.opacity = '0'; }
      if (modalContent) modalContent.classList.remove('try-on-swipe-up', 'try-on-container-fadeout');

      if (modal) { modal.style.transition = 'opacity 1s ease-out'; }
      if (modelUploadSection) { modelUploadSection.style.transition = 'opacity 1s ease-out'; }
      if (floatingImage) { floatingImage.style.transition = 'opacity 1s ease-out'; floatingImage.style.opacity = '0'; }
      if (tryOnArrows) { tryOnArrows.classList.remove('show'); }
      try {
        if (modal) modal.style.opacity = '0';
        if (modelUploadSection) modelUploadSection.style.opacity = '0';
        setTimeout(() => {
          try { if (modal) modal.style.display = 'none'; } catch(_) {}
          try { if (modelUploadSection) modelUploadSection.style.display = 'none'; } catch(_) {}
          try { if (floatingImage) floatingImage.style.display = 'none'; } catch(_) {}
          try {
            if (finalResultScreen) {
              finalResultScreen.style.position = 'fixed';
              finalResultScreen.style.top = '0';
              finalResultScreen.style.left = '0';
              finalResultScreen.style.width = '100%';
              finalResultScreen.style.height = '100%';
              finalResultScreen.style.display = 'flex';
              finalResultScreen.style.alignItems = 'center';
              finalResultScreen.style.justifyContent = 'center';
              finalResultScreen.classList.add('show');
            }
          } catch(_) {}
        }, 1000);
      } catch(_) {}
      try {
        const chip = document.getElementById('aiPreviewDisclaimer');
        if (chip) {
          chip.style.display = 'block';
          chip.classList.add('show');
          setTimeout(()=> chip.classList.remove('show'), 4000);
          setTimeout(()=> { if (chip && !chip.classList.contains('show')) chip.style.display = 'none'; }, 4500);
        }
      } catch(_) {}
      // Raise final screen above all and ensure clicks are accepted
      try {
        if (finalResultScreen) {
          finalResultScreen.style.zIndex = '5001';
          finalResultScreen.style.pointerEvents = 'auto';
        }
      } catch(_) {}
      // enable image click-to-download like leather_jackets
      try {
        const finalImgForClick = document.getElementById('finalResultImage');
        if (finalImgForClick) { finalImgForClick.style.cursor = 'pointer'; finalImgForClick.onclick = downloadResult; }
        // Clamp watermark to image bounds like leather_jackets
        const wrap = document.querySelector('#finalResultScreen .final-image-wrap');
        if (wrap && finalImgForClick) bindWatermarkToImage(finalImgForClick, wrap);
      } catch(_) {}
    }

    // Match leather_jackets button behaviors
    function returnToCatalogue() {
      window.tryOnActive = false;
      try { document.getElementById('tryOnArrows').classList.remove('show'); } catch(_) {}
      const finalResultScreen = document.getElementById('finalResultScreen');
      if (finalResultScreen) { finalResultScreen.style.transition = 'opacity 1.5s ease-out'; finalResultScreen.classList.remove('show'); }

      setTimeout(() => {
        if (finalResultScreen) finalResultScreen.style.display = 'none';

        // Fade main content briefly like leather_jackets
        document.body.style.transition = 'opacity 0.8s ease-in';
        document.body.style.opacity = '0.3';

        setTimeout(() => {
          try { hideModelUpload?.(); } catch(_) {}
          try { hideResultInPlace?.(); } catch(_) {}

          // Clear uploaded photo
          try { if (window.personFile) removePersonPhoto(); } catch(_) {}

          // Reset modal
          try {
            const modal = document.getElementById('productModal');
            if (modal) { modal.style.transition = 'opacity 0.8s ease-out'; modal.style.opacity = '1'; }
            setTimeout(()=>{ try { closeModal(); } catch(_) {} }, 200);
          } catch(_) {}

          // Reset state flags and inputs and clear any saved try-on jobs so next session is first-time
          try {
            currentProductData = null; window.personFile = null; window.resultImageUrl = null;
            isProcessing = false; hasProcessingCompleted = false; hasActivatedAI = false;
            localStorage.removeItem(RESULT_STORAGE_KEY);
            // Clear all try-on job keys persisted for resume
            try {
              const keysToRemove = [];
              for (let i = 0; i < localStorage.length; i++) {
                const k = localStorage.key(i) || '';
                if (k.indexOf('tryon:job:') === 0) keysToRemove.push(k);
              }
              keysToRemove.forEach(k => { try { localStorage.removeItem(k); } catch(_) {} });
            } catch(_) {}
            const fileInput = document.getElementById('personFileInput'); if (fileInput) fileInput.value='';
          } catch(_) {}

          // Reset upload UI to initial
          try {
            const personUploadArea = document.getElementById('personUploadArea');
            const uploadContainer = document.querySelector('.upload-container');
            const personPhotoPreview = document.getElementById('personPhotoPreview');
            const removeBtn = document.getElementById('removePhotoBtn');
            const continueBtn = document.getElementById('continueBtn');
            const uploadPrompt = document.getElementById('uploadPrompt');
            const uploadTitle = document.querySelector('.upload-title');
            const personUploadInner = document.getElementById('personUploadInner');
            if (personUploadArea) personUploadArea.classList.remove('has-photo');
            if (uploadContainer) uploadContainer.classList.remove('has-photo');
            if (personPhotoPreview) { personPhotoPreview.classList.remove('show','fade-out','processing','processing-complete'); personPhotoPreview.style.display='none'; personPhotoPreview.src=''; }
            if (removeBtn) removeBtn.classList.remove('show');
            if (continueBtn) { continueBtn.classList.remove('show'); continueBtn.style.display='none'; continueBtn.disabled = true; continueBtn.classList.remove('fadeout'); }
            if (uploadPrompt) { uploadPrompt.classList.remove('hidden'); uploadPrompt.style.opacity='1'; uploadPrompt.style.display='block'; }
            if (uploadTitle) { uploadTitle.style.opacity='1'; uploadTitle.style.display='block'; }
            if (personUploadInner) { personUploadInner.classList.remove('hidden'); personUploadInner.style.opacity='1'; }
          } catch(_) {}

          // Remove floating image and reset modal content
          try { const floating = document.getElementById('floatingProductImage'); if (floating) floating.remove(); } catch(_) {}
          try { const modalContent = document.querySelector('.modal-content'); if (modalContent) modalContent.classList.remove('try-on-swipe-up','try-on-container-fadeout'); } catch(_) {}

          setTimeout(() => { document.body.style.opacity = '1'; document.body.style.transition = ''; }, 800);
        }, 200);
      }, 1500);
    }

    function downloadResult() {
      let currentUrl = '';
      try {
        const finalEl = document.getElementById('finalResultImage');
        const inPlaceEl = document.getElementById('resultImageInPlace');
        currentUrl = (finalEl && finalEl.src) || (inPlaceEl && inPlaceEl.src) || window.resultImageUrl || '';
        if (currentUrl) { window.resultImageUrl = currentUrl; }
      } catch(_) {}

      if (!currentUrl) { try { showToast('No image available to download'); } catch(_) {}; return; }

      (async () => {
        try {
          const blob = await fetch(currentUrl).then(r => { if (!r.ok) throw new Error('Failed to fetch image'); return r.blob(); });
          const imgUrl = URL.createObjectURL(blob);
          const img = new Image();
          img.decoding = 'sync';
          img.src = imgUrl;
          await (img.decode ? img.decode().catch(()=>{}) : new Promise(res => img.onload = res));

          const finalScreen = document.getElementById('finalResultScreen');
          const useFinal = finalScreen && finalScreen.classList.contains('show');
          const container = useFinal ? document.querySelector('#finalResultScreen .final-result-container') : document.getElementById('resultInPlace');
          const imgEl = useFinal ? document.getElementById('finalResultImage') : document.getElementById('resultImageInPlace');
          const wmEl = container ? container.querySelector('.fitrite-watermark') : null;
          const lineEl = wmEl ? wmEl.querySelector('.fit-line') : null;

          const cnv = document.createElement('canvas');
          cnv.width = img.naturalWidth || img.width;
          cnv.height = img.naturalHeight || img.height;
          const ctx = cnv.getContext('2d');
          ctx.drawImage(img, 0, 0, cnv.width, cnv.height);

          if (wmEl && imgEl) {
            const imgRect = imgEl.getBoundingClientRect();
            const wmRect = wmEl.getBoundingClientRect();
            const scaleX = (cnv.width) / Math.max(1, imgRect.width);
            const scaleY = (cnv.height) / Math.max(1, imgRect.height);

            const cs = getComputedStyle(wmEl);
            const fontSize = parseFloat(cs.fontSize) || 16;
            const fontWeight = cs.fontWeight || '400';
            const fontFamily = cs.fontFamily || 'Georgia, "Times New Roman", Times, serif';
            const textNode = Array.from(wmEl.childNodes).find(n => n.nodeType === Node.TEXT_NODE);
            const text = (textNode ? textNode.textContent : (wmEl.textContent || 'FITRITE')).replace(/\s+/g, ' ').trim();

            ctx.fillStyle = '#ffffff';
            ctx.textBaseline = 'bottom';
            ctx.textAlign = 'right';
            ctx.font = `${fontWeight} ${Math.max(1, fontSize * scaleY)}px ${fontFamily}`;

            const xRight = (wmRect.right - imgRect.left) * scaleX;
            const yBottom = (wmRect.bottom - imgRect.top) * scaleY;

            if (lineEl) {
              const lineRect = lineEl.getBoundingClientRect();
              const dLW = Math.max(1, lineRect.width * scaleX);
              const dLH = Math.max(1, lineRect.height * scaleY);
              const leftOffsetLine = Math.max(0, lineRect.left - imgRect.left);
              const topOffsetLine = Math.max(0, lineRect.top - imgRect.top);
              const xL = leftOffsetLine * scaleX;
              const yT = topOffsetLine * scaleY;
              ctx.fillStyle = '#ffffff';
              ctx.fillRect(xL, yT, dLW, dLH);
            }

            ctx.fillStyle = '#ffffff';
            ctx.fillText(text, xRight, yBottom);
          }

          cnv.toBlob((outBlob) => {
            try { URL.revokeObjectURL(imgUrl); } catch(_) {}
            if (!outBlob) return;
            const dlUrl = URL.createObjectURL(outBlob);
            const link = document.createElement('a');
            link.href = dlUrl;
            link.download = `fitrite-virtual-tryon-${Date.now()}.jpg`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            setTimeout(() => { try { URL.revokeObjectURL(dlUrl); } catch(_) {} }, 1000);
          }, 'image/jpeg', 0.95);
        } catch (err) {
          console.error('Watermarked export failed, falling back to raw download', err);
          const link = document.createElement('a');
          link.href = currentUrl;
          link.download = `fitrite-virtual-tryon-${Date.now()}.jpg`;
          link.target = '_blank';
          link.style.display = 'none';
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
        }
      })();
    }

    function restartTryOnFromFinal() {
      try { hideProcessing(); } catch(_) {}
      try { hasActivatedAI = false; hasProcessingCompleted = false; isProcessing = false; } catch(_) {}
      try { allowProcessingOverlay = false; forceFullScreenOverlay = false; } catch(_) {}

      // Ensure any saved try-on resume jobs are cleared so redo truly restarts
      try {
        const keysToRemove = [];
        for (let i = 0; i < localStorage.length; i++) {
          const k = localStorage.key(i) || '';
          if (k.indexOf('tryon:job:') === 0) keysToRemove.push(k);
        }
        keysToRemove.forEach(k => { try { localStorage.removeItem(k); } catch(_) {} });
      } catch(_) {}

      // Close final result overlay
      try {
        const fr = document.getElementById('finalResultScreen');
        if (fr) {
          fr.classList.remove('show');
          fr.style.display = 'none';
          fr.style.pointerEvents = 'none';
          fr.style.zIndex = '';
        }
        const finalImg = document.getElementById('finalResultImage');
        if (finalImg) finalImg.src = '';
        const chip = document.getElementById('aiPreviewDisclaimer');
        if (chip) { chip.classList.remove('show'); chip.style.display = 'none'; }
      } catch(_) {}
      try { hideResultInPlace(); window.resultImageUrl = null; } catch(_) {}

      // Reset upload UI and clear person photo
      try {
        // Clear both the window-scoped and implicit globals for safety
        try { window.personFile = null; } catch(_) {}
        personFile = null;
        const personPhotoPreview = document.getElementById('personPhotoPreview');
        const removeBtn = document.getElementById('removePhotoBtn');
        const uploadContainer = document.querySelector('.upload-container');
        const personUploadArea = document.getElementById('personUploadArea');
        const uploadPrompt = document.getElementById('uploadPrompt');
        const uploadTitle = document.querySelector('.upload-title');
        const personUploadInner = document.getElementById('personUploadInner');
        if (personPhotoPreview) { personPhotoPreview.classList.remove('show','fade-out'); personPhotoPreview.style.display='none'; personPhotoPreview.src=''; }
        if (removeBtn) removeBtn.classList.remove('show');
        if (uploadContainer) uploadContainer.classList.remove('has-photo');
        if (personUploadArea) personUploadArea.classList.remove('has-photo');
        if (uploadPrompt) { uploadPrompt.classList.remove('hidden'); uploadPrompt.style.display='block'; uploadPrompt.style.opacity='1'; }
        if (uploadTitle) { uploadTitle.style.display='block'; uploadTitle.style.opacity='1'; }
        if (personUploadInner) { personUploadInner.classList.remove('hidden'); personUploadInner.style.opacity='1'; }
        const fileInput = document.getElementById('personFileInput');
        if (fileInput) fileInput.value='';
        // Hide/disable Activate AI until a new photo is uploaded (first-time behavior)
        try {
          const continueBtn = document.getElementById('continueBtn');
          if (continueBtn) { continueBtn.style.display='none'; continueBtn.classList.remove('show'); continueBtn.disabled = true; }
        } catch(_) {}
        // Extra guard to ensure it remains hidden after the reset
        try { ensureExecuteAIButtonVisible(); } catch(_) {}
      } catch(_) {}

      // Reopen modal with the same product and simulate first Try On click
      try {
        const pd = currentProductData || {
          name: (document.getElementById('modalProductName')?.textContent || '').trim(),
          price: (document.getElementById('modalProductPrice')?.textContent || '').trim(),
          imgUrl: document.getElementById('modalProductImage')?.src || '',
          isDiscounted: false,
          originalPrice: null
        };
        // Also clear the specific job key for this product if present
        try {
          const guessedKey = encodeURIComponent('footwear|' + (pd.name || '') + '|' + (pd.imgUrl || ''));
          clearJob(guessedKey);
        } catch(_) {}
        if (pd && pd.name && pd.imgUrl) {
          openModal(pd.name, pd.price, pd.imgUrl, pd.isDiscounted, pd.originalPrice);
          // Ensure modal is visible
          try {
            const modalEl = document.getElementById('productModal');
            if (modalEl) { modalEl.classList.add('show'); modalEl.style.display='flex'; modalEl.style.opacity='1'; }
          } catch(_) {}
          // Ensure inline watermark clamps when the image in modal is used
          try {
            const wrap = document.getElementById('resultInPlace');
            const img = document.getElementById('resultImageInPlace');
            if (wrap && img) bindWatermarkToImage(img, wrap);
          } catch(_) {}
          // Mimic first-time Try On flow
          setTimeout(() => {
            try {
              const fadeOutEls = document.querySelectorAll('.fade-out-element');
              fadeOutEls.forEach(el => el.classList.add('hidden'));
            } catch(_) {}
            const tryBtn = document.getElementById('tryOnBtn');
            if (tryBtn) tryBtn.click();
          }, 120);
        }
      } catch(_) {}
      try { allowProcessingOverlay = true; } catch(_) {}
    }

    function hideFinalResultScreen() {
      const finalResultScreen = document.getElementById('finalResultScreen');
      if (!finalResultScreen) return;
      // Remove visible class
      finalResultScreen.classList.remove('show');
      // Ensure overlay no longer intercepts clicks
      finalResultScreen.style.opacity = '0';
      finalResultScreen.style.pointerEvents = 'none';
      finalResultScreen.style.zIndex = '';
      // After transition, remove from layout so page is fully interactive
      setTimeout(() => { try { finalResultScreen.style.display = 'none'; } catch(_) {} }, 300);
    }

    // Close modal should fully reset try-on UI
    // Removed final screen handlers
  </script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // Final result actions (mirror leather_jackets)
      try {
        document.getElementById('finalTryAgainBtn')?.addEventListener('click', () => {
          try { hideProcessing(); } catch(_) {}
          // First fully reset the try-on state and UI, then handle visibility
          restartTryOnFromFinal();
          try { hasActivatedAI = false; hasProcessingCompleted = false; isProcessing = false; } catch(_) {}
          try { document.getElementById('modelUploadSection')?.classList.add('show'); } catch(_) {}
          // Ensure the Execute AI button is hidden immediately after redo
          try { ensureExecuteAIButtonVisible(); } catch(_) {}
        });
      document.getElementById('finalShareBtn')?.addEventListener('click', downloadResult);
      document.getElementById('finalBackBtn')?.addEventListener('click', returnToCatalogue);
      } catch(_) {}
      const hamburgerMenuIconElement = document.querySelector('.hamburger-menu'); 
      const menuToggleByIdElement = document.getElementById('menuToggle'); 
      const navElementInHeader = document.querySelector('header nav ul'); 
      const mobileNavElementById = document.getElementById('mobileNav'); 
      let pageMenuOverlay = document.querySelector('.menu-overlay');
      // Robust delegated handler so Redo works even if elements get re-rendered
      try {
        document.addEventListener('click', function(ev){
          const redoBtn = ev.target && ev.target.closest && ev.target.closest('#finalTryAgainBtn');
          if (!redoBtn) return;
          ev.preventDefault();
          ev.stopPropagation();
          try { restartTryOnFromFinal(); } catch(_) {}
        }, true);
      } catch(_) {}
      // Robust delegated handler to always open products even after Buy/overlay flows
      try {
        document.addEventListener('click', function(ev){
          const card = ev.target && ev.target.closest && ev.target.closest('.product');
          if (!card) return;
          // If a modal is already open, ignore
          try { const modalEl = document.getElementById('productModal'); if (modalEl && modalEl.classList.contains('show')) return; } catch(_) {}
          const name = (card.querySelector('.product-name')?.textContent || '').trim();
          const imgUrl = card.querySelector('img')?.src || '';
          const newPriceEl = card.querySelector('.new-price');
          const originalPriceEl = card.querySelector('.original-price');
          const isDiscounted = !!(newPriceEl && originalPriceEl);
          const priceText = (newPriceEl ? newPriceEl.textContent : (card.querySelector('.product-price')?.textContent || '')).trim();
          if (name && imgUrl) {
            openModal(name, priceText, imgUrl, isDiscounted, isDiscounted ? originalPriceEl.textContent.trim() : null);
          }
        }, true);
      } catch(_) {}

      // Click-through recovery: if an overlay accidentally remains on top and eats clicks,
      // forward the click to the product card underneath using elementFromPoint.
      try {
        document.addEventListener('click', function(ev){
          try {
            // If we clicked a product already, the handler above will handle it.
            if (ev.target && ev.target.closest && ev.target.closest('.product')) return;
            // If the modal is open, don't forward.
            const modalOpen = (function(){
              const m = document.getElementById('productModal');
              return !!(m && (m.classList.contains('show') || (m.style.display && m.style.display !== 'none')));
            })();
            if (modalOpen) return;

            const candidates = [
              document.getElementById('finalResultScreen'),
              document.getElementById('productModal'),
              document.getElementById('processingOverlayLocal'),
              document.querySelector('.menu-overlay')
            ].filter(Boolean);

            const cx = ev.clientX, cy = ev.clientY;
            let underlyingCard = null;
            for (const el of candidates) {
              const prev = el.style.pointerEvents;
              el.style.pointerEvents = 'none';
              const under = document.elementFromPoint(cx, cy);
              if (under && under.closest) {
                const c = under.closest('.product');
                if (c) { underlyingCard = c; }
              }
              el.style.pointerEvents = prev;
              if (underlyingCard) break;
            }

            if (underlyingCard) {
              ev.preventDefault();
              ev.stopPropagation();
              // Hide any lingering overlays first
              try { const fr = document.getElementById('finalResultScreen'); if (fr) { fr.classList.remove('show'); fr.style.display='none'; fr.style.pointerEvents='none'; } } catch(_) {}
              try { const pm = document.getElementById('productModal'); if (pm) { pm.classList.remove('show'); pm.style.display='none'; pm.style.pointerEvents='none'; } } catch(_) {}
              try { const ov = document.getElementById('processingOverlayLocal'); if (ov) { ov.classList.remove('show'); ov.style.display='none'; ov.style.pointerEvents='none'; } } catch(_) {}

              const name = (underlyingCard.querySelector('.product-name')?.textContent || '').trim();
              const imgUrl = underlyingCard.querySelector('img')?.src || '';
              const newPriceEl = underlyingCard.querySelector('.new-price');
              const originalPriceEl = underlyingCard.querySelector('.original-price');
              const isDiscounted = !!(newPriceEl && originalPriceEl);
              const priceText = (newPriceEl ? newPriceEl.textContent : (underlyingCard.querySelector('.product-price')?.textContent || '')).trim();
              if (name && imgUrl) {
                openModal(name, priceText, imgUrl, isDiscounted, isDiscounted ? originalPriceEl.textContent.trim() : null);
              }
            }
          } catch(_) {}
        }, true);
      } catch(_) {}
    
      const toggleButtonElement = hamburgerMenuIconElement || menuToggleByIdElement;
      let navToToggleClassOn = mobileNavElementById || navElementInHeader; 
      let navToFindLinksIn = mobileNavElementById || navElementInHeader; 
    
      if (!pageMenuOverlay) {
          pageMenuOverlay = document.createElement('div');
          pageMenuOverlay.className = 'menu-overlay';
          Object.assign(pageMenuOverlay.style, {
            position: 'fixed',
            top: '0',
            left: '0',
            width: '100%',
            height: '100%',
            backgroundColor: 'rgba(0, 0, 0, 0.5)',
            zIndex: '99',
            display: 'none'
          });
          document.body.appendChild(pageMenuOverlay);
      }
    
      if (toggleButtonElement && navToToggleClassOn && pageMenuOverlay && navToFindLinksIn) {
        const openMenu = () => {
          toggleButtonElement.classList.add('active');
          navToToggleClassOn.classList.add('active');
          pageMenuOverlay.style.display = 'block';
          setTimeout(() => {
            document.addEventListener('click', handleOutsideClick);
          }, 0);
        };
    
        const closeMenu = () => {
          toggleButtonElement.classList.remove('active');
          navToToggleClassOn.classList.remove('active');
          pageMenuOverlay.style.display = 'none';
          document.removeEventListener('click', handleOutsideClick);
        };
    
        const handleOutsideClick = (event) => {
          if (!navToToggleClassOn.contains(event.target) && !toggleButtonElement.contains(event.target)) {
            closeMenu();
          }
        };
    
        toggleButtonElement.addEventListener('click', (event) => {
          event.stopPropagation();
          const isActive = toggleButtonElement.classList.contains('active');
          isActive ? closeMenu() : openMenu();
        });
    
        navToFindLinksIn.querySelectorAll('a').forEach(link => {
          link.addEventListener('click', closeMenu);
        });
    
        pageMenuOverlay.addEventListener('click', closeMenu);
      }
      // Try-on hard reset on load
      try { window.tryOnActive = false; } catch(_) {}
      try { const arrows = document.getElementById('tryOnArrows'); if (arrows) arrows.classList.remove('show'); } catch(_) {}

      // Resize handlers to keep layout/arrows consistent
      let resizeTimeout;
      window.addEventListener('resize', () => {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(() => {
          try { applyTryOnLayout(); } catch(_) {}
          try { ensureTryOnConsistency(); } catch(_) {}
          try { positionUploadNextToModal(); } catch(_) {}
          try { positionArrowsBetween(); } catch(_) {}
          try { positionProductImage(); } catch(_) {}
        }, 100);
      });
      // Also reposition on scroll since modal is fixed and user can scroll page under dim backdrop
      let scrollTimeout;
      window.addEventListener('scroll', () => {
        clearTimeout(scrollTimeout);
        scrollTimeout = setTimeout(() => {
          try { positionUploadNextToModal(); } catch(_) {}
          try { positionArrowsBetween(); } catch(_) {}
          try { positionProductImage(); } catch(_) {}
        }, 50);
      }, { passive: true });
    });
    </script>
    
  <script>
    // Mobile Menu Toggle
    const menuToggle = document.getElementById("menuToggle");
    const mobileNav = document.getElementById("mobileNav");
    
    if (menuToggle && mobileNav) {
      menuToggle.addEventListener("click", () => {
        mobileNav.classList.toggle("active");
      });
      
      // Close menu when clicking outside
      document.addEventListener("click", (event) => {
        if (!event.target.closest("#mobileNav") && !event.target.closest("#menuToggle")) {
          if (mobileNav.classList.contains("active")) {
            mobileNav.classList.remove("active");
          }
        }
      });
    }
  </script>
  <script>
    // --- Refined Animated Size Selector Modal Logic ---
    const addToBasketBtn = document.getElementById("addToBasket");
    const modalButtonsGroup = document.getElementById("modalButtonsGroup");
    let selectorIsUp = false;

    function moveSelectorToButton() {
      // Calculate the offset between selector and Add to Basket button
      const selectorRect = sizeSelector.getBoundingClientRect();
      const buttonRect = addToBasketBtn.getBoundingClientRect();
      const selectorOffset = buttonRect.top - selectorRect.top;
      sizeSelector.style.transform = `translateY(${selectorOffset}px)`;
      sizeSelector.style.boxShadow = "0 8px 32px rgba(0,0,0,0.18)";
      sizeSelector.style.zIndex = 10;
      modalButtonsGroup.classList.add("hide");
    }

    function resetSelectorPosition() {
      sizeSelector.style.transform = "";
      sizeSelector.style.boxShadow = "";
      sizeSelector.style.zIndex = "";
      modalButtonsGroup.classList.remove("hide");
      selectorIsUp = false;
    }

    if (sizeSelector && addToBasketBtn && modalButtonsGroup) {
      sizeSelector.addEventListener("mousedown", (e) => {
        if (selectorIsUp) {
          // If already up, bring it back down and show buttons
          resetSelectorPosition();
          selectorIsUp = false;
          // Prevent dropdown from opening
          e.preventDefault();
          sizeSelector.blur();
        } else {
          moveSelectorToButton();
          selectorIsUp = true;
        }
      });
      sizeSelector.addEventListener("focus", () => {
        if (!selectorIsUp) {
          moveSelectorToButton();
          selectorIsUp = true;
        }
      });
      sizeSelector.addEventListener("change", () => {
        resetSelectorPosition();
        selectorIsUp = false;
      });
      sizeSelector.addEventListener("blur", () => {
        resetSelectorPosition();
        selectorIsUp = false;
      });
    }
  </script>
  
  <!-- Firebase Cart System -->
  <script type="module" src="./firebase.js?v=2"></script>
  <script type="module" src="./fitright-cart-only.js?v=2"></script>
  <script src="./shared-basket-dropdown.js"></script>
  
  <!-- Basket Button Fix -->

</body>
</html>








