<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>New Leather Jackets - Fitrite</title>
  <!-- Import Special Elite from Google Fonts for the header and leather jackets section -->
  <link href="https://fonts.googleapis.com/css2?family=Special+Elite&display=swap" rel="stylesheet">
  <style>
    /* CSS Reset and Box Model Standardization */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    /* Global Styles */
    body {
      margin: 0;
      padding: 0;
      background: #f4f4f4;
      font-family: Arial, sans-serif;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    
    /* Header Styles */
    header {
      position: relative;
      z-index: 1000;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px;
      background-color: transparent;
      width: 100%;
      font-family: 'Special Elite', monospace;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    
    header .logo h1 {
      margin: 0;
      font-size: 1.5em;
      font-weight: normal;
      color: black;
    }
    
    header .logo p {
      margin: 3px 0 0;
      font-size: 0.8em;
      font-style: italic;
      color: black;
    }
    
    /* Mobile Menu Toggle */
    .file-input {
      display: none !important;
      visibility: hidden !important;
      opacity: 0 !important;
      position: absolute !important;
      left: -9999px !important;
      width: 0 !important;
      height: 0 !important;
    }
    
    .menu-toggle {
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      width: 30px;
      height: 21px;
      cursor: pointer;
      z-index: 20;
    }
    
    .menu-toggle span {
      display: block;
      height: 3px;
      width: 100%;
      background-color: #333;
      border-radius: 3px;
      transition: all 0.3s ease;
    }
    
    header nav {
      padding-right: 0;
    }
    
    header nav ul {
      list-style: none;
      display: flex;
      gap: 15px;
      margin: 0;
      padding: 0;
    }
    
    header nav ul li a {
      color: black;
      text-decoration: none;
      transition: color 0.3s;
      pointer-events: auto;
      padding: 5px 10px;
      display: block;
    }
    
    header nav ul li a:hover {
      text-decoration: underline;
      color: black;
    }
    
    /* BASKET STYLES */
    /* Mobile Navigation */
    @media (max-width: 767px) {
      .menu-toggle {
        display: flex;
      }
      
      header nav {
        position: fixed;
        top: 0;
        right: -100%;
        width: 80%;
        max-width: 300px;
        height: 100vh;
        background-color: white;
        z-index: 100;
        transition: right 0.3s ease;
        box-shadow: -5px 0 15px rgba(0,0,0,0.1);
        padding: 80px 20px 20px;
      }
      
      header nav.active {
        right: 0;
      }
      
      header nav ul {
        flex-direction: column;
      }
      
      header nav ul li {
        margin-right: 0;
        margin-bottom: 15px;
      }
      
      .basket-desktop { display: none !important; }
      .basket-mobile { display: block !important; }
      #basketDropdown {
        position: static !important;
        right: auto !important;
        left: auto !important;
        min-width: unset !important;
        max-width: 100% !important;
        width: 100% !important;
        margin: 0 0 0 0 !important;
        box-shadow: none !important;
        border-radius: 0 0 15px 15px !important;
        z-index: 1 !important;
        padding: 0 0 10px 0 !important;
        max-height: 250px !important;
        overflow-y: auto !important;
      }
      #basketDropdown.show {
        box-shadow: none !important;
      }
    }
    
    /* Basket Dropdown Animation */
    #basketDropdown {
      opacity: 0;
      transform: translateY(-10px);
      pointer-events: none;
      transition: opacity 0.3s, transform 0.3s;
      display: block; /* Always block for animation, hide with opacity */
      max-height: 400px;
      overflow-y: auto;
    }
    #basketDropdown.show {
      opacity: 1;
      transform: translateY(0);
      pointer-events: auto;
    }
    /* Enhanced fade animation for basket product row */
    .basket-fade-out {
      opacity: 0;
      transform: translateX(-20px) scale(0.95);
      background-color: rgba(255, 0, 0, 0.05);
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      pointer-events: none;
    }
    .basket-fade-in {
      opacity: 1;
      transform: translateX(0) scale(1);
      background-color: transparent;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }
    /* Hide minus button by default, show on hover (desktop only) */
    .basket-row .basket-minus-btn {
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s;
    }
    .basket-row:hover .basket-minus-btn {
      opacity: 1;
      pointer-events: auto;
    }
    @media (max-width: 767px) {
      .basket-row .basket-minus-btn {
        opacity: 1 !important;
        pointer-events: auto !important;
      }
    }
    
    /* Hide/show basket button for desktop/mobile */
    .basket-desktop { display: block; }
    .basket-mobile { display: none; }
    
    /* Clear Basket Button Slide-up Animation */
    #basketDropdownFooter {
      transition: all 0.3s ease;
      transform: translateY(100%);
      opacity: 0;
      overflow: hidden;
      position: relative;
    }
    
    #basketDropdown:hover #basketDropdownFooter {
      transform: translateY(0);
      opacity: 1;
    }
    
    #clearBasketBtn {
      transition: all 0.2s ease;
    }
    
    #clearBasketBtn:hover {
      background: #a00 !important;
      transform: scale(1.05);
    }
    
    #basketDropdownFooterMobile {
      transition: all 0.3s ease;
      transform: translateY(100%);
      opacity: 0;
      overflow: hidden;
      position: relative;
    }
    
    #basketDropdownMobile:hover #basketDropdownFooterMobile {
      transform: translateY(0);
      opacity: 1;
    }
    
    #clearBasketBtnMobile {
      transition: all 0.2s ease;
    }
    
    #clearBasketBtnMobile:hover {
      background: #a00 !important;
      transform: scale(1.05);
    }
    @media (max-width: 767px) {
      .basket-desktop { display: none !important; }
      .basket-mobile { display: block !important; }
      #basketDropdown {
        right: 10px !important;
        left: 10px !important;
        min-width: unset !important;
        max-width: 95vw !important;
      }
    }
    
    /* Highlight basket button in mobile menu on hover like other links */
    .basket-mobile-btn:hover span:first-child {
      text-decoration: underline;
      color: black;
    }
    
    /* Only add border-bottom to basket rows except the last */
    .basket-row:not(:last-child) {
      border-bottom: 1px solid #eee;
    }
    
    /* Mobile basket row styles */
    .basket-mobile-row {
      display: flex;
      align-items: center;
      margin-bottom: 8px;
      padding: 0 0 0 0;
      background: none;
      border-radius: 0;
      box-shadow: none;
      position: relative;
      min-height: 48px;
    }
    .basket-mobile-row:last-child {
      margin-bottom: 0;
    }
    .basket-mobile-row img {
      width: 38px;
      height: 38px;
      object-fit: contain;
      border-radius: 8px;
      margin-right: 8px;
      background: #fafafa;
    }
    .basket-mobile-row .basket-mobile-info {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
      min-width: 0;
    }
    .basket-mobile-row .basket-mobile-title {
      font-family: 'Special Elite', monospace;
      font-size: 1em;
      text-transform: uppercase;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .basket-mobile-row .basket-mobile-price {
      font-size: 1em;
      font-weight: bold;
      font-family: 'Special Elite', monospace;
      margin-right: 8px;
      display: inline-block;
    }
    .basket-mobile-row .basket-mobile-qty {
      font-size: 0.95em;
      color: #555;
      font-family: 'Special Elite', monospace;
      text-transform: uppercase;
      display: inline-block;
    }
    .basket-mobile-row .basket-mobile-size {
      font-size: 0.95em;
      color: #555;
      font-family: 'Special Elite', monospace;
      text-transform: uppercase;
      display: none;
    }
    .basket-minus-btn-mobile {
      background: #000;
      color: #fff;
      border: none;
      border-radius: 50%;
      width: 28px;
      height: 28px;
      font-size: 1.2em;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      position: absolute;
      top: 50%;
      right: 8px;
      transform: translateY(-50%);
      transition: background 0.2s;
    }
    .basket-minus-btn-mobile:hover {
      background: #333;
    }
    
    /* Search Bar */
    #search-bar {
      background-color: transparent;
      padding: 15px;
      text-align: center;
      border-bottom: 1px solid #ddd;
      width: 100%;
    }
    
    #searchInput {
      width: 90%;
      max-width: 600px;
      padding: 10px 15px;
      font-size: 1em;
      border: 1px solid #ccc;
      border-radius: 25px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      outline: none;
    }
    
    #searchInput:focus {
      border-color: #333;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }
    
    /* Main Title - Matching Scarves Page */
    .main-title {
      text-align: center;
      font-family: 'Special Elite', monospace;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin: 20px 0;
      font-size: 1.8em;
      font-weight: normal;
    }
    
    /* Products Grid - Responsive grid like bags page */
    .products {
      display: grid;
      grid-template-columns: repeat(4, 1fr); /* Default to 4 columns for desktop */
      gap: 20px;
      padding: 20px;
      background-color: #f4f4f4;
      width: 100%;
      max-width: 1400px;
      margin: 0 auto;
    }
    
    .product {
      background-color: white;
      border: 1px solid #ddd;
      border-radius: 15px;
      box-shadow: 0px 4px 10px rgba(0,0,0,0.2);
      overflow: hidden;
      text-align: center;
      padding: 15px;
      cursor: pointer;
      transition: transform 0.3s, box-shadow 0.3s;
      position: relative;
      touch-action: manipulation;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 200px; /* Ensure consistent height */
    }
    
    .product:hover {
      transform: scale(1.02);
      box-shadow: 0px 6px 15px rgba(0,0,0,0.3);
    }
    
    /* Image Container - Updated to display properly */
    .image-container {
      display: block;
      width: 100%;
      height: 200px;
      margin-bottom: 10px;
    }
    
    .image-container img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      border-radius: 10px;
    }
    
    /* Product Text Styling - Matching Scarves Page */
    .product-name {
      font-family: 'Special Elite', monospace;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      font-size: 1.1em;
      margin-bottom: 5px;
    }
    
    .product-price {
      font-family: 'Special Elite', monospace;
      font-size: 1em;
    }
    
    /* Discount Tag Styles - UPDATED WITH DUAL TAG SYSTEM */
    .discount-tag {
      position: absolute;
      top: 10px;
      left: 10px;
      padding: 5px 10px;
      border-radius: 3px;
      font-weight: bold;
      z-index: 5;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      text-align: center;
    }
    
    /* Red Tag (≤ 55%) */
    .discount-tag.red {
      background-color: #ff0000;
      color: white; /* Changed to white as requested */
      font-size: 0.9em;
    }
    
    /* Gold Tag (> 55%) */
    .discount-tag.gold {
      background-color: gold;
      color: #333; /* Dark text */
      font-size: 0.95em;
      padding: 6px 10px;
      font-weight: bold;
    }
    
    /* Price Styling for Discounted Products */
    .original-price {
      text-decoration: line-through;
      color: #888;
      margin-right: 5px;
    }
    
    .new-price {
      color: green;
      font-weight: bold;
    }
    
    /* Footer */
    footer {
      text-align: center;
      background-color: transparent;
      color: #333;
      font-size: 0.9em;
      margin: 20px 0;
      padding: 15px;
      width: 100%;
    }
    
    footer p {
      margin: 5px 0;
    }
    
    /* Modal Styles - Responsive */
    .modal {
      display: none;
      position: fixed;
      z-index: 999;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.4s ease;
      justify-content: center;
      align-items: center;
    }
    
    .modal.show {
      display: flex;
      opacity: 1;
      pointer-events: auto;
    }
    
    @keyframes fadeInSlide {
      0% {
        opacity: 0;
        transform: translateY(-50px);
      }
      100% {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .close-btn {
      position: absolute;
      top: 0.5rem;
      right: 0.75rem;
      font-size: 1.2rem;
      font-weight: bold;
      cursor: pointer;
      touch-action: manipulation;
    }
    
    .close-btn:hover {
      color: red;
    }
    
    .modal .image-container {
      display: block;
      margin: 0 auto 10px;
      border-radius: 0;
      overflow: hidden;
    }
    
    .modal .image-container img {
      width: 100%;
      height: auto;
      object-fit: cover;
      display: block;
    }
    
    /* Added image element for modal content */
    #modalProductImage {
      width: 100%;
      max-width: 250px;
      height: auto;
      object-fit: contain;
      border-radius: 15px;
      margin-bottom: 1rem;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }
    
    .proceed-btn {
      background-color: #000;
      color: #fff;
      border: none;
      padding: 1rem 1.5rem;
      margin-top: 1rem;
      cursor: pointer;
      font-size: 1rem;
      border-radius: 30px;
      transition: background-color 0.3s;
      touch-action: manipulation;
      width: 100%;
      text-align: center;
    }
    
    .proceed-btn:hover {
      background-color: #333;
    }
    
    #sizeSelector {
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
      background-repeat: no-repeat;
      background-position: right 1rem center;
      background-size: 1em;
      padding-right: 2.5rem;
    }
    
    /* Toast Notification */
    #toast {
      position: fixed;
      bottom: -100px;
      left: 50%;
      transform: translateX(-50%);
      background-color: #333;
      color: white;
      padding: 15px 25px;
      border-radius: 8px;
      z-index: 1001;
      transition: bottom 0.5s ease-in-out;
    }
    
    #toast.show {
      bottom: 30px;
    }

    /* Try Button Styles - Same as other buttons but with Glacier effect */
    .try-on-btn {
      background: linear-gradient(135deg, #a3d5ff 0%, rgba(255, 255, 255, 0.9) 100%);
      color: #fff;
      border: none;
      padding: 1rem 1.5rem;
      margin-top: 1rem;
      cursor: pointer;
      font-size: 1rem;
      border-radius: 30px;
      transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      touch-action: manipulation;
      width: 100%;
      text-align: center;
      position: relative;
      overflow: hidden;
      box-shadow: 0 10px 30px rgba(163, 213, 255, 0.4);
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 2px;
    }

    .try-on-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, 
          transparent, 
          rgba(255, 180, 180, 0.35), 
          rgba(255, 200, 160, 0.35), 
          rgba(255, 255, 200, 0.35), 
          rgba(200, 255, 200, 0.4), 
          rgba(200, 230, 255, 0.4), 
          rgba(230, 200, 255, 0.35), 
          rgba(255, 200, 230, 0.35), 
          rgba(255, 255, 255, 0.5),
          transparent);
      opacity: 1;
      z-index: 1;
      animation: glacier-rainbow-sweep 4s infinite;
    }

    @keyframes glacier-rainbow-sweep {
      0% { left: -100%; opacity: 0.4; }
      50% { left: 100%; opacity: 0.7; }
      100% { left: -100%; opacity: 0.4; }
    }

    .try-on-btn:hover:not(:disabled) {
      transform: translateY(-5px) scale(1.03);
      box-shadow: 0 20px 40px rgba(163, 213, 255, 0.6);
      background: linear-gradient(135deg, #87ceeb 0%, rgba(255, 255, 255, 0.95) 100%);
    }

    .try-on-btn:active:not(:disabled) {
      transform: translateY(-2px) scale(0.98);
      box-shadow: 0 10px 25px rgba(163, 213, 255, 0.4);
    }

    /* Fade out animation for modal elements */
    .fade-out-element {
      opacity: 1;
      transition: opacity 0.6s ease-out, transform 0.6s ease-out;
    }

    .fade-out-element.hidden {
      opacity: 0;
      transform: translateY(-20px);
      pointer-events: none;
    }

    /* Model Upload Section Styles */
    .model-upload-section {
      display: none;
      text-align: center;
    }

    .model-upload-section.show {
      display: block;
    }

    .upload-container {
      background: white;
      border-radius: 15px;
      padding: 20px;
      margin: 20px auto;
      max-width: 500px;
      box-shadow: 0px 4px 10px rgba(0,0,0,0.2);
      transition: all 0.6s ease;
    }

    .upload-container.has-photo {
      background: transparent;
      box-shadow: none;
      padding: 0;
      border-radius: 0;
    }

    /* Mobile specific positioning - Corrigido para melhor responsividade */
    @media (max-width: 768px) {
      .model-upload-section {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%) translateY(100vh);
        width: 90vw;
        max-width: 400px;
        margin: 0;
        z-index: 1001;
        transition: transform 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        box-sizing: border-box;
        max-height: 90vh;
        overflow-y: auto;
      }

      .model-upload-section.show {
        transform: translate(-50%, -50%) translateY(0);
      }

      .model-upload-section.scroll-up {
        animation: scrollUpMobile 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
      }

      .upload-container {
        margin: 0 0 20px 0;
        width: 100%;
        box-sizing: border-box;
      }
    }

    @keyframes scrollUpMobile {
      from {
        transform: translate(-50%, -50%) translateY(100vh);
        opacity: 0;
      }
      to {
        transform: translate(-50%, -50%) translateY(0);
        opacity: 1;
      }
    }

    /* Desktop positioning - Corrigido para melhor responsividade */
    @media (min-width: 769px) {
      .model-upload-section {
        position: fixed;
        left: 65%;
        top: 50%;
        transform: translate(0, -50%);
        width: 300px;
        max-width: 35vw;
        display: none;
        animation: fadeInRight 0.6s ease-out;
        z-index: 1004;
        box-sizing: border-box;
        max-height: 90vh;
        overflow-y: auto;
      }

      .model-upload-section.show {
        display: block;
      }

      .upload-container {
        margin: 0 0 20px 0;
        width: 100%;
        box-sizing: border-box;
      }

      @keyframes fadeInRight {
        from {
          opacity: 0;
          transform: translate(30px, -50%);
        }
        to {
          opacity: 1;
          transform: translate(0, -50%);
        }
      }
    }

    @keyframes slideInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Desktop Try-On Animation - Container Fade Out */
    @media (min-width: 769px) {
      .modal-content.try-on-container-fadeout {
        animation: containerFadeOut 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
      }
    }

    @keyframes containerFadeOut {
      from {
        opacity: 1;
        transform: translateX(0);
      }
      to {
        opacity: 0;
        transform: translateX(-50px);
      }
    }

    /* Keep product image visible */
    .modal-content.try-on-container-fadeout #modalProductImage {
      position: absolute;
      z-index: 1002;
      opacity: 1 !important;
      transform: none !important;
      animation: productImageFloat 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
    }

    @keyframes productImageFloat {
      from {
        position: relative;
        z-index: 1;
      }
      to {
        position: absolute;
        z-index: 1002;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
      }
    }

    .upload-title {
      font-family: 'Special Elite', monospace;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      font-size: 1.3em;
      margin-bottom: 20px;
      color: #333;
    }

    .upload-container {
      background: white;
      border-radius: 15px;
      padding: 20px;
      margin: 20px auto;
      max-width: 500px;
      box-shadow: 0px 4px 10px rgba(0,0,0,0.2);
      transition: all 0.6s ease;
      position: relative;
    }

    .upload-container.has-photo {
      background: transparent;
      box-shadow: none;
      padding: 0;
      border-radius: 15px;
      overflow: hidden;
      width: 300px;
      height: 400px;
    }

    /* Mobile adjustments for upload container */
    @media (max-width: 768px) {
      .upload-container.has-photo {
        width: 350px;
        height: 450px;
      }
    }

    .person-upload-area {
      position: relative;
      background: #f8f9fa;
      border: 3px dashed #dee2e6;
      border-radius: 12px;
      padding: 20px;
      cursor: pointer;
      transition: all 0.6s ease;
      width: 250px;
      height: 250px;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      margin: 0 auto;
    }

    .person-upload-area.has-photo {
      border: none;
      background: transparent;
      padding: 0;
      width: 100%;
      height: 100%;
      border-radius: 0;
      min-height: auto;
      box-shadow: none;
      position: absolute;
      top: 0;
      left: 0;
      margin: 0;
    }

    .person-upload-area.has-photo img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 15px;
    }

    .person-upload-area.has-photo:hover {
      border: none;
      background: transparent;
    }

    .person-photo-preview {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 15px;
      display: none;
      opacity: 0;
      transition: opacity 0.8s ease-in-out;
    }

    .person-upload-inner.hidden {
      opacity: 0;
      pointer-events: none;
    }

    .upload-prompt {
      text-align: center;
    }

    .upload-prompt.hidden {
      display: none;
    }

    .upload-icon {
      font-size: 3em;
      margin-bottom: 15px;
      color: #666;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .upload-icon svg {
      width: 80px;
      height: 80px;
      stroke: #666;
      transition: stroke 0.3s ease;
    }

    .person-upload-area:hover .upload-icon svg {
      stroke: #007bff;
    }

    .upload-text {
      font-size: 1.1em;
      color: #333;
      margin-bottom: 8px;
      font-weight: 500;
    }

    .upload-subtext {
      font-size: 0.9em;
      color: #666;
    }

    .person-photo-preview {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: contain;
      border-radius: 12px;
      display: none;
      opacity: 0;
      transition: opacity 0.8s ease-in-out;
    }

    .person-photo-preview.show {
      display: block;
      opacity: 1;
    }

    .person-photo-preview.fade-out {
      opacity: 0;
    }

    .result-in-place {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      opacity: 0;
      transition: opacity 1.2s ease-in-out;
    }

    .result-in-place.show {
      opacity: 1;
    }

    .result-image-in-place {
      width: 100%;
      height: 100%;
      object-fit: contain;
      border-radius: 12px;
    }

    .result-back-btn {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(0,0,0,0.7);
      color: white;
      border: none;
      border-radius: 50%;
      width: 35px;
      height: 35px;
      font-size: 1.2em;
      cursor: pointer;
      opacity: 0;
      transition: all 0.3s ease;
    }

    .result-back-btn.show {
      opacity: 1;
    }

    .result-back-btn:hover {
      background: rgba(0,0,0,0.9);
      transform: scale(1.1);
    }

    .processing-overlay-local {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.3);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }

    .processing-overlay-local.show {
      opacity: 1;
      pointer-events: auto;
    }

    /* Adiciona blur diretamente na imagem durante processamento */
    .person-photo-preview.processing {
      filter: blur(8px);
      transition: filter 0.3s ease;
    }

    .person-photo-preview.processing-complete {
      filter: blur(0px);
      transition: filter 0.5s ease;
    }

    .processing-content-local {
      text-align: center;
      padding: 20px;
    }

    .processing-spinner {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      margin: 0 auto 15px;
      position: relative;
      background: conic-gradient(
        from 0deg,
        rgba(255, 180, 180, 0.8),
        rgba(255, 200, 160, 0.8),
        rgba(255, 255, 200, 0.9),
        rgba(200, 255, 200, 0.8),
        rgba(200, 230, 255, 0.9),
        rgba(230, 200, 255, 0.8),
        rgba(255, 200, 230, 0.8),
        rgba(255, 255, 255, 0.9),
        rgba(255, 180, 180, 0.8)
      );
      animation: spin 1s linear infinite;
    }

    .processing-spinner::before {
      content: '';
      position: absolute;
      top: 4px;
      left: 4px;
      right: 4px;
      bottom: 4px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 50%;
      backdrop-filter: blur(8px);
    }

    @keyframes progress-spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .processing-text {
      font-size: 1.1em;
      font-weight: 600;
      color: #fff;
      margin-bottom: 5px;
      text-shadow: 0 1px 3px rgba(0,0,0,0.3);
    }

    .processing-subtext {
      font-size: 0.9em;
      color: rgba(255, 255, 255, 0.9);
      margin-bottom: 15px;
      text-shadow: 0 1px 2px rgba(0,0,0,0.2);
    }

    .progress-bar {
      width: 100%;
      height: 6px;
      background: rgba(163, 213, 255, 0.2);
      border-radius: 3px;
      overflow: hidden;
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(135deg, #a3d5ff 0%, rgba(255, 255, 255, 0.9) 100%);
      width: 0%;
      transition: width 0.3s ease;
      position: relative;
      overflow: hidden;
      border-radius: 3px;
      box-shadow: 0 2px 6px rgba(163, 213, 255, 0.4);
    }

    .progress-fill::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, 
          transparent, 
          rgba(255, 180, 180, 0.35), 
          rgba(255, 200, 160, 0.35), 
          rgba(255, 255, 200, 0.35), 
          rgba(200, 255, 200, 0.4), 
          rgba(200, 230, 255, 0.4), 
          rgba(230, 200, 255, 0.35), 
          rgba(255, 200, 230, 0.35), 
          rgba(255, 255, 255, 0.5),
          transparent);
      opacity: 1;
      z-index: 1;
      animation: glacier-rainbow-sweep 3s infinite;
    }

    .remove-photo-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      border: none;
      border-radius: 50%;
      width: 35px;
      height: 35px;
      font-size: 1.4em;
      font-weight: bold;
      cursor: pointer;
      opacity: 0;
      transition: all 0.3s ease;
      z-index: 10;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.4);
      backdrop-filter: blur(4px);
    }

    /* Hover behavior for desktop */
    @media (hover: hover) {
      .upload-container:hover .remove-photo-btn.show {
        opacity: 1;
      }
      
      .remove-photo-btn.show {
        opacity: 0;
      }
      
      .remove-photo-btn:hover {
        background: rgba(0, 0, 0, 1);
        transform: scale(1.1);
        box-shadow: 0 4px 12px rgba(0,0,0,0.6);
      }
    }

    /* Touch behavior for mobile */
    @media (hover: none) {
      .remove-photo-btn.show {
        opacity: 1;
      }
      
      .remove-photo-btn:active {
        background: rgba(0, 0, 0, 1);
        transform: scale(0.95);
      }
    }

    .continue-btn {
      background: linear-gradient(135deg, #a3d5ff 0%, rgba(255, 255, 255, 0.9) 100%);
      color: #fff;
      border: none;
      padding: 15px 30px;
      margin: 20px 0;
      border-radius: 30px;
      font-size: 1.1em;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 2px;
      cursor: pointer;
      transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      width: 100%;
      display: none;
      position: relative;
      overflow: hidden;
      box-shadow: 0 10px 30px rgba(163, 213, 255, 0.4);
      touch-action: manipulation;
      text-align: center;
      opacity: 0;
      transform: translateY(20px);
    }

    .continue-btn.show {
      display: block;
      animation: fadeInUp 0.6s ease-out forwards;
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .continue-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, 
          transparent, 
          rgba(255, 180, 180, 0.35), 
          rgba(255, 200, 160, 0.35), 
          rgba(255, 255, 200, 0.35), 
          rgba(200, 255, 200, 0.4), 
          rgba(200, 230, 255, 0.4), 
          rgba(230, 200, 255, 0.35), 
          rgba(255, 200, 230, 0.35), 
          rgba(255, 255, 255, 0.5),
          transparent);
      opacity: 1;
      z-index: 1;
      animation: glacier-rainbow-sweep 4s infinite;
    }

    .continue-btn.show {
      display: block;
    }

    .continue-btn:hover:not(:disabled) {
      transform: translateY(-5px) scale(1.03);
      box-shadow: 0 20px 40px rgba(163, 213, 255, 0.6);
      background: linear-gradient(135deg, #87ceeb 0%, rgba(255, 255, 255, 0.95) 100%);
    }

    .continue-btn:active:not(:disabled) {
      transform: translateY(-2px) scale(0.98);
      box-shadow: 0 10px 25px rgba(163, 213, 255, 0.4);
    }

    .continue-btn:disabled {
      background: #f5f5f5;
      color: #999;
      border: 1px solid rgba(0, 0, 0, 0.05);
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .continue-btn:disabled::before {
      display: none;
    }



    .result-actions-external {
      display: none;
      gap: 10px;
      justify-content: center;
      margin-top: 15px;
    }

    .result-actions-external.show {
      display: flex;
    }

    .result-actions-external .continue-btn {
      display: block;
      width: auto;
      min-width: 120px;
      padding: 10px 20px;
      margin: 0;
      font-size: 0.9em;
      opacity: 1;
      transform: none;
    }

    .download-circle-btn {
      background: linear-gradient(135deg, #a3d5ff 0%, rgba(255, 255, 255, 0.9) 100%);
      color: #fff;
      border: none;
      width: 50px;
      height: 50px;
      border-radius: 50%;
      cursor: pointer;
      transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      position: relative;
      overflow: hidden;
      box-shadow: 0 10px 30px rgba(163, 213, 255, 0.4);
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0;
    }

    .download-circle-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, 
          transparent, 
          rgba(255, 180, 180, 0.35), 
          rgba(255, 200, 160, 0.35), 
          rgba(255, 255, 200, 0.35), 
          rgba(200, 255, 200, 0.4), 
          rgba(200, 230, 255, 0.4), 
          rgba(230, 200, 255, 0.35), 
          rgba(255, 200, 230, 0.35), 
          rgba(255, 255, 255, 0.5),
          transparent);
      opacity: 1;
      z-index: 1;
      animation: glacier-rainbow-sweep 4s infinite;
      border-radius: 50%;
    }

    .download-circle-btn:hover:not(:disabled) {
      transform: translateY(-5px) scale(1.1);
      box-shadow: 0 20px 40px rgba(163, 213, 255, 0.6);
      background: linear-gradient(135deg, #87ceeb 0%, rgba(255, 255, 255, 0.95) 100%);
    }

    .download-circle-btn:active:not(:disabled) {
      transform: translateY(-2px) scale(1.05);
      box-shadow: 0 10px 25px rgba(163, 213, 255, 0.4);
    }

    .download-circle-btn svg {
      position: relative;
      z-index: 2;
    }

    .restart-circle-btn {
      background: linear-gradient(135deg, #a3d5ff 0%, rgba(255, 255, 255, 0.9) 100%);
      color: #fff;
      border: none;
      width: 50px;
      height: 50px;
      border-radius: 50%;
      cursor: pointer;
      transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      position: relative;
      overflow: hidden;
      box-shadow: 0 10px 30px rgba(163, 213, 255, 0.4);
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0;
    }

    .restart-circle-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, 
          transparent, 
          rgba(255, 180, 180, 0.35), 
          rgba(255, 200, 160, 0.35), 
          rgba(255, 255, 200, 0.35), 
          rgba(200, 255, 200, 0.4), 
          rgba(200, 230, 255, 0.4), 
          rgba(230, 200, 255, 0.35), 
          rgba(255, 200, 230, 0.35), 
          rgba(255, 255, 255, 0.5),
          transparent);
      opacity: 1;
      z-index: 1;
      animation: glacier-rainbow-sweep 4s infinite;
      border-radius: 50%;
    }

    .restart-circle-btn:hover:not(:disabled) {
      transform: translateY(-5px) scale(1.1);
      box-shadow: 0 20px 40px rgba(163, 213, 255, 0.6);
      background: linear-gradient(135deg, #87ceeb 0%, rgba(255, 255, 255, 0.95) 100%);
    }

    .restart-circle-btn:active:not(:disabled) {
      transform: translateY(-2px) scale(1.05);
      box-shadow: 0 10px 25px rgba(163, 213, 255, 0.4);
    }

    .restart-circle-btn svg {
      position: relative;
      z-index: 2;
    }

    .share-circle-btn {
      background: linear-gradient(135deg, #a3d5ff 0%, rgba(255, 255, 255, 0.9) 100%);
      color: #fff;
      border: none;
      width: 50px;
      height: 50px;
      border-radius: 50%;
      cursor: pointer;
      transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      position: relative;
      overflow: hidden;
      box-shadow: 0 10px 30px rgba(163, 213, 255, 0.4);
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0;
    }

    .share-circle-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, 
          transparent, 
          rgba(255, 180, 180, 0.35), 
          rgba(255, 200, 160, 0.35), 
          rgba(255, 255, 200, 0.35), 
          rgba(200, 255, 200, 0.4), 
          rgba(200, 230, 255, 0.4), 
          rgba(230, 200, 255, 0.35), 
          rgba(255, 200, 230, 0.35), 
          rgba(255, 255, 255, 0.5),
          transparent);
      opacity: 1;
      z-index: 1;
      animation: glacier-rainbow-sweep 4s infinite;
      border-radius: 50%;
    }

    .share-circle-btn:hover:not(:disabled) {
      transform: translateY(-5px) scale(1.1);
      box-shadow: 0 20px 40px rgba(163, 213, 255, 0.6);
      background: linear-gradient(135deg, #87ceeb 0%, rgba(255, 255, 255, 0.95) 100%);
    }

    .share-circle-btn:active:not(:disabled) {
      transform: translateY(-2px) scale(1.05);
      box-shadow: 0 10px 25px rgba(163, 213, 255, 0.4);
    }

    .share-circle-btn svg {
      position: relative;
      z-index: 2;
    }

    /* Iridescent arrows pointing from product to upload */
    .try-on-arrows {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 1001;
      display: none;
      pointer-events: none;
    }

    .try-on-arrows.show {
      display: block;
    }

    .arrow-top, .arrow-bottom {
      position: absolute;
      opacity: 0;
      transform: scale(0);
      animation: arrowCreate 1.2s ease-out forwards;
      overflow: hidden;
    }

    @keyframes glacier-rainbow-sweep {
      0% { left: -100%; opacity: 0.4; }
      50% { left: 0%; opacity: 0.7; }
      100% { left: -100%; opacity: 0.4; }
    }

    /* Custom arrow sweep animation that fills the arrow progressively */
    @keyframes arrow-rainbow-sweep {
      0% { 
        width: 0%;
        left: 0%;
        opacity: 0;
      }
      10% {
        width: 0%;
        left: 0%;
        opacity: 0.8;
      }
      70% { 
        width: 100%;
        left: 0%;
        opacity: 0.8;
      }
      100% { 
        width: 100%;
        left: 0%;
        opacity: 0;
      }
    }

    .arrow-top::after, .arrow-bottom::after {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, 
          rgba(255, 180, 180, 0.4), 
          rgba(255, 200, 160, 0.4), 
          rgba(255, 255, 200, 0.5), 
          rgba(200, 255, 200, 0.4), 
          rgba(200, 230, 255, 0.5), 
          rgba(230, 200, 255, 0.4), 
          rgba(255, 200, 230, 0.4), 
          rgba(255, 255, 255, 0.7));
      opacity: 0;
      z-index: 2;
      animation: arrow-rainbow-sweep 2s infinite;
      pointer-events: none;
      -webkit-clip-path: path('M52.5 35 Q40 35 40 50 Q40 65 52.5 65 L269.5 65 L269.5 85 L336 50 L269.5 15 L269.5 35 Z');
      clip-path: path('M52.5 35 Q40 35 40 50 Q40 65 52.5 65 L269.5 65 L269.5 85 L336 50 L269.5 15 L269.5 35 Z');
      border-radius: 0;
    }

    .arrow-bottom::after {
      -webkit-clip-path: path('M42 28 Q30 28 30 40 Q30 52 42 52 L210 52 L210 68 L268 40 L210 12 L210 28 Z');
      clip-path: path('M42 28 Q30 28 30 40 Q30 52 42 52 L210 52 L210 68 L268 40 L210 12 L210 28 Z');
    }

    .arrow-top {
      top: -70px;
      left: -120px;
      animation-delay: 0.2s;
    }

    .arrow-bottom {
      top: 10px;
      left: -90px;
      animation-delay: 0.5s;
    }

    .arrow-top svg, .arrow-bottom svg {
      fill: url(#arrow-gradient);
      filter: drop-shadow(0 4px 8px rgba(163, 213, 255, 0.4));
      position: relative;
    }

    @keyframes arrowCreate {
      0% { 
        opacity: 0;
        transform: scale(0) rotate(-10deg);
      }
      50% {
        opacity: 0.7;
        transform: scale(1.1) rotate(2deg);
      }
      100% { 
        opacity: 1;
        transform: scale(1) rotate(0deg);
      }
    }

    /* Hide arrows on mobile */
    @media (max-width: 768px) {
      .try-on-arrows {
        display: none !important;
      }
    }

    .action-btn-small {
      background: #333;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 20px;
      font-size: 0.9em;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .action-btn-small:hover {
      background: #555;
      transform: translateY(-2px);
    }

    /* Try On Container Animations */
    .modal-content {
      background-color: #fff;
      margin: 5% auto;
      padding: 1.5rem;
      border: 1px solid #888;
      width: 90%;
      max-width: 300px;
      border-radius: 15px;
      text-align: center;
      position: relative;
      animation: fadeInSlide 0.4s ease;
      transition: transform 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    }

    /* Mobile: Swipe up animation */
    @media (max-width: 768px) {
      .modal-content.try-on-swipe-up {
        animation: swipeUpMobile 1.2s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
      }
      
      @keyframes swipeUpMobile {
        0% {
          transform: translateY(0);
          opacity: 1;
        }
        100% {
          transform: translateY(-100vh);
          opacity: 0;
        }
      }
    }

    /* Final Result Screen */
    .final-result-screen {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      z-index: 2000;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      opacity: 0;
      transition: opacity 1s ease;
    }

    .final-result-screen.show {
      opacity: 1;
    }

    .final-result-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      max-width: 90%;
      max-height: 90%;
      transform: translateY(50px);
      transition: transform 1s ease;
    }

    .final-result-screen.show .final-result-container {
      transform: translateY(0);
    }

    .final-result-image {
      max-width: 400px;
      max-height: 500px;
      width: auto;
      height: auto;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(255, 255, 255, 0.2);
      margin: 20px 0;
    }

    .final-result-actions-top {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
    }

    .final-result-actions-bottom {
      margin-top: 20px;
    }

    .buy-btn {
      background: linear-gradient(135deg, #a3d5ff 0%, rgba(255, 255, 255, 0.9) 100%);
      color: #fff;
      border: none;
      padding: 1rem 2rem;
      cursor: pointer;
      font-size: 1.1rem;
      border-radius: 30px;
      transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      touch-action: manipulation;
      position: relative;
      overflow: hidden;
      box-shadow: 0 10px 30px rgba(163, 213, 255, 0.4);
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 2px;
      min-width: 200px;
    }

    .buy-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, 
          transparent, 
          rgba(255, 180, 180, 0.35), 
          rgba(255, 200, 160, 0.35), 
          rgba(255, 255, 200, 0.35), 
          rgba(200, 255, 200, 0.4), 
          rgba(200, 230, 255, 0.4), 
          rgba(230, 200, 255, 0.35), 
          rgba(255, 200, 230, 0.35), 
          rgba(255, 255, 255, 0.5),
          transparent);
      opacity: 1;
      z-index: 1;
      animation: glacier-rainbow-sweep 4s infinite;
    }

    .buy-btn:hover:not(:disabled) {
      transform: translateY(-5px) scale(1.03);
      box-shadow: 0 20px 40px rgba(163, 213, 255, 0.6);
      background: linear-gradient(135deg, #87ceeb 0%, rgba(255, 255, 255, 0.95) 100%);
    }

    .buy-btn:active:not(:disabled) {
      transform: translateY(-2px) scale(0.98);
      box-shadow: 0 10px 25px rgba(163, 213, 255, 0.4);
    }

    @media (max-width: 768px) {
      .final-result-image {
        max-width: 300px;
        max-height: 400px;
      }
      
      .final-result-actions-top {
        gap: 15px;
      }
      
      .buy-btn {
        padding: 0.8rem 1.5rem;
        font-size: 1rem;
        min-width: 150px;
      }
    }

    /* Desktop: Move left and reduce height animation */
    @media (min-width: 769px) {
      .modal-content.try-on-move-left {
        animation: moveLeftAndReduceDesktop 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
      }
      
      @keyframes moveLeftAndReduceDesktop {
        0% {
          transform: translateX(0);
          height: auto;
          min-height: auto;
        }
        100% {
          transform: translateX(-150px);
          height: 380px; /* Balanced height - shows full image with compact white space */
          min-height: 380px;
          overflow: hidden;
        }
      }
    }
    
    /* Media Queries for Responsiveness */
    @media (max-width: 768px) {
      header {
        justify-content: space-between;
        padding: 10px 15px;
      }
    
      .menu-toggle {
        display: flex;
      }
    
      header nav {
        position: fixed;
        top: 0;
        right: -100%;
        width: 80%;
        max-width: 300px;
        height: 100vh;
        background-color: white;
        z-index: 100;
        transition: right 0.3s ease;
        box-shadow: -5px 0 15px rgba(0,0,0,0.1);
        padding: 80px 20px 20px;
      }
      
      header nav.active {
        right: 0;
      }
      
      header nav ul {
        flex-direction: column;
      }
      
      header nav ul li {
        margin-right: 0;
        margin-bottom: 15px;
      }
      
      .basket-desktop { display: none !important; }
      .basket-mobile { display: block !important; }
      #basketDropdown {
        right: 10px !important;
        left: 10px !important;
        min-width: unset !important;
        max-width: 95vw !important;
      }
      
      .products {
        grid-template-columns: repeat(2, 1fr);
        gap: 15px;
        padding: 15px;
      }
      
      .product {
        min-height: 180px;
        padding: 10px;
      }
      
      .image-container {
        height: 150px;
      }
      
      .product-name {
        font-size: 1em;
      }
      
      .product-price {
        font-size: 0.9em;
      }
      
      .modal-content {
        width: 95%;
        max-width: 350px;
        padding: 1rem;
      }
      
      #modalProductImage {
        max-width: 200px;
      }
      
      .proceed-btn {
        padding: 0.8rem 1rem;
        font-size: 0.9rem;
      }
    }
    
    @media (max-width: 480px) {
      .products {
        grid-template-columns: 1fr;
        gap: 10px;
        padding: 10px;
      }
      
      .product {
        min-height: 160px;
        padding: 8px;
      }
      
      .image-container {
        height: 120px;
      }
      
      .product-name {
        font-size: 0.9em;
      }
      
      .product-price {
        font-size: 0.8em;
      }
      
      .main-title {
        font-size: 1.5em;
        margin: 15px 0;
      }
      
      #searchInput {
        width: 95%;
        padding: 8px 12px;
        font-size: 0.9em;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="logo">
      <h1>Fitrite</h1>
      <p>Leather Jackets</p>
    </div>
    <nav id="mobileNav">
      <ul>
        <li><a href="index.html">Home</a></li>
        <li><a href="bags.html">Bags</a></li>
        <li><a href="belts.html">Belts</a></li>
        <li><a href="scarves.html">Scarves</a></li>
        <li><a href="leather_jackets.html">Leather Jackets</a></li>
        <li class="basket-mobile">
          <a href="#" class="basket-mobile-btn" onclick="toggleBasketMobile(event)">
            <span>Basket</span>
            <span id="basketCountMobile" style="display: none; background: red; color: white; border-radius: 50%; padding: 2px 6px; font-size: 0.8em; margin-left: 5px;">0</span>
          </a>
          <div id="basketDropdownMobile" style="display: none; background: white; border-radius: 15px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); margin-top: 10px; padding: 15px 10px 5px 10px; max-height: 250px; overflow-y: auto;">
            <div id="basketItemsMobile"></div>
            <div id="basketDropdownFooterMobile" style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #eee;">
              <button id="clearBasketBtnMobile" style="background: #c00; color: white; border: none; padding: 8px 15px; border-radius: 20px; font-size: 0.9em; cursor: pointer; width: 100%;">Clear Basket</button>
            </div>
          </div>
        </li>
        <li class="basket-desktop">
          <a href="#" onclick="toggleBasket(event)">
            Basket
            <span id="basketCount" style="display: none; background: red; color: white; border-radius: 50%; padding: 2px 6px; font-size: 0.8em; margin-left: 5px;">0</span>
          </a>
          <div id="basketDropdown" style="display: none; position: absolute; right: 15px; background: white; border-radius: 15px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); margin-top: 10px; padding: 15px 10px 5px 10px; min-width: 300px; max-width: 400px; z-index: 1000; max-height: 400px; overflow-y: auto;">
            <div id="basketItems"></div>
            <div id="basketDropdownFooter" style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #eee;">
              <button id="clearBasketBtn" style="background: #c00; color: white; border: none; padding: 8px 15px; border-radius: 20px; font-size: 0.9em; cursor: pointer; width: 100%;">Clear Basket</button>
            </div>
          </div>
        </li>
      </ul>
    </nav>
    <div class="menu-toggle" id="menuToggle">
      <span></span>
      <span></span>
      <span></span>
    </div>
  </header>

  <div id="search-bar">
    <input type="text" id="searchInput" placeholder="Search leather jackets..." onkeyup="filterProducts()">
  </div>

  <h1 class="main-title">New Leather Jackets</h1>

  <div class="products" id="products-container">
    <!-- Products will be dynamically loaded here -->
  </div>

  <footer>
    <p>&copy; 2024 Fitrite. All rights reserved.</p>
  </footer>

  <!-- Modal (Pop-up) -->
  <div id="productModal" class="modal">
    <div class="modal-content">
      <span class="close-btn" id="closeModal">&times;</span>
      <img id="modalProductImage" src="" alt="">
      <h3 id="modalProductName" class="fade-out-element"></h3>
      <p id="modalProductPrice" class="fade-out-element"></p>
      <p style="margin: 1rem 0;" class="fade-out-element">Would you like to proceed with this product?</p>
      <button id="addToBasket" class="proceed-btn fade-out-element">Add to Basket</button>
      <button id="proceedToPayment" class="proceed-btn fade-out-element">Go to Payment Page</button>
      <select id="sizeSelector" class="proceed-btn fade-out-element">
        <option value="S">S</option>
        <option value="M" selected>M</option>
        <option value="L">L</option>
        <option value="XL">XL</option>
      </select>
      <button id="tryOnBtn" class="try-on-btn fade-out-element">
        Try On
      </button>
    </div>
  </div>

  <!-- Model Upload Section (Hidden Initially) -->
  <div id="modelUploadSection" class="model-upload-section">
    <div class="upload-container">
      <h2 class="upload-title">CLICK HERE TO ADD YOUR PHOTO</h2>
      <div class="person-upload-area" id="personUploadArea">
        <div class="person-upload-inner" id="personUploadInner">
          <div class="upload-prompt" id="uploadPrompt">
            <div class="upload-icon">
              <svg width="80" height="80" viewBox="0 0 120 120" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <!-- Flash unit (big flash on top) -->
                <rect x="35" y="5" width="50" height="25" rx="8" ry="8" fill="none"/>
                <rect x="40" y="10" width="40" height="15" rx="4" ry="4" fill="none"/>
                <!-- Flash reflector -->
                <ellipse cx="60" cy="17.5" rx="15" ry="8" fill="none" opacity="0.3"/>
                <!-- Flash connection -->
                <rect x="55" y="30" width="10" height="8" rx="2" ry="2"/>
                
                <!-- Camera body main -->
                <rect x="20" y="38" width="80" height="55" rx="6" ry="6"/>
                <!-- Camera top plate -->
                <rect x="25" y="33" width="70" height="10" rx="3" ry="3"/>
                
                <!-- Viewfinder prism -->
                <rect x="45" y="28" width="30" height="8" rx="2" ry="2"/>
                <rect x="50" y="25" width="20" height="6" rx="2" ry="2"/>
                
                <!-- Main lens mount -->
                <circle cx="60" cy="65" r="22"/>
                <!-- Lens outer ring -->
                <circle cx="60" cy="65" r="18"/>
                <!-- Lens middle ring -->
                <circle cx="60" cy="65" r="14"/>
                <!-- Lens inner -->
                <circle cx="60" cy="65" r="10"/>
                <!-- Lens center -->
                <circle cx="60" cy="65" r="6"/>
                <!-- Lens reflection -->
                <circle cx="57" cy="62" r="3" fill="currentColor" opacity="0.2"/>
                
                <!-- Camera controls -->
                <circle cx="85" cy="45" r="3"/>
                <circle cx="85" cy="55" r="2"/>
                <rect x="82" y="65" width="6" height="4" rx="1"/>
                
                <!-- Brand plate -->
                <rect x="25" y="45" width="25" height="6" rx="1" opacity="0.4"/>
                
                <!-- Camera grip texture -->
                <line x1="25" y1="50" x2="25" y2="85"/>
                <line x1="27" y1="52" x2="27" y2="83"/>
                <line x1="29" y1="54" x2="29" y2="81"/>
                
                <!-- Film advance lever -->
                <path d="M 90 40 Q 95 35 100 40" fill="none"/>
                
                <!-- Hot shoe -->
                <rect x="55" y="30" width="10" height="3" rx="1"/>
              </svg>
            </div>
          </div>
        </div>
        <img id="personPhotoPreview" class="person-photo-preview" alt="Person Preview">
        <div class="result-in-place" id="resultInPlace">
          <img id="resultImageInPlace" class="result-image-in-place" alt="Virtual Try-On Result">
          <button class="result-back-btn" id="resultBackBtn" title="Remove item">←</button>
        </div>
        <div class="processing-overlay-local" id="processingOverlayLocal">
          <div class="processing-content-local">
            <div class="processing-spinner"></div>
            <div class="processing-text" id="processingTextLocal">Connecting to AI servers</div>
            <div class="processing-subtext" id="processingSubtextLocal"></div>
            <div class="progress-bar">
              <div class="progress-fill" id="progressFillLocal"></div>
            </div>
          </div>
        </div>
        <button class="remove-photo-btn" id="removePhotoBtn">×</button>
        <input type="file" id="personFileInput" class="file-input" accept="image/*">
      </div>
    </div>
    <button class="continue-btn" id="continueBtn" disabled>Activate AI</button>
    <div class="result-actions-external" id="resultActionsExternal">
      <button class="share-circle-btn" id="shareBtnSmall">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="18" cy="5" r="3"></circle>
          <circle cx="6" cy="12" r="3"></circle>
          <circle cx="18" cy="19" r="3"></circle>
          <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line>
          <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line>
        </svg>
      </button>
      <button class="restart-circle-btn" id="tryAgainBtnSmall">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="23 4 23 10 17 10"></polyline>
          <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
        </svg>
      </button>
    </div>
  </div>

  <!-- Try On Arrows -->
  <div id="tryOnArrows" class="try-on-arrows">
    <div class="arrow-top">
      <svg width="350" height="100" viewBox="0 0 350 100" fill="none">
        <defs>
          <linearGradient id="arrow-gradient" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" style="stop-color:#a3d5ff;stop-opacity:1" />
            <stop offset="100%" style="stop-color:rgba(255, 255, 255, 0.9);stop-opacity:1" />
          </linearGradient>
          <clipPath id="arrow-clip-top">
            <path d="M52.5 35 Q40 35 40 50 Q40 65 52.5 65 L269.5 65 L269.5 85 L336 50 L269.5 15 L269.5 35 Z"/>
          </clipPath>
        </defs>
        <!-- Arrow body with rounded left edge -->
        <path d="M30 35 Q15 35 15 50 Q15 65 30 65 L270 65 L270 85 L335 50 L270 15 L270 35 Z" fill="url(#arrow-gradient)" stroke="url(#arrow-gradient)" stroke-width="4" clip-path="url(#arrow-clip-top)"/>
      </svg>
    </div>
    <div class="arrow-bottom">
      <svg width="280" height="80" viewBox="0 0 280 80" fill="none">
        <defs>
          <linearGradient id="arrow-gradient-2" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" style="stop-color:#a3d5ff;stop-opacity:1" />
            <stop offset="100%" style="stop-color:rgba(255, 255, 255, 0.9);stop-opacity:1" />
          </linearGradient>
          <clipPath id="arrow-clip-bottom">
            <path d="M42 28 Q30 28 30 40 Q30 52 42 52 L210 52 L210 68 L268 40 L210 12 L210 28 Z"/>
          </clipPath>
        </defs>
        <!-- Arrow body with rounded left edge -->
        <path d="M24 28 Q12 28 12 40 Q12 52 24 52 L210 52 L210 68 L268 40 L210 12 L210 28 Z" fill="url(#arrow-gradient-2)" stroke="url(#arrow-gradient-2)" stroke-width="3.5" clip-path="url(#arrow-clip-bottom)"/>
      </svg>
    </div>
  </div>

  <!-- Toast Notification -->
  <div id="toast">Product added to basket!</div>

  <!-- Final Result Screen -->
  <div id="finalResultScreen" class="final-result-screen">
    <div class="final-result-container">
      <div class="final-result-actions-top">
        <button class="share-circle-btn" id="finalShareBtn">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="18" cy="5" r="3"></circle>
            <circle cx="6" cy="12" r="3"></circle>
            <circle cx="18" cy="19" r="3"></circle>
            <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line>
            <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line>
          </svg>
        </button>
        <button class="restart-circle-btn" id="finalTryAgainBtn">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="23 4 23 10 17 10"></polyline>
            <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
          </svg>
        </button>
      </div>
      
      <img id="finalResultImage" class="final-result-image" alt="Final Try-On Result">
      
      <div class="final-result-actions-bottom">
        <button class="buy-btn" id="finalBuyBtn">BUY</button>
      </div>
    </div>
  </div>

  <script>
    // Fashn.ai API Handler Module
    class FashnAPIHandler {
      constructor(apiKey) {
        this.apiKey = apiKey;
        this.baseURL = 'https://api.fashn.ai/v1';
        this.maxRetries = 3;
        this.retryDelay = 1000;
      }

      async makeRequest(endpoint, options = {}) {
        const url = `${this.baseURL}${endpoint}`;
        const defaultOptions = {
          headers: {
            'Authorization': `Bearer ${this.apiKey}`,
            'Content-Type': 'application/json',
            ...options.headers
          }
        };

        const requestOptions = { ...defaultOptions, ...options };

        for (let attempt = 1; attempt <= this.maxRetries; attempt++) {
          try {
            console.log(`Attempt ${attempt}/${this.maxRetries} for ${endpoint}`);
            
            const response = await fetch(url, requestOptions);
            
            if (!response.ok) {
              const errorText = await response.text();
              throw new Error(`HTTP ${response.status}: ${errorText}`);
            }

            const data = await response.json();
            console.log('API Response:', data);
            return data;

          } catch (error) {
            console.error(`Error on attempt ${attempt}:`, error);
            
            if (attempt === this.maxRetries) {
              throw error;
            }
            
            await this.delay(this.retryDelay * attempt);
          }
        }
      }

      delay(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
      }

      async startTryOn(modelImage, garmentImage, options = {}) {
        const requestData = {
          model_name: options.modelVersion || 'tryon-v1.6',
          inputs: {
            model_image: modelImage,
            garment_image: garmentImage,
            category: options.category || 'auto',
            segmentation_free: options.segmentationFree !== false,
            moderation_level: options.moderationLevel || 'conservative'
          }
        };

        console.log('Sending try-on request:', requestData);

        const result = await this.makeRequest('/run', {
          method: 'POST',
          body: JSON.stringify(requestData)
        });

        return result.id;
      }

      async checkStatus(predictionId) {
        const result = await this.makeRequest(`/status/${predictionId}`);
        return result;
      }

      async waitForResult(predictionId, onProgress = null) {
        const maxAttempts = 60;
        const pollInterval = 2000;
        
        for (let attempt = 1; attempt <= maxAttempts; attempt++) {
          try {
            const status = await this.checkStatus(predictionId);
            
            if (onProgress) {
              onProgress({
                attempt,
                maxAttempts,
                status: status.status,
                progress: Math.round((attempt / maxAttempts) * 100)
              });
            }

            if (status.status === 'completed') {
              return {
                success: true,
                output: status.output,
                metadata: status
              };
            } else if (status.status === 'failed') {
              return {
                success: false,
                error: status.error || 'Processing failed',
                metadata: status
              };
            }

            if (attempt < maxAttempts) {
              await this.delay(pollInterval);
            }

          } catch (error) {
            console.error(`Error in polling (attempt ${attempt}):`, error);
            
            if (attempt === maxAttempts) {
              return {
                success: false,
                error: `Timeout after ${maxAttempts} attempts: ${error.message}`,
                metadata: null
              };
            }
            
            await this.delay(pollInterval);
          }
        }

        return {
          success: false,
          error: 'Timeout: processing took too long',
          metadata: null
        };
      }

      async processTryOn(modelImage, garmentImage, options = {}) {
        try {
          const predictionId = await this.startTryOn(modelImage, garmentImage, options);
          const result = await this.waitForResult(predictionId, options.onProgress);
          return result;

        } catch (error) {
          console.error('Error in complete processing:', error);
          return {
            success: false,
            error: error.message,
            metadata: null
          };
        }
      }

      async optimizeImage(imageDataURL, maxWidth = 1024, maxHeight = 1024, quality = 0.8) {
        return new Promise((resolve, reject) => {
          const img = new Image();
          
          img.onload = () => {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');

            let { width, height } = img;
            const aspectRatio = width / height;

            if (width > maxWidth || height > maxHeight) {
              if (aspectRatio > 1) {
                width = Math.min(width, maxWidth);
                height = width / aspectRatio;
              } else {
                height = Math.min(height, maxHeight);
                width = height * aspectRatio;
              }
            }

            canvas.width = width;
            canvas.height = height;
            ctx.drawImage(img, 0, 0, width, height);

            canvas.toBlob(
              (blob) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.readAsDataURL(blob);
              },
              'image/jpeg',
              quality
            );
          };

          img.onerror = reject;
          img.src = imageDataURL;
        });
      }
    }

    // Initialize FASHN API
    const FASHN_API_KEY = 'fa-BWEKaWHoO0YD-KDW0kUKgK6eEPOzgKh0M1oC0'; // Real FASHN.AI API key
    
    // Validate API key
    if (!FASHN_API_KEY || FASHN_API_KEY === 'your-fashn-api-key-here') {
      console.warn('⚠️ FASHN.AI API key not configured. Please set FASHN_API_KEY.');
    } else {
      console.log('✅ FASHN.AI API key configured successfully');
    }
    
    const fashnAPI = new FashnAPIHandler(FASHN_API_KEY);

    // Add validation function
    function validateAPIConfiguration() {
      if (!FASHN_API_KEY || FASHN_API_KEY === 'your-fashn-api-key-here') {
        throw new Error('FASHN.AI API key not configured. Please contact support.');
      }
    }
    // Mobile Menu Toggle
    const menuToggle = document.getElementById("menuToggle");
    const mobileNav = document.getElementById("mobileNav");
    
    if (menuToggle && mobileNav) {
      menuToggle.addEventListener("click", () => {
        mobileNav.classList.toggle("active");
      });
    }
    
    // Filter Products
    function filterProducts() {
      const searchInput = document.getElementById("searchInput").value.toLowerCase();
      const productElements = document.querySelectorAll(".product");
      productElements.forEach((productEl) => {
        const nameText = productEl.querySelector(".product-name")?.textContent.toLowerCase() || "";
        const priceText = productEl.querySelector(".product-price")?.textContent.toLowerCase() || "";
        productEl.style.display = (nameText.includes(searchInput) || priceText.includes(searchInput))
          ? "flex"
          : "none";
      });
    }
    
    // Modal Logic
    const modal = document.getElementById("productModal");
    const closeModalBtn = document.getElementById("closeModal");
    const modalProductImage = document.getElementById("modalProductImage");
    const modalProductName = document.getElementById("modalProductName");
    const modalProductPrice = document.getElementById("modalProductPrice");
    const sizeSelector = document.getElementById("sizeSelector");
    
    function openModal(name, price, imgUrl, isDiscounted = false, originalPrice = null) {
      modalProductName.textContent = name;
      
      if (isDiscounted && originalPrice) {
        modalProductPrice.innerHTML = `<span class="original-price">${originalPrice}</span> <span class="new-price">${price}</span>`;
      } else {
        modalProductPrice.textContent = price;
      }
      
      modalProductImage.src = imgUrl;
      modalProductImage.alt = name;
      modal.classList.add("show");
      modal.style.display = "flex";
      
      // Store current product data for later use
      currentProductData = {
        name: name,
        price: price,
        imgUrl: imgUrl,
        isDiscounted: isDiscounted,
        originalPrice: originalPrice
      };
      
      // Reset fade out elements and container animations when opening modal
      const fadeOutElements = document.querySelectorAll('.fade-out-element');
      const modalContent = document.querySelector('.modal-content');
      
      fadeOutElements.forEach(element => {
        element.classList.remove('hidden');
      });
      
      // Remove any previous animation classes
      modalContent.classList.remove('try-on-swipe-up', 'try-on-container-fadeout');
      
      // Remove floating image if exists
      const floatingImage = document.getElementById('floatingProductImage');
      if (floatingImage) {
        floatingImage.remove();
      }
      
      // Reset original image opacity
      const originalImage = document.getElementById('modalProductImage');
      if (originalImage) {
        originalImage.style.opacity = '1';
      }
      
      // Reset model upload section
      hideModelUpload();
    }
    
    function closeModal() {
      modal.classList.remove("show");
      // Hide try-on arrows when modal closes
      document.getElementById('tryOnArrows').classList.remove('show');
      
      // Clean up try-on framework elements
      const modelUploadSection = document.getElementById("modelUploadSection");
      const finalResultScreen = document.getElementById("finalResultScreen");
      
      // Fade away model upload section
      if (modelUploadSection) {
        modelUploadSection.classList.remove("show", "scroll-up");
        modelUploadSection.style.transition = "opacity 0.6s ease-out";
        modelUploadSection.style.opacity = "0";
        
        setTimeout(() => {
          modelUploadSection.style.display = "none";
        }, 600);
      }
      
      // Hide final result screen
      if (finalResultScreen.classList.contains("show")) {
        finalResultScreen.classList.remove('show');
        setTimeout(() => {
          finalResultScreen.style.display = 'none';
        }, 1000);
      }
      
      // Remove floating image if exists
      const floatingImage = document.getElementById('floatingProductImage');
      if (floatingImage) {
        floatingImage.remove();
      }
      
      // Reset modal content animations
      const modalContent = document.querySelector('.modal-content');
      if (modalContent) {
        modalContent.classList.remove('try-on-swipe-up', 'try-on-container-fadeout');
      }
      
      // Reset fade out elements
      const fadeOutElements = document.querySelectorAll('.fade-out-element');
      fadeOutElements.forEach(element => {
        element.classList.remove('hidden');
      });
      
      // Reset original image opacity
      const originalImage = document.getElementById('modalProductImage');
      if (originalImage) {
        originalImage.style.opacity = '1';
      }
      
      setTimeout(() => { modal.style.display = "none"; }, 400);
    }
    closeModalBtn.onclick = () => closeModal();
    
    // Close modal when clicking outside modal content
    modal.addEventListener("click", (event) => {
      if (!event.target.closest(".modal-content")) {
        closeModal();
      }
    });
    
    // Close modal when clicking outside modal content
    modal.addEventListener("click", (event) => {
      if (!event.target.closest(".modal-content")) {
        closeModal();
      }
    });
    
    // Firebase Cart Integration
    let currentProductData = null;
    
    // Function to extract product data from modal
    function extractProductFromModal() {
      const name = modalProductName.textContent;
      const priceElement = modalProductPrice.querySelector(".new-price");
      const price = priceElement ? priceElement.textContent : modalProductPrice.textContent;
      const imgUrl = modalProductImage.src;
      const selectedSize = sizeSelector.value;
      
      // Convert price to cents (remove £ and convert to number)
      const priceInCents = parseInt(price.replace(/[£,]/g, '')) * 100;
      
      // Create a consistent ID based on name and size to prevent duplicates
      const consistentId = `belt_${name.replace(/[^a-zA-Z0-9]/g, '_')}_${selectedSize.replace(/[^a-zA-Z0-9]/g, '_')}`;
      
      return {
        id: consistentId,
        name: name,
        price: priceInCents,
        image: imgUrl,
        category: 'belts',
        selectedSize: selectedSize
      };
    }
    
    // Firebase cart function
    async function addToBasketFirebase() {
      try {
        if (!window.FitRightFirebase) {
          console.error('FitRightFirebase not loaded');
          return;
        }
        
        const productData = extractProductFromModal();
        
        // Check if item already exists in cart
        const cartItems = window.FitRightFirebase.getCartItems();
        const existingItem = cartItems.find(item => 
          item.name === productData.name && 
          item.selectedSize === productData.selectedSize
        );
        
        if (existingItem) {
          // Update quantity of existing item
          await window.FitRightFirebase.updateQuantity(existingItem.id || existingItem.productId, (existingItem.quantity || 1) + 1);
          showToast("Product quantity updated in basket!");
        } else {
          // Add new item
          await window.FitRightFirebase.addProductToCart(productData, 1);
          showToast("Product added to basket!");
        }
        
        closeModal();
      } catch (error) {
        console.error('Error adding to cart:', error);
        showToast("Error adding to basket!");
      }
    }
    
    // Basket Handling & Toast Notification
    function addToBasket(name, price, imgUrl, size, showMessage = true) {
      let basket = JSON.parse(localStorage.getItem("basket")) || [];
      const existingIndex = basket.findIndex(item => item.name === name);
      if (existingIndex !== -1) {
        const item = basket[existingIndex];
        item.quantity = (item.quantity || 1) + 1;
        localStorage.setItem("basket", JSON.stringify(basket));
        
        // Immediately update the basket counter
        const totalCount = basket.reduce((sum, item) => sum + (item.quantity || 1), 0);
        basketCount.textContent = totalCount;
        basketCount.style.display = 'inline-block';
        if (basketCountMobile) {
          basketCountMobile.textContent = totalCount;
          basketCountMobile.style.display = 'inline-block';
        }
        
        updateBasketDropdown();
        if (showMessage) showToast("Product quantity updated in basket!");
      } else {
        basket.push({ name, newPrice: price, imgUrl, size, quantity: 1 });
        localStorage.setItem("basket", JSON.stringify(basket));
        
        // Immediately update the basket counter
        const totalCount = basket.reduce((sum, item) => sum + (item.quantity || 1), 0);
        basketCount.textContent = totalCount;
        basketCount.style.display = 'inline-block';
        if (basketCountMobile) {
          basketCountMobile.textContent = totalCount;
          basketCountMobile.style.display = 'inline-block';
        }
        
        updateBasketDropdown();
        if (showMessage) showToast("Product added to basket!");
      }
    }
    
    document.getElementById("addToBasket").onclick = function () {
      // Use Firebase if available, otherwise fallback to localStorage
      if (window.FitRightFirebase) {
        addToBasketFirebase();
        closeModal();
      } else {
        const name = modalProductName.textContent;
        const priceElement = modalProductPrice.querySelector(".new-price");
        const price = priceElement ? priceElement.textContent : modalProductPrice.textContent;
        const imgUrl = modalProductImage.src;
        const selectedSize = sizeSelector.value;
        addToBasket(name, price, imgUrl, selectedSize, true);
        closeModal();
      }
    };
    
    document.getElementById("proceedToPayment").onclick = function() {
      const name = modalProductName.textContent;
      const priceElement = modalProductPrice.querySelector(".new-price");
      const price = priceElement ? priceElement.textContent : modalProductPrice.textContent;
      const imageUrl = modalProductImage.src;
      const selectedSize = sizeSelector.value;
      const queryString = `?name=${encodeURIComponent(name)}&price=${encodeURIComponent(price)}&imgUrl=${encodeURIComponent(imageUrl)}&size=${encodeURIComponent(selectedSize)}`;
      window.location.href = "page3.html" + queryString;
    };

    // Try On Button Functionality
    document.getElementById('tryOnBtn').addEventListener('click', function() {
      // First: Fade out all elements
      const fadeOutElements = document.querySelectorAll('.fade-out-element');
      fadeOutElements.forEach(element => {
        element.classList.add('hidden');
      });

      // After fade out delay, start container animations
      setTimeout(() => {
        const modalContent = document.querySelector('.modal-content');
        const productImage = document.getElementById('modalProductImage');
        
        if (window.innerWidth <= 768) {
          // Mobile: Swipe up animation
          modalContent.classList.add('try-on-swipe-up');
        } else {
          // Desktop: Extract image first, then fade out container
          if (productImage) {
            // Get current position and size of image
            const imageRect = productImage.getBoundingClientRect();
            const modalRect = document.getElementById('productModal').getBoundingClientRect();
            
            // Clone the image and position it absolutely
            const imageClone = productImage.cloneNode(true);
            imageClone.id = 'floatingProductImage';
            imageClone.style.position = 'fixed';
            imageClone.style.left = imageRect.left + 'px';
            imageClone.style.top = imageRect.top + 'px';
            imageClone.style.width = imageRect.width + 'px';
            imageClone.style.height = imageRect.height + 'px';
            imageClone.style.zIndex = '1003';
            imageClone.style.transition = 'all 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
            imageClone.style.borderRadius = '15px';
            imageClone.style.boxShadow = '0 8px 32px rgba(0, 0, 0, 0.15)';
            imageClone.style.objectFit = 'contain';
            
            // Add clone to body
            document.body.appendChild(imageClone);
            
            // Hide original image
            productImage.style.opacity = '0';
            
            // Animate clone to left position after a short delay
            setTimeout(() => {
              const leftX = modalRect.left + modalRect.width * 0.25; // Adjust for horizontal alignment
              const centerY = modalRect.top + modalRect.height / 2; // Same vertical center as upload container
              
              imageClone.style.left = leftX + 'px';
              imageClone.style.top = centerY + 'px';
              imageClone.style.width = '300px';
              imageClone.style.height = 'auto'; // Let height adjust naturally
              imageClone.style.transform = 'translate(0, -50%)'; // Center vertically
            }, 100);
          }
          
          // Container fade out
          modalContent.classList.add('try-on-container-fadeout');
        }

        // Show model upload section after container animation
        setTimeout(() => {
          showModelUpload();
        }, 600);
      }, 700);
    });

    // Final Result Screen Event Listeners
    document.getElementById('finalTryAgainBtn').addEventListener('click', showTryOnInterface);
    document.getElementById('finalShareBtn').addEventListener('click', shareResult);
    document.getElementById('finalBuyBtn').addEventListener('click', buyProduct);

    // Small Result Buttons Event Listeners
    document.getElementById('tryAgainBtnSmall').addEventListener('click', function() {
      hideResultInPlace();
      hideModelUpload();
      if (personFile) {
        removePersonPhoto();
      }
    });
    document.getElementById('shareBtnSmall').addEventListener('click', shareResult);

    // Other Event Listeners
    document.getElementById('resultBackBtn').addEventListener('click', toggleResultView);
    document.getElementById('continueBtn').addEventListener('click', startTryOn);

    // Model Upload Functionality
    let personFile = null;
    let resultImageUrl = null;
    let isProcessing = false;

    function showModelUpload() {
      const modelUploadSection = document.getElementById('modelUploadSection');
      
      // Reset any inline styles that may have been applied when closing
      modelUploadSection.style.display = '';
      modelUploadSection.style.opacity = '';
      modelUploadSection.style.transition = '';
      
      if (window.innerWidth <= 768) {
        // Mobile: Show with scroll up animation
        modelUploadSection.classList.add('show', 'scroll-up');
      } else {
        // Desktop: Show with simple slide in animation
        modelUploadSection.classList.add('show');
        // Show try-on arrows immediately on desktop
        document.getElementById('tryOnArrows').classList.add('show');
      }
      
      // GARANTIR que o botão Execute AI apareça se há foto
      setTimeout(() => {
        ensureExecuteAIButtonVisible();
      }, 100);
    }

    function hideModelUpload() {
      const modelUploadSection = document.getElementById('modelUploadSection');
      modelUploadSection.classList.remove('show', 'scroll-up');
      // Não remove a foto automaticamente - deixa isso para funções específicas
    }

    // Person upload area click
    document.getElementById('personUploadArea').addEventListener('click', () => {
      if (!personFile) {
        document.getElementById('personFileInput').click();
      }
    });

    // File input change
    document.getElementById('personFileInput').addEventListener('change', (e) => {
      if (e.target.files.length > 0) {
        handlePersonFileSelect(e.target.files[0]);
        
        // FALLBACK ADICIONAL: Garantir botão após processamento do arquivo
        setTimeout(() => {
          ensureExecuteAIButtonVisible();
        }, 1500);
      }
    });

    // Remove photo button
    document.getElementById('removePhotoBtn').addEventListener('click', () => {
      removePersonPhoto();
    });

    // Continue button
    document.getElementById('continueBtn').addEventListener('click', () => {
      startTryOn();
    });

    // Result actions
    document.getElementById('shareBtnSmall').addEventListener('click', () => {
      shareResult();
    });

    document.getElementById('resultBackBtn').addEventListener('click', () => {
      toggleResultView();
    });

    function handlePersonFileSelect(file) {
      if (!validateFile(file)) {
        return;
      }

      personFile = file;
      console.log('📷 Foto selecionada, garantindo que botão Execute AI apareça...');
      
      const reader = new FileReader();
      reader.onload = (e) => {
        // Fade out the upload prompt and title
        const uploadPrompt = document.getElementById('uploadPrompt');
        const uploadTitle = document.querySelector('.upload-title');
        const personUploadInner = document.getElementById('personUploadInner');
        const uploadContainer = document.querySelector('.upload-container');
        const personUploadArea = document.getElementById('personUploadArea');
        
        // Start fade out animation
        uploadPrompt.style.transition = 'opacity 0.6s ease-out';
        uploadTitle.style.transition = 'opacity 0.6s ease-out';
        personUploadInner.style.transition = 'opacity 0.6s ease-out';
        
        uploadPrompt.style.opacity = '0';
        uploadTitle.style.opacity = '0';
        personUploadInner.style.opacity = '0';
        
        // After fade out, hide elements and show image
        setTimeout(() => {
          uploadPrompt.classList.add('hidden');
          uploadTitle.style.display = 'none';
          personUploadInner.classList.add('hidden');
          
          // Add has-photo classes
          uploadContainer.classList.add('has-photo');
          personUploadArea.classList.add('has-photo');
          
          // Show the image
          const personPhotoPreview = document.getElementById('personPhotoPreview');
          personPhotoPreview.src = e.target.result;
          personPhotoPreview.style.display = 'block';
          
          // Fade in the image
          setTimeout(() => {
            personPhotoPreview.classList.add('show');
            
            // Show remove button
            const removeBtn = document.getElementById('removePhotoBtn');
            removeBtn.classList.add('show');
            
            // GARANTIR QUE O BOTÃO EXECUTE AI SEMPRE APAREÇA
            ensureExecuteAIButtonVisible();
            
          }, 50);
        }, 600);
        
        // FALLBACK: Garantir botão após todas as animações
        setTimeout(() => {
          ensureExecuteAIButtonVisible();
        }, 1000);
      };
      reader.readAsDataURL(file);
      
      // FALLBACK IMEDIATO: Garantir botão mesmo se houver erro no FileReader
      setTimeout(() => {
        if (personFile) {
          ensureExecuteAIButtonVisible();
        }
      }, 100);
    }

    // NOVA FUNÇÃO: Garantir que o botão Execute AI sempre apareça
    function ensureExecuteAIButtonVisible() {
      const continueBtn = document.getElementById('continueBtn');
      
      if (!continueBtn) {
        console.error('❌ Botão continueBtn não encontrado!');
        return;
      }
      
      if (personFile) {
        console.log('✅ Garantindo visibilidade do botão Execute AI...');
        
        // Múltiplas verificações para garantir visibilidade
        continueBtn.style.display = 'block';
        continueBtn.style.visibility = 'visible';
        continueBtn.style.opacity = '1';
        continueBtn.classList.add('show');
        continueBtn.classList.remove('hidden');
        continueBtn.disabled = false;
        
        // Verificação final
        setTimeout(() => {
          const isVisible = continueBtn.style.display !== 'none' && 
                           continueBtn.classList.contains('show') && 
                           !continueBtn.disabled;
          
          console.log('🔍 Verificação final do botão Execute AI:', {
            display: continueBtn.style.display,
            hasShowClass: continueBtn.classList.contains('show'),
            disabled: continueBtn.disabled,
            isVisible: isVisible
          });
          
          if (!isVisible) {
            console.warn('⚠️ Botão não está visível, forçando visibilidade...');
            continueBtn.style.display = 'block !important';
            continueBtn.classList.add('show');
            continueBtn.disabled = false;
          }
        }, 100);
        
      } else {
        console.log('❌ Nenhuma foto carregada, escondendo botão Execute AI');
        continueBtn.style.display = 'none';
        continueBtn.classList.remove('show');
        continueBtn.disabled = true;
      }
    }

    function removePersonPhoto() {
      personFile = null;
      
      // Hide photo and remove button first
      const personPhotoPreview = document.getElementById('personPhotoPreview');
      const removeBtn = document.getElementById('removePhotoBtn');
      
      personPhotoPreview.classList.remove('show');
      removeBtn.classList.remove('show');
      
      // GARANTIR que o botão Execute AI seja escondido quando não há foto
      ensureExecuteAIButtonVisible();
      
      // After image fades out, restore container and fade in text
      setTimeout(() => {
        // Remove has-photo classes to restore border and container
        document.getElementById('personUploadArea').classList.remove('has-photo');
        document.querySelector('.upload-container').classList.remove('has-photo');
        
        // Hide photo completely
        personPhotoPreview.style.display = 'none';
        personPhotoPreview.src = '';
        
        // Show and fade in upload prompt and title
        const uploadPrompt = document.getElementById('uploadPrompt');
        const uploadTitle = document.querySelector('.upload-title');
        const personUploadInner = document.getElementById('personUploadInner');
        
        uploadPrompt.classList.remove('hidden');
        uploadTitle.style.display = 'block';
        personUploadInner.classList.remove('hidden');
        
        // Start with opacity 0 and fade in
        uploadPrompt.style.opacity = '0';
        uploadTitle.style.opacity = '0';
        personUploadInner.style.opacity = '0';
        
        setTimeout(() => {
          uploadPrompt.style.transition = 'opacity 0.6s ease-in';
          uploadTitle.style.transition = 'opacity 0.6s ease-in';
          personUploadInner.style.transition = 'opacity 0.6s ease-in';
          
          uploadPrompt.style.opacity = '1';
          uploadTitle.style.opacity = '1';
          personUploadInner.style.opacity = '1';
        }, 50);
      }, 800);
    }

    function validateFile(file) {
      const maxSize = 25 * 1024 * 1024; // 25MB
      const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/webp'];

      if (!allowedTypes.includes(file.type)) {
        showToast('Unsupported format. Use PNG, JPG, JPEG or WebP.');
        return false;
      }

      if (file.size > maxSize) {
        showToast('File too large. Maximum 25MB.');
        return false;
      }

      return true;
    }

    async function startTryOn() {
      if (isProcessing) return;

      if (!personFile) {
        showToast('Please add your photo first.');
        return;
      }

      // Esconde o botão "Activate AI" imediatamente após o clique
      const continueBtn = document.getElementById('continueBtn');
      if (continueBtn) {
        continueBtn.style.display = 'none';
        continueBtn.classList.remove('show');
      }

      isProcessing = true;
      showProcessing();

      try {
        // Process with FASHN.AI API (with automatic fallback)
        resultImageUrl = await processFashnAI();
        
        hideProcessing();
        showResultInPlace();
        
      } catch (error) {
        hideProcessing();
        console.error('Try-on error:', error);
        showToast(`Processing error: ${error.message}`);
        
        // Se houver erro, mostra o botão novamente
        if (continueBtn) {
          continueBtn.style.display = 'block';
          continueBtn.classList.add('show');
        }
      } finally {
        isProcessing = false;
      }
    }

    async function processFashnAI() {
      updateProcessing('Connecting to AI servers', 'Preparing images...', 10);

      try {
        // Check if API is properly configured - now we have a real key!
        if (!FASHN_API_KEY || FASHN_API_KEY === 'your-fashn-api-key-here') {
          console.warn('FASHN.AI API key not configured, using simulation mode');
          return await simulateAIProcessing();
        }

        console.log('🚀 Using FASHN.AI real API with key:', FASHN_API_KEY.substring(0, 10) + '...');

        // Convert files to base64
        const modelImageBase64 = await fileToBase64(personFile);
        const productFile = await getCurrentProductImageFile();
        const garmentImageBase64 = await fileToBase64(productFile);

        updateProcessing('Connecting to AI servers', 'Optimizing images...', 20);

        // Optimize images for API
        const optimizedModelImage = await fashnAPI.optimizeImage(modelImageBase64);
        const optimizedGarmentImage = await fashnAPI.optimizeImage(garmentImageBase64);

        updateProcessing('Connecting to AI servers', 'Starting AI processing...', 30);

        console.log('Sending to FASHN.AI:');
        console.log('Model image size:', optimizedModelImage.length);
        console.log('Garment image size:', optimizedGarmentImage.length);

        // Process with FASHN.AI
        const result = await fashnAPI.processTryOn(
          optimizedModelImage,
          optimizedGarmentImage,
          {
            category: 'auto',
            segmentationFree: true,
            moderationLevel: 'conservative',
            onProgress: (progress) => {
              const progressPercent = 30 + (progress.progress * 0.6);
              updateProcessing(
                'Connecting to AI servers',
                `Processing... (${progress.status})`,
                progressPercent
              );
            }
          }
        );

        if (result.success) {
          updateProcessing('Connecting to AI servers', 'Complete!', 100);
          console.log('FASHN.AI result:', result.output);
          
          // FASHN.AI returns an array of URLs, get the first one
          if (result.output && Array.isArray(result.output) && result.output.length > 0) {
            return result.output[0];
          } else {
            throw new Error('No output image received from FASHN.AI');
          }
        } else {
          throw new Error(result.error);
        }
      } catch (error) {
        console.error('Error in processFashnAI:', error);
        throw error;
      }
    }

    async function simulateAIProcessing() {
      // Fallback simulation when API is not configured
      for (let i = 30; i <= 100; i += 10) {
        updateProcessing('Connecting to AI servers', 'Simulating AI processing...', i);
        await new Promise(resolve => setTimeout(resolve, 200));
      }
      
      // Return the person's photo as simulation result
      return document.getElementById('personPhotoPreview').src;
    }

    async function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    async function getCurrentProductImageFile() {
      console.log('🔍 getCurrentProductImageFile() iniciado - versão simplificada');
      
      try {
        const productImage = document.getElementById('modalProductImage');
        console.log('🖼️ modalProductImage element:', productImage);
        console.log('🔗 modalProductImage.src:', productImage?.src);
        
        if (!productImage || !productImage.src) {
          console.error('❌ No product image found in modal');
          throw new Error('No product image found in modal');
        }
        
        const imageUrl = productImage.src;
        console.log('🌐 URL da imagem:', imageUrl);
        
        // 🎯 Método Principal: Proxy CORS confiável
        try {
          console.log('🚀 Usando proxy CORS para contornar restrições...');
          const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(imageUrl)}`;
          console.log('🔗 Proxy URL:', proxyUrl);
          
          const response = await fetch(proxyUrl, {
            method: 'GET',
            headers: {
              'Accept': 'image/*'
            }
          });
          
          console.log('📡 Response status:', response.status);
          console.log('📡 Response ok:', response.ok);
          
          if (response.ok) {
            const blob = await response.blob();
            console.log('✅ Blob criado com sucesso:', blob.size, 'bytes', 'tipo:', blob.type);
            
            // Verifica se é realmente uma imagem
            if (blob.type.startsWith('image/') || blob.size > 1000) {
              const file = new File([blob], 'product.jpg', { type: 'image/jpeg' });
              console.log('✅ File criado com sucesso:', file.name, file.size, 'bytes');
              return file;
            } else {
              console.warn('⚠️ Blob não parece ser uma imagem válida');
            }
          }
        } catch (error) {
          console.warn('⚠️ Proxy falhou:', error.message);
        }
        
        // 🛡️ Método Fallback: Fetch direto (pode funcionar em alguns casos)
        try {
          console.log('🚀 Tentando fetch direto como fallback...');
          const response = await fetch(imageUrl, {
            method: 'GET',
            mode: 'cors',
            headers: {
              'Accept': 'image/*',
              'Cache-Control': 'no-cache'
            }
          });
          
          if (response.ok) {
            const blob = await response.blob();
            console.log('✅ Fetch direto funcionou! Blob:', blob.size, 'bytes');
            return new File([blob], 'product.jpg', { type: 'image/jpeg' });
          }
        } catch (error) {
          console.warn('⚠️ Fetch direto falhou:', error.message);
        }
        
        // 🆘 Último recurso: Criar um arquivo placeholder
        console.log('🆘 Criando arquivo placeholder como último recurso...');
        const canvas = document.createElement('canvas');
        canvas.width = 500;
        canvas.height = 500;
        const ctx = canvas.getContext('2d');
        
        // Desenha um placeholder
        ctx.fillStyle = '#f0f0f0';
        ctx.fillRect(0, 0, 500, 500);
        ctx.fillStyle = '#333';
        ctx.font = '20px Arial';
        ctx.textAlign = 'center';
        ctx.fillText('Product Image', 250, 250);
        
        return new Promise((resolve) => {
          canvas.toBlob((blob) => {
            const file = new File([blob], 'product.jpg', { type: 'image/jpeg' });
            console.log('✅ Arquivo placeholder criado:', file.size, 'bytes');
            resolve(file);
          }, 'image/jpeg', 0.9);
        });
        
      } catch (error) {
        console.error('❌ Erro em getCurrentProductImageFile():', error);
        throw new Error('Failed to load product image: ' + error.message);
      }
    }

    function showProcessing() {
      document.getElementById('processingOverlayLocal').classList.add('show');
      // Aplica blur na imagem da pessoa durante o processamento
      const personPhoto = document.getElementById('personPhotoPreview');
      if (personPhoto) {
        personPhoto.classList.add('processing');
        personPhoto.classList.remove('processing-complete');
      }
      updateProcessing('Connecting to AI servers', '', 0);
    }

    function hideProcessing() {
      document.getElementById('processingOverlayLocal').classList.remove('show');
      // Remove blur da imagem da pessoa quando o processamento termina
      const personPhoto = document.getElementById('personPhotoPreview');
      if (personPhoto) {
        personPhoto.classList.remove('processing');
        personPhoto.classList.add('processing-complete');
      }
    }

    function updateProcessing(text, subtext, progress) {
      document.getElementById('processingTextLocal').textContent = text;
      document.getElementById('processingSubtextLocal').textContent = subtext;
      document.getElementById('progressFillLocal').style.width = progress + '%';
    }

    function showResultInPlace() {
      // Skip the small result display and go directly to final screen
      // Hide continue button immediately
      document.getElementById('continueBtn').style.display = 'none';
      
      // Show the final result screen directly after a brief delay
      setTimeout(() => {
        showFinalResultScreen();
      }, 500);
    }

    function showFinalResultScreen() {
      const finalResultScreen = document.getElementById('finalResultScreen');
      const finalResultImage = document.getElementById('finalResultImage');
      const modal = document.getElementById('productModal');
      const modelUploadSection = document.getElementById('modelUploadSection');
      const floatingImage = document.getElementById('floatingProductImage');
      const tryOnArrows = document.getElementById('tryOnArrows');
      
      // Set the result image
      finalResultImage.src = resultImageUrl;
      
      // Fade out the entire try-on mechanism including floating product image and arrows
      modal.style.transition = 'opacity 1s ease-out';
      modelUploadSection.style.transition = 'opacity 1s ease-out';
      
      if (floatingImage) {
        floatingImage.style.transition = 'opacity 1s ease-out';
        floatingImage.style.opacity = '0';
      }
      
      // Hide try-on arrows when final result is shown
      if (tryOnArrows) {
        tryOnArrows.classList.remove('show');
      }
      
      modal.style.opacity = '0';
      modelUploadSection.style.opacity = '0';
      
      setTimeout(() => {
        modal.style.display = 'none';
        modelUploadSection.style.display = 'none';
        
        if (floatingImage) {
          floatingImage.style.display = 'none';
        }
        
        // Show the final result screen
        finalResultScreen.style.display = 'flex';
        setTimeout(() => {
          finalResultScreen.classList.add('show');
        }, 50);
      }, 1000);
    }

    function showTryOnInterface() {
      const modal = document.getElementById('productModal');
      const modelUploadSection = document.getElementById('modelUploadSection');
      const finalResultScreen = document.getElementById('finalResultScreen');
      
      // Hide final result screen first
      finalResultScreen.classList.remove('show');
      
      setTimeout(() => {
        finalResultScreen.style.display = 'none';
        
        // Always remove any existing floating image and recreate it
        const existingFloatingImage = document.getElementById('floatingProductImage');
        if (existingFloatingImage) {
          existingFloatingImage.remove();
        }
        
        // Reset upload state completely
        personFile = null;
        resultImageUrl = null;
        isProcessing = false;
        
        // Reset file input
        const fileInput = document.getElementById('personFileInput');
        if (fileInput) {
          fileInput.value = '';
        }
        
        // Reset and show model upload section explicitly
        modelUploadSection.style.display = 'block';
        modelUploadSection.style.opacity = '1';
        modelUploadSection.classList.remove('show', 'scroll-up');
        
        // Reset upload area to initial state
        const personUploadArea = document.getElementById('personUploadArea');
        const uploadContainer = document.querySelector('.upload-container');
        const personPhotoPreview = document.getElementById('personPhotoPreview');
        const removeBtn = document.getElementById('removePhotoBtn');
        const continueBtn = document.getElementById('continueBtn');
        const uploadPrompt = document.getElementById('uploadPrompt');
        const uploadTitle = document.querySelector('.upload-title');
        const personUploadInner = document.getElementById('personUploadInner');
        
        // Reset all upload elements to initial state
        if (personUploadArea) personUploadArea.classList.remove('has-photo');
        if (uploadContainer) uploadContainer.classList.remove('has-photo');
        if (personPhotoPreview) {
          personPhotoPreview.classList.remove('show', 'fade-out');
          personPhotoPreview.style.display = 'none';
          personPhotoPreview.src = '';
        }
        if (removeBtn) removeBtn.classList.remove('show');
        if (continueBtn) {
          continueBtn.classList.remove('show');
          continueBtn.disabled = true;
        }
        if (uploadPrompt) {
          uploadPrompt.classList.remove('hidden');
          uploadPrompt.style.opacity = '1';
          uploadPrompt.style.display = 'block';
        }
        if (uploadTitle) {
          uploadTitle.style.opacity = '1';
          uploadTitle.style.display = 'block';
        }
        if (personUploadInner) {
          personUploadInner.style.opacity = '1';
        }
        
        // Always fade out modal elements (same as original Try On)
        const fadeOutElements = document.querySelectorAll('.fade-out-element');
        fadeOutElements.forEach(element => {
          element.classList.add('hidden');
        });
        
        // Show modal first
        modal.style.display = 'flex';
        modal.style.opacity = '1';
        modal.classList.add('show');
        
        // After fade out delay, start container animations (same timing as original)
        setTimeout(() => {
          const modalContent = document.querySelector('.modal-content');
          const productImage = document.getElementById('modalProductImage');
          
          if (window.innerWidth <= 768) {
            // Mobile: Swipe up animation (same as original)
            modalContent.classList.add('try-on-swipe-up');
          } else {
            // Desktop: Extract image first, then fade out container (same as original)
            if (productImage) {
              // Get current position and size of image
              const imageRect = productImage.getBoundingClientRect();
              const modalRect = modal.getBoundingClientRect();
              
              // Clone the image and position it absolutely (same as original)
              const imageClone = productImage.cloneNode(true);
              imageClone.id = 'floatingProductImage';
              imageClone.style.position = 'fixed';
              imageClone.style.left = imageRect.left + 'px';
              imageClone.style.top = imageRect.top + 'px';
              imageClone.style.width = imageRect.width + 'px';
              imageClone.style.height = imageRect.height + 'px';
              imageClone.style.zIndex = '1003';
              imageClone.style.transition = 'all 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
              imageClone.style.borderRadius = '15px';
              imageClone.style.boxShadow = '0 8px 32px rgba(0, 0, 0, 0.15)';
              imageClone.style.objectFit = 'contain';
              imageClone.style.display = 'block';
              imageClone.style.opacity = '1';
              
              // Add clone to body
              document.body.appendChild(imageClone);
              
              // Hide original image
              productImage.style.opacity = '0';
              
              // Animate clone to left position after a short delay (same as original)
              setTimeout(() => {
                const leftX = modalRect.left + modalRect.width * 0.25; // Adjust for horizontal alignment
                const centerY = modalRect.top + modalRect.height / 2; // Same vertical center as upload container
                
                imageClone.style.left = leftX + 'px';
                imageClone.style.top = centerY + 'px';
                imageClone.style.width = '300px';
                imageClone.style.height = 'auto'; // Let height adjust naturally
                imageClone.style.transform = 'translate(0, -50%)'; // Center vertically
              }, 100);
            }
            
            // Container fade out (same as original)
            modalContent.classList.add('try-on-container-fadeout');
          }
          
          // Show model upload section after container animation (same timing as original)
          setTimeout(() => {
            showModelUpload();
          }, 600);
        }, 700); // Same delay as original Try On button
      }, 500);
    }

    function hideFinalResultScreen() {
      const finalResultScreen = document.getElementById('finalResultScreen');
      finalResultScreen.style.transition = 'opacity 1.5s ease-out, transform 1.5s ease-out';
      finalResultScreen.classList.remove('show');
      
      // Add slide down effect
      const container = finalResultScreen.querySelector('.final-result-container');
      if (container) {
        container.style.transition = 'transform 1.5s ease-out';
        container.style.transform = 'translateY(50px)';
      }
      
      setTimeout(() => {
        finalResultScreen.style.display = 'none';
        // Reset container transform for next time
        if (container) {
          container.style.transform = 'translateY(0)';
        }
      }, 1500);
    }

    function returnToCatalogue() {
      // Start smooth fade out of final result screen
      const finalResultScreen = document.getElementById('finalResultScreen');
      finalResultScreen.style.transition = 'opacity 1.5s ease-out';
      finalResultScreen.classList.remove('show');
      
      // After fade out completes, reset everything
      setTimeout(() => {
        finalResultScreen.style.display = 'none';
        
        // Add smooth fade in effect to main content
        document.body.style.transition = 'opacity 0.8s ease-in';
        document.body.style.opacity = '0.3';
        
        // Gradually reset all try-on related elements
        setTimeout(() => {
          hideModelUpload();
          hideResultInPlace();
          
          // Clear the uploaded photo
          if (personFile) {
            removePersonPhoto();
          }
          
          // Reset modal state smoothly
          const modal = document.getElementById('productModal');
          modal.style.transition = 'opacity 0.8s ease-out';
          modal.style.opacity = '1';
          
          setTimeout(() => {
            closeModal();
            
            // Clear current product data
            currentProductData = null;
            
            // Reset any floating images
            const floatingImage = document.getElementById('floatingProductImage');
            if (floatingImage) {
              floatingImage.remove();
            }
            
            // Reset modal content animations
            const modalContent = document.querySelector('.modal-content');
            if (modalContent) {
              modalContent.classList.remove('try-on-swipe-up', 'try-on-container-fadeout');
            }
            
            // Reset fade out elements
            const fadeOutElements = document.querySelectorAll('.fade-out-element');
            fadeOutElements.forEach(element => {
              element.classList.remove('hidden');
            });
            
            // Reset original image opacity
            const originalImage = document.getElementById('modalProductImage');
            if (originalImage) {
              originalImage.style.opacity = '1';
            }
            
            // Hide try-on arrows
            document.getElementById('tryOnArrows').classList.remove('show');
            
            // Smooth fade back to full opacity
            setTimeout(() => {
              document.body.style.opacity = '1';
              setTimeout(() => {
                // Remove transition after animation completes
                document.body.style.transition = '';
              }, 800);
            }, 100);
            
          }, 300);
        }, 200);
      }, 1500);
    }

    function buyProduct() {
      if (!currentProductData) {
        showToast('No product selected');
        return;
      }
      
      const selectedSize = document.getElementById('sizeSelector').value;
      
      // Add product to basket
      addToBasket(
        currentProductData.name,
        currentProductData.price,
        currentProductData.imgUrl,
        selectedSize
      );
      
      // Show success message with smooth animation
      const toastEl = document.getElementById("toast");
      toastEl.style.transition = 'all 0.5s ease-out';
      showToast('Product added to basket!');
      
      // Return to catalogue with smooth delay
      setTimeout(() => {
        returnToCatalogue();
      }, 2000);
    }

    function hideResultInPlace() {
      document.getElementById('resultInPlace').classList.remove('show');
      document.getElementById('resultBackBtn').classList.remove('show');
      document.getElementById('resultActionsExternal').classList.remove('show');
      document.getElementById('personPhotoPreview').classList.remove('fade-out');
      
      // GARANTIR que o botão Execute AI apareça se há foto
      ensureExecuteAIButtonVisible();
      
      // Reset to show person photo again
      setTimeout(() => {
        if (personFile) {
          document.getElementById('personPhotoPreview').classList.add('show');
        }
      }, 100);
    }

    function toggleResultView() {
      const isShowingResult = document.getElementById('resultInPlace').classList.contains('show');
      const personPhotoPreview = document.getElementById('personPhotoPreview');
      const resultInPlace = document.getElementById('resultInPlace');
      const resultBackBtn = document.getElementById('resultBackBtn');
      
      if (isShowingResult) {
        // Volta para a foto original (remove o item)
        resultInPlace.classList.remove('show');
        personPhotoPreview.classList.remove('fade-out');
        personPhotoPreview.classList.add('show');
        resultBackBtn.title = "Try on item again";
        resultBackBtn.textContent = "→";
        
      } else {
        // Mostra o resultado novamente (coloca o item)
        personPhotoPreview.classList.add('fade-out');
        resultInPlace.classList.add('show');
        resultBackBtn.title = "Remove item";
        resultBackBtn.textContent = "←";
      }
    }

    function downloadResult() {
      if (resultImageUrl) {
        console.log('🔽 Iniciando download da imagem resultado...');
        
        // Método robusto: fetch + blob + createObjectURL
        fetch(resultImageUrl)
          .then(response => {
            if (!response.ok) {
              throw new Error('Failed to fetch image');
            }
            return response.blob();
          })
          .then(blob => {
            console.log('✅ Blob criado para download:', blob.size, 'bytes');
            
            // Cria URL temporária do blob
            const blobUrl = URL.createObjectURL(blob);
            
            // Cria link de download
            const link = document.createElement('a');
            link.href = blobUrl;
            link.download = `fitrite-virtual-tryon-${Date.now()}.jpg`;
            
            // Força o download
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            // Limpa a URL temporária após um tempo
            setTimeout(() => {
              URL.revokeObjectURL(blobUrl);
              console.log('✅ Download concluído e URL temporária limpa');
            }, 1000);
          })
          .catch(error => {
            console.error('❌ Erro no download:', error);
            
            // Fallback: tenta método direto
            console.log('🔄 Tentando método fallback...');
            const link = document.createElement('a');
            link.href = resultImageUrl;
            link.download = `fitrite-virtual-tryon-${Date.now()}.jpg`;
            link.target = '_blank';
            
            // Adiciona atributos para forçar download
            link.setAttribute('download', `fitrite-virtual-tryon-${Date.now()}.jpg`);
            link.style.display = 'none';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
          });
      } else {
        console.error('❌ Nenhuma imagem resultado disponível para download');
        alert('Nenhuma imagem disponível para download. Faça um try-on primeiro!');
      }
    }
    
    function shareResult() {
      if (resultImageUrl && navigator.share) {
        // Use Web Share API if available
        fetch(resultImageUrl)
          .then(response => response.blob())
          .then(blob => {
            const file = new File([blob], `fitrite-virtual-tryon-${Date.now()}.jpg`, { type: 'image/jpeg' });
            navigator.share({
              title: 'My Virtual Try-On at Fitrite',
              text: 'Look at my virtual try-on at Fitrite 🔥',
              files: [file]
            });
          })
          .catch(err => {
            console.error('Error sharing:', err);
            // Fallback to copying link
            copyToClipboard();
          });
      } else {
        // Fallback for browsers without Web Share API
        copyToClipboard();
      }
    }
    
    function copyToClipboard() {
      if (resultImageUrl) {
        // Create a temporary canvas to convert the image to data URL
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        const img = new Image();
        img.onload = function() {
          canvas.width = img.width;
          canvas.height = img.height;
          ctx.drawImage(img, 0, 0);
          canvas.toBlob(blob => {
            navigator.clipboard.write([
              new ClipboardItem({ 'image/png': blob })
            ]).then(() => {
              showToast('Image copied to clipboard!');
            }).catch(() => {
              showToast('Share feature not supported on this device');
            });
          });
        };
        img.src = resultImageUrl;
      }
    }
    
    function showToast(message) {
      const toastEl = document.getElementById("toast");
      toastEl.textContent = message;
      toastEl.classList.add("show");
      setTimeout(() => {
        toastEl.classList.remove("show");
      }, 2000);
    }
    
    // Define all leather jacket products
    const leatherJackets = [
        {
          "id": "img_jacket_1",
          "name": "Classic Black Biker",
          "category": "leather jackets",
          "imagePath": "https://assets.onecompiler.app/42mhv938c/42mn3wcty/WhatsApp%20Image%202024-12-11%20at%2015.36.08_4f9bf797.jpg",
          "price": 200,
          "discount": true,
          "discountPercent": 60
        },
        {
          "id": "img_jacket_2",
          "name": "Sleek Red Racer",
          "category": "leather jackets",
          "imagePath": "https://assets.onecompiler.app/42mhv938c/42mn3wcty/WhatsApp%20Image%202024-12-11%20at%2015.36.08_07d3570b.jpg",
          "price": 340,
          "discount": false,
          "discountPercent": 10
        },
        {
          "id": "img_jacket_3",
          "name": "Vintage Brown Bomber",
          "category": "leather jackets",
          "imagePath": "https://assets.onecompiler.app/42mhv938c/42mn3wcty/WhatsApp%20Image%202024-12-11%20at%2015.36.08_30f60707.jpg",
          "price": 120,
          "discount": true,
          "discountPercent": 40
        },
        {
          "id": "img_jacket_4",
          "name": "Urban Explorer Black",
          "category": "leather jackets",
          "imagePath": "https://assets.onecompiler.app/42mhv938c/42mn3wcty/WhatsApp%20Image%202024-12-11%20at%2015.36.08_63b38d2b.jpg",
          "price": 290,
          "discount": false,
          "discountPercent": 5
        },
        {
          "id": "img_jacket_5",
          "name": "Modern Blue Moto",
          "category": "leather jackets",
          "imagePath": "https://assets.onecompiler.app/42mhv938c/42mn3wcty/WhatsApp%20Image%202024-12-11%20at%2015.36.08_697b5895.jpg",
          "price": 140,
          "discount": true,
          "discountPercent": 70
        },
        {
          "id": "img_jacket_6",
          "name": "Rugged Green Field Jacket",
          "category": "leather jackets",
          "imagePath": "https://assets.onecompiler.app/42mhv938c/42mn3wcty/WhatsApp%20Image%202024-12-11%20at%2015.36.08_17088757.jpg",
          "price": 280,
          "discount": false,
          "discountPercent": 12
        },
        {
          "id": "img_jacket_7",
          "name": "Silver Streak Jacket",
          "category": "leather jackets",
          "imagePath": "https://assets.onecompiler.app/42mhv938c/42mn3wcty/WhatsApp%20Image%202024-12-11%20at%2015.36.09_15d1301a.jpg",
          "price": 330,
          "discount": false,
          "discountPercent": 0
        },
        {
          "id": "img_jacket_8",
          "name": "Metallic Finish Racer",
          "category": "leather jackets",
          "imagePath": "https://assets.onecompiler.app/42mhv938c/42mn3wcty/WhatsApp%20Image%202024-12-11%20at%2015.36.09_74032182.jpg",
          "price": 350,
          "discount": false,
          "discountPercent": 0
        }
    ];

    // Function to render all leather jackets with discounts
    function renderLeatherJackets(jackets) {
      console.log("renderLeatherJackets called with:", jackets);
      const productsContainer = document.getElementById("products-container");
      console.log("productsContainer element:", productsContainer);
      productsContainer.innerHTML = ''; // Clear container
      
      jackets.forEach(jacket => {
        // Create product div
        const productDiv = document.createElement("div");
        productDiv.className = "product";
        
        let priceHtml = '';
        let discountTag = '';
        
        if (jacket.discount) {
          // Calculate discounted price
          const discountedPrice = Math.round(jacket.price * (1 - jacket.discountPercent / 100));
          
          // Create price HTML with original and new price
          priceHtml = `
            <p class="product-price">
              <span class="original-price">£${jacket.price}</span>
              <span class="new-price">£${discountedPrice}</span>
            </p>
          `;
          
          // Create discount tag based on discount percentage
          if (jacket.discountPercent > 55) {
            // Gold Tag (> 55%)
            discountTag = `
              <div class="discount-tag gold">★★ ${jacket.discountPercent}% OFF – Bargain of the Day ★★</div>
            `;
          } else {
            // Red Tag (≤ 55%)
            discountTag = `
              <div class="discount-tag red">★ ${jacket.discountPercent}% OFF ★</div>
            `;
          }
          
          // Set click handler with discount info
          productDiv.addEventListener("click", () => {
            openModal(jacket.name, `£${discountedPrice}`, jacket.imagePath, true, `£${jacket.price}`);
          });
        } else {
          // Regular price for non-discounted items
          priceHtml = `<p class="product-price">£${jacket.price}</p>`;
          
          // Set click handler without discount info
          productDiv.addEventListener("click", () => {
            openModal(jacket.name, `£${jacket.price}`, jacket.imagePath);
          });
        }
        
        // Build the product HTML
        productDiv.innerHTML = `
          ${discountTag}
          <div class="image-container">
            <img src="${jacket.imagePath}" alt="${jacket.name}" onerror="this.style.visibility='hidden';">
          </div>
          <p class="product-name">${jacket.name}</p>
          ${priceHtml}
        `;
        
        productsContainer.appendChild(productDiv);
      });
    }
    
    // Load products and apply discounts from JSON
    async function loadProducts() {
      console.log("loadProducts called");
      console.log("leatherJackets array:", leatherJackets);
      try {
        // Try to fetch the products.json file
        const response = await fetch('./products.json');
        let discountedProducts = [];
        
        if (response.ok) {
          // If products.json is available, use it
          discountedProducts = await response.json();
          console.log("Loaded discounted products from JSON:", discountedProducts);
          
          // Extract just the leather jacket discounts
          const jacketDiscounts = discountedProducts
            .filter(product => product.category === "leather jackets")
            .map(product => ({
              id: product.id,
              discountPercent: product.discountPercent
            }));
          
          // Render leather jackets with discounts from JSON
          renderLeatherJackets(leatherJackets);
        } else {
          // If products.json is not available, use the built-in discounts
          console.warn("Could not load products.json, using built-in discount data");
          renderLeatherJackets(leatherJackets);
        }
      } catch (error) {
        // If there's an error, use the built-in discounts
        console.error("Error loading products:", error);
        renderLeatherJackets(leatherJackets);
      }
    }
    
    // Função para resetar estados da interface Try-On
    function resetTryOnStates() {
      const modelUploadSection = document.getElementById('modelUploadSection');
      const modalContent = document.querySelector('.modal-content');
      const tryOnArrows = document.getElementById('tryOnArrows');
      const floatingImage = document.getElementById('floatingProductImage');
      
      // Remove classes de animação
      if (modalContent) {
        modalContent.classList.remove('try-on-swipe-up', 'try-on-container-fadeout');
        // Remove qualquer estilo de animação inline
        modalContent.style.animation = '';
        modalContent.style.transform = '';
      }
      
      // Remove classes de estado
      if (modelUploadSection) {
        modelUploadSection.classList.remove('show', 'scroll-up');
        // Remove estilos inline de animação
        modelUploadSection.style.animation = '';
        modelUploadSection.style.transition = '';
        
        // Redefine posicionamento baseado no viewport atual
        if (window.innerWidth <= 768) {
          modelUploadSection.style.position = 'fixed';
          modelUploadSection.style.top = '50%';
          modelUploadSection.style.left = '50%';
          modelUploadSection.style.transform = 'translate(-50%, -50%)';
          modelUploadSection.style.width = '90vw';
          modelUploadSection.style.maxWidth = '400px';
        } else {
          modelUploadSection.style.position = 'fixed';
          modelUploadSection.style.left = '65%';
          modelUploadSection.style.top = '50%';
          modelUploadSection.style.transform = 'translate(0, -50%)';
          modelUploadSection.style.width = '300px';
          modelUploadSection.style.maxWidth = '35vw';
        }
      }
      
      // Remove setas
      if (tryOnArrows) {
        tryOnArrows.classList.remove('show');
        tryOnArrows.style.animation = '';
      }
      
      // Remove imagem flutuante
      if (floatingImage) {
        floatingImage.remove();
      }
      
      // Reset variáveis de estado
      if (typeof isProcessing !== 'undefined') {
        isProcessing = false;
      }
    }

    // Event listener para mudanças de viewport com debounce
    let resizeTimeout;
    function handleViewportChange() {
      // Debounce para evitar múltiplas execuções
      clearTimeout(resizeTimeout);
      resizeTimeout = setTimeout(() => {
        console.log('🔄 Mudança de viewport detectada:', window.innerWidth + 'px');
        
        // Verificar se está em modo try-on
        const modal = document.getElementById('productModal');
        const modelUploadSection = document.getElementById('modelUploadSection');
        const isInTryOnMode = modal && modal.classList.contains('show') && 
                             modelUploadSection && modelUploadSection.classList.contains('show');
        
        if (isInTryOnMode) {
          console.log('📱 Modo try-on ativo, ajustando layout para viewport:', window.innerWidth <= 768 ? 'Mobile' : 'Desktop');
          
          // Resetar estados primeiro
          resetTryOnStates();
          
          // Aplicar layout específico baseado no viewport
          setTimeout(() => {
            applyTryOnLayout();
          }, 100);
        } else {
          // Se não está em try-on, apenas reset normal
          resetTryOnStates();
        }
      }, 250); // Aguarda 250ms após o último resize
    }

    // Nova função para aplicar layout try-on baseado no viewport
    function applyTryOnLayout() {
      const modal = document.getElementById('productModal');
      const modelUploadSection = document.getElementById('modelUploadSection');
      const modalContent = document.querySelector('.modal-content');
      const productImage = document.getElementById('modalProductImage');
      const tryOnArrows = document.getElementById('tryOnArrows');
      
      if (!modal || !modelUploadSection) return;
      
      console.log('🎭 Aplicando transição suave para viewport:', window.innerWidth <= 768 ? 'Mobile' : 'Desktop');
      
      // FASE 1: Preparar elementos para transição suave
      // Adicionar transições CSS temporárias para suavizar mudanças
      const elementsToTransition = [modalContent, modelUploadSection, tryOnArrows];
      elementsToTransition.forEach(element => {
        if (element) {
          element.style.transition = 'all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
        }
      });
      
      // FASE 2: Fade out suave antes da reorganização
      if (modalContent) {
        modalContent.style.opacity = '0.3';
      }
      
      // FASE 3: Aplicar mudanças durante o fade (invisível ao usuário)
      setTimeout(() => {
        // Limpar animações anteriores
        if (modalContent) {
          modalContent.classList.remove('try-on-swipe-up', 'try-on-container-fadeout');
        }
        
        // Remover imagem flutuante existente suavemente
        const existingFloatingImage = document.getElementById('floatingProductImage');
        if (existingFloatingImage) {
          existingFloatingImage.style.opacity = '0';
          setTimeout(() => {
            existingFloatingImage.remove();
          }, 200);
        }
        
        if (window.innerWidth <= 768) {
          // LAYOUT MOBILE: Preparar elementos
          console.log('📱 Configurando layout mobile...');
          
          // Esconder try-on arrows suavemente
          if (tryOnArrows) {
            tryOnArrows.style.opacity = '0';
            setTimeout(() => {
              tryOnArrows.classList.remove('show');
              tryOnArrows.style.opacity = '';
            }, 200);
          }
          
          // Preparar seção de upload para mobile
          modelUploadSection.classList.remove('show', 'scroll-up');
          modelUploadSection.style.opacity = '0';
          
          // FASE 4: Aplicar layout mobile com fade in
          setTimeout(() => {
            if (modalContent) {
              modalContent.classList.add('try-on-swipe-up');
              modalContent.style.opacity = '1';
            }
            
            // Mostrar seção de upload com animação mobile
            modelUploadSection.classList.add('show', 'scroll-up');
            modelUploadSection.style.opacity = '1';
          }, 100);
          
        } else {
          // LAYOUT DESKTOP: Preparar elementos
          console.log('💻 Configurando layout desktop...');
          
          // Mostrar try-on arrows suavemente
          if (tryOnArrows) {
            tryOnArrows.classList.add('show');
            tryOnArrows.style.opacity = '1';
          }
          
          // Preparar seção de upload para desktop
          modelUploadSection.classList.remove('show', 'scroll-up');
          modelUploadSection.style.opacity = '0';
          
          // Criar imagem flutuante com transição suave
          if (productImage) {
            const imageRect = productImage.getBoundingClientRect();
            const modalRect = modal.getBoundingClientRect();
            
            // Clone da imagem com posição inicial invisível
            const imageClone = productImage.cloneNode(true);
            imageClone.id = 'floatingProductImage';
            imageClone.style.position = 'fixed';
            imageClone.style.left = imageRect.left + 'px';
            imageClone.style.top = imageRect.top + 'px';
            imageClone.style.width = imageRect.width + 'px';
            imageClone.style.height = imageRect.height + 'px';
            imageClone.style.zIndex = '1003';
            imageClone.style.transition = 'all 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
            imageClone.style.borderRadius = '15px';
            imageClone.style.boxShadow = '0 8px 32px rgba(0, 0, 0, 0.15)';
            imageClone.style.objectFit = 'contain';
            imageClone.style.display = 'block';
            imageClone.style.opacity = '0'; // Começar invisível
            
            document.body.appendChild(imageClone);
            
            // Esconder imagem original suavemente
            productImage.style.transition = 'opacity 0.3s ease';
            productImage.style.opacity = '0';
            
            // FASE 4: Animar para posição final com fade in
            setTimeout(() => {
              const leftX = modalRect.left + modalRect.width * 0.25;
              const centerY = modalRect.top + modalRect.height / 2;
              
              // Fade in e mover para posição final simultaneamente
              imageClone.style.opacity = '1';
              imageClone.style.left = leftX + 'px';
              imageClone.style.top = centerY + 'px';
              imageClone.style.width = '300px';
              imageClone.style.height = 'auto';
              imageClone.style.transform = 'translate(0, -50%)';
            }, 50);
          }
          
          // FASE 4: Aplicar layout desktop com fade in
          setTimeout(() => {
            if (modalContent) {
              modalContent.classList.add('try-on-container-fadeout');
              modalContent.style.opacity = '1';
            }
            
            // Mostrar seção de upload sem scroll-up
            modelUploadSection.classList.add('show');
            modelUploadSection.style.opacity = '1';
          }, 100);
        }
        
        // FASE 5: Limpar transições temporárias e garantir botão
        setTimeout(() => {
          elementsToTransition.forEach(element => {
            if (element) {
              element.style.transition = '';
            }
          });
          
          // Garantir que o botão Execute AI apareça se há foto
          ensureExecuteAIButtonVisible();
        }, 600);
        
      }, 150); // Aguardar fade out antes de reorganizar
    }

    // Load products when the page loads
    document.addEventListener('DOMContentLoaded', function() {
      loadProducts();
      
      // Adiciona event listener para mudanças de viewport
      window.addEventListener('resize', handleViewportChange);
      
      // VERIFICAÇÃO PERIÓDICA: Garantir que o botão Execute AI sempre apareça quando há foto
      setInterval(() => {
        if (personFile) {
          const continueBtn = document.getElementById('continueBtn');
          if (continueBtn && (!continueBtn.classList.contains('show') || continueBtn.disabled || continueBtn.style.display === 'none')) {
            console.log('🔄 Verificação periódica: Reativando botão Execute AI...');
            ensureExecuteAIButtonVisible();
          }
        }
      }, 2000); // Verifica a cada 2 segundos
    });
    
    // Basket functionality (placeholder - you'll need to implement this)
    const basketCount = document.getElementById("basketCount");
    const basketCountMobile = document.getElementById("basketCountMobile");
    
    function toggleBasket(event) {
      event.preventDefault();
      // Implement basket toggle functionality
    }
    
    function toggleBasketMobile(event) {
      event.preventDefault();
      // Implement mobile basket toggle functionality
    }
    
    function updateBasketDropdown() {
      // Implement basket dropdown update functionality
    }
  </script>
</body>
</html>

