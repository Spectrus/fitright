<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Caps and Hats - Fitrite</title>
  <!-- Google Font for header and heading "AVAILABLE CAPS AND HATS" -->
  <link href="https://fonts.googleapis.com/css2?family=Special+Elite&display=swap" rel="stylesheet">
  <style>
    /* CSS Reset and Box Model Standardization */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    /* Global Styles */
    body {
      margin: 0;
      padding: 0;
      background: #f4f4f4;
      font-family: Arial, sans-serif;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    
    /* Header Styles */
    header {
      position: relative;
      z-index: 1000;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px;
      background-color: transparent;
      width: 100%;
      font-family: 'Special Elite', monospace;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: black;
    }
    
    header .logo h1 {
      margin: 0;
      font-size: 1.5em;
      font-weight: normal;
      color: black;
    }
    
    header .logo p {
      margin: 3px 0 0;
      font-size: 0.8em;
      font-style: italic;
      color: black;
    }
    
    /* Mobile Menu Toggle */
    .menu-toggle {
      display: none;
      flex-direction: column;
      justify-content: space-between;
      width: 30px;
      height: 21px;
      cursor: pointer;
      z-index: 20;
    }
    
    .menu-toggle span {
      display: block;
      height: 3px;
      width: 100%;
      background-color: #333;
      border-radius: 3px;
      transition: all 0.3s ease;
    }
    
    header nav {
      padding-right: 0;
    }
    
    header nav ul {
      list-style: none;
      display: flex;
      gap: 15px;
      margin: 0;
      padding: 0;
    }
    
    header nav ul li a {
      color: black;
      text-decoration: none;
      transition: color 0.3s;
      pointer-events: auto;
      padding: 5px 10px;
      display: block;
    }
    
    header nav ul li a:hover {
      text-decoration: underline;
      color: black;
    }
    
    /* Search Bar */
    #search-bar {
      background-color: transparent;
      padding: 15px;
      text-align: center;
      border-bottom: 1px solid #ddd;
      width: 100%;
    }
    
    #searchInput {
      width: 90%;
      max-width: 600px;
      padding: 10px 15px;
      font-size: 1em;
      border: 1px solid #ccc;
      border-radius: 25px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      outline: none;
    }
    
    #searchInput:focus {
      border-color: #333;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }
    
    /* Products Grid - Responsive like leather jackets page */
    .products {
      display: grid;
      grid-template-columns: repeat(4, 1fr); /* Default to 4 columns for desktop */
      gap: 20px;
      padding: 20px;
      background-color: #f4f4f4;
      width: 100%;
      max-width: 1400px;
      margin: 0 auto;
    }
    
    /* Product Box – Updated to match example image style */
    .product {
      background-color: white;
      border: 1px solid #ddd;
      border-radius: 15px;
      box-shadow: 0px 4px 10px rgba(0,0,0,0.2);
      overflow: hidden;
      text-align: center;
      padding: 15px;
      position: relative;
      cursor: pointer;
      transition: transform 0.3s, box-shadow 0.3s;
      display: flex;
      flex-direction: column;
      align-items: center;
      touch-action: manipulation;
    }
    
    .product:hover {
      transform: scale(1.02);
      box-shadow: 0px 6px 15px rgba(0,0,0,0.3);
    }
    
    /* Updated Image Style for proper display */
    .product img {
      width: 100%;
      height: 200px;
      object-fit: contain;
      border-radius: 10px;
      margin-bottom: 10px;
      display: block;
      background-color: #f9f9f9;
      min-height: 200px; /* Ensure minimum height */
      border: 1px solid #eee; /* Add border for visibility */
    }
    
    /* Fallback for images that fail to load */
    .product img:before {
      content: "";
      display: block;
      width: 100%;
      height: 100%;
      background-color: #f9f9f9;
      border: 1px solid #ddd;
      border-radius: 10px;
    }
    
    /* Product Text - Now using Special Elite Font */
    .product p {
      margin: 5px 0;
      font-weight: bold;
      font-size: 1.1em;
      font-family: 'Special Elite', monospace;
    }
    
    /* Heading "AVAILABLE CAPS AND HATS" using Special Elite */
    #caps-hats h2 {
      font-family: 'Special Elite', monospace;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      text-align: center;
      margin-top: 20px;
    }
    
    /* Footer */
    footer {
      text-align: center;
      background-color: transparent;
      color: #333;
      font-size: 0.9em;
      margin: 20px 0;
      padding: 15px;
      width: 100%;
    }
    
    footer p {
      margin: 5px 0;
    }
    
    /* Modal Styles - Responsive */
    .modal {
      display: none;
      position: fixed;
      z-index: 999;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.4s ease;
      justify-content: center;
      align-items: center;
    }
    
    .modal.show {
      display: flex;
      opacity: 1;
      pointer-events: auto;
    }
    
    .modal-content {
      background-color: #fff;
      margin: 5% auto;
      padding: 1.5rem;
      border: 1px solid #888;
      width: 90%;
      max-width: 300px;
      border-radius: 15px;
      text-align: center;
      position: relative;
      animation: fadeInSlide 0.4s ease;
    }
    
    @keyframes fadeInSlide {
      0% {
        opacity: 0;
        transform: translateY(-50px);
      }
      100% {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .close-btn {
      position: absolute;
      top: 0.5rem;
      right: 0.75rem;
      font-size: 1.2rem;
      font-weight: bold;
      cursor: pointer;
      touch-action: manipulation;
    }
    
    .close-btn:hover {
      color: red;
    }
    
    /* Updated Modal Image Style to match example */
    #modalProductImage {
      width: 100%;
      max-width: 250px;
      height: auto;
      object-fit: contain;
      border-radius: 10px;
      margin-bottom: 1rem;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      display: block;
      background-color: #f9f9f9;
    }
    
    .proceed-btn {
      background-color: #000;
      color: #fff;
      border: none;
      padding: 0.75rem 1.5rem;
      margin-top: 1rem;
      cursor: pointer;
      font-size: 1rem;
      border-radius: 15px;
      transition: background-color 0.3s;
      touch-action: manipulation;
      width: 100%;
    }
    
    .proceed-btn:hover {
      background-color: #333;
    }

    /* Size Selector Styles */
    .size-selector {
      background-color: #000; /* Match button background */
      color: #fff; /* Match button text color */
      border: none; /* Match button border */
      padding: 0.75rem; /* Adjust padding */
      margin-top: 1rem; /* Consistent margin */
      border-radius: 15px; /* Match button border-radius */
      font-size: 1rem; /* Match button font-size */
      width: 100%; /* Full width */
      cursor: pointer;
      -webkit-appearance: none; /* Remove default OS styling */
      -moz-appearance: none;
      appearance: none;
      background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23ffffff%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.4-5.4-13z%22%2F%3E%3C%2Fsvg%3E") ; /* Custom arrow (white) */
      background-repeat: no-repeat;
      background-position: right 0.7em top 50%, 0 0;
      background-size: 0.65em auto, 100%;
      text-align: center; /* Center the text */
      text-align-last: center; /* For Firefox */
      -moz-text-align-last: center; /* For Firefox */
    }

    .size-selector option {
        background-color: #333; /* Darker background for options */
        color: #fff;
    }

    /* Toast Notification */
    #toast {
      position: fixed;
      top: 20px;
      right: 20px;
      background-color: #333;
      color: #fff;
      padding: 10px 15px;
      border-radius: 15px;
      opacity: 0;
      transition: opacity 0.3s;
      pointer-events: none;
      z-index: 10000;
    }
    
    #toast.show {
      opacity: 1;
    }
    
    /* Discount Tag Styles - ADDED FOR DISCOUNT SYSTEM */
    .discount-tag {
      position: absolute;
      top: 10px;
      left: 10px;
      padding: 5px 10px;
      border-radius: 3px;
      font-weight: bold;
      z-index: 5;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      text-align: center;
    }
    
    /* Red Tag (≤ 55%) */
    .discount-tag.red {
      background-color: #ff0000;
      color: white;
      font-size: 0.9em;
    }
    
    /* Gold Tag (> 55%) */
    .discount-tag.gold {
      background-color: gold;
      color: #333;
      font-size: 0.95em;
      padding: 6px 10px;
      font-weight: bold;
    }
    
    /* Price Display for Discounted Products */
    .original-price {
      text-decoration: line-through;
      color: #888;
      margin-right: 5px;
    }
    
    .new-price {
      color: green;
      font-weight: bold;
    }
    
    /* Media Queries for Responsive Design - Adapting like leather jackets page */
    /* Large screens */
    @media (max-width: 1200px) {
      .products {
        grid-template-columns: repeat(3, 1fr);
        grid-gap: 20px;
      }
    }
    
    /* Medium screens */
    @media (max-width: 900px) {
      .products {
        grid-template-columns: repeat(2, 1fr);
        grid-gap: 15px;
      }
      
      header {
        padding: 20px;
      }
      
      header .logo h1 {
        font-size: 1.8em;
      }
      
      header .logo p {
        font-size: 0.9em;
        margin: 5px 0 0;
      }
      
      #search-bar {
        padding: 20px 15px;
      }
      
      #searchInput {
        width: 80%;
      }
      
      .product img {
        height: 250px;
      }
      
      .modal-content {
        padding: 2rem;
        max-width: 350px;
      }
      
      .proceed-btn {
        width: auto;
        min-width: 200px;
      }
    }
    
    /* Smartphone displays - 2 per line as requested */
    @media (max-width: 600px) {
      .products {
        grid-template-columns: repeat(2, 1fr);
        grid-gap: 10px;
        padding: 10px;
      }
      
      .product {
        min-height: 250px;
        padding: 10px;
      }
      
      .product img {
        height: 120px;
      }
      
      .modal-content {
        max-width: 300px;
      }
    }
    
    /* Very small screens - 1 per line */
    @media (max-width: 400px) {
      .products {
        grid-template-columns: 1fr;
      }
      
      header .logo h1 {
        font-size: 1.5em;
      }
    }
    
    /* Mobile Navigation */
    @media (max-width: 767px) {
      .menu-toggle {
        display: flex;
      }
      
      header nav {
        position: fixed;
        top: 0;
        right: -100%;
        width: 80%;
        max-width: 300px;
        height: 100vh;
        background-color: white;
        z-index: 100;
        transition: right 0.3s ease;
        box-shadow: -5px 0 15px rgba(0,0,0,0.1);
        padding: 80px 20px 20px;
      }
      
      header nav.active {
        right: 0;
      }
      
      header nav ul {
        flex-direction: column;
      }
      
      header nav ul li {
        margin-right: 0;
        margin-bottom: 15px;
      }
      
      .basket-row .basket-minus-btn {
        opacity: 1 !important;
        pointer-events: auto !important;
      }
      
      .basket-desktop { display: none !important; }
      .basket-mobile { display: block !important; }
      
      /* Mobile basket dropdown positioning */
      .basket-mobile {
        position: relative !important;
      }
      
      #basketDropdown {
        position: absolute !important;
        top: 100% !important;
        left: 0 !important;
        right: 0 !important;
        width: 100% !important;
        min-width: auto !important;
        max-width: none !important;
        border-radius: 0 0 15px 15px !important;
        box-shadow: 0 4px 16px rgba(0,0,0,0.15) !important;
        z-index: 2000 !important;
        margin-top: 5px !important;
      }
    }

    /* Basket Dropdown Styles */
    #basketDropdown {
      opacity: 0;
      transform: translateY(-10px);
      pointer-events: none;
      transition: opacity 0.3s, transform 0.3s;
      display: block;
      max-height: 400px;
      overflow-y: auto;
    }
    
    #basketDropdown.show {
      opacity: 1;
      transform: translateY(0);
      pointer-events: auto;
    }
    
    .basket-fade-out {
      opacity: 0;
      transition: opacity 0.3s;
    }
    
    .basket-fade-in {
      opacity: 1;
      transition: opacity 0.3s;
    }
    
    .basket-row .basket-minus-btn {
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s;
    }
    /* Ensure minus button size matches belts.html */
    .basket-row .basket-minus-btn {
      width: 22px;
      height: 22px;
      border-radius: 50%;
      font-size: 1em;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .basket-row:hover .basket-minus-btn {
      opacity: 1;
      pointer-events: auto;
    }
    
    /* DESKTOP: Hide minus button by default inside the main basket dropdown */
    #basketDropdown .basket-minus-btn {
      opacity: 0; /* Hidden by default */
    }

    /* DESKTOP: Show minus button on hover inside the main basket dropdown */
    #basketDropdown .basket-row:hover .basket-minus-btn {
      opacity: 1; /* Visible on hover */
    }

    .basket-desktop { display: block; }
    .basket-mobile { display: none; }
    
    .basket-mobile-btn:hover span:first-child {
      text-decoration: underline;
      color: black;
    }

    /* Only add border-bottom to basket rows except the last */
    .basket-row:not(:last-child) {
      border-bottom: 1px solid #eee;
    }
    
    /* Clear Basket Button Slide-up Animation */
    #basketDropdownFooter {
      transition: all 0.3s ease;
      transform: translateY(100%);
      opacity: 0;
      overflow: hidden;
      position: relative;
    }
    
    #basketDropdown:hover #basketDropdownFooter {
      transform: translateY(0);
      opacity: 1;
    }
    
    #clearBasketBtn {
      transition: all 0.2s ease;
    }
    
    #clearBasketBtn:hover {
      background: #a00 !important;
      transform: scale(1.05);
    }

    /* Mobile dropdown animation */
    #basketDropdownMobile {
      opacity: 0;
      transform: translateY(-10px);
      pointer-events: none;
      transition: opacity 0.3s, transform 0.3s;
    }
    
    #basketDropdownMobile.show {
      opacity: 1;
      transform: translateY(0);
      pointer-events: auto;
    }
  </style>
  <!-- Add Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.x.x/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.x.x/firebase-database.js"></script>
  <script src="firebase.js"></script>
  <script src="cartSync.js"></script>
</head>
<body>
  <!-- Header Section -->
  <header>
    <div class="logo">
      <h1>FITRITE</h1>
      <p>Caps and Hats</p>
    </div>
    <!-- Mobile Menu Toggle -->
    <div class="menu-toggle" id="menuToggle">
      <span></span>
      <span></span>
      <span></span>
    </div>
    <nav id="mobileNav">
      <ul>
        <li><a href="index.html">HOME</a></li>
        <li><a href="page2.html">FITTING ROOM</a></li>
        <li><a href="page3.html">CHECKOUT</a></li>
        <li class="basket-desktop" style="position: relative;">
          <div class="basket-btn-container" style="position: relative; display: inline-block;">
            <button id="basketDropdownBtn" style="background:none;border:none;cursor:pointer;position:relative;">
              🛒
              <span id="basketCount" style="font-size:0.8em;background:#000;color:#fff;border-radius:50%;padding:2px 6px;position:absolute;top:-8px;right:-10px;display:none;width:20px;height:20px;display:flex;align-items:center;justify-content:center;">0</span>
            </button>
                <div id="basketDropdown" style="display:none;position:absolute;right:0;top:40px;min-width:300px;max-width:350px;background:#fff;border:1px solid #ddd;border-radius:15px;box-shadow:0 4px 16px rgba(0,0,0,0.15);z-index:2000;padding:15px 10px 10px 10px;">
        <div id="basketDropdownContent" style="padding-top:20px;">Your basket is empty.</div>
        <div id="basketDropdownFooter" style="margin-top:15px;padding-top:15px;border-top:1px solid #eee;text-align:center;display:none;">
            <button id="clearBasketBtn" style="background:#c00;color:#fff;border:none;padding:8px 16px;border-radius:4px;cursor:pointer;font-family:'Special Elite',monospace;font-size:0.9em;text-transform:uppercase;">Clear Basket</button>
        </div>
    </div>
          </div>
        </li>
        <li class="basket-mobile" style="display:none;width:100%;position:relative;">
            <button id="basketDropdownBtnMobile" class="basket-mobile-btn" style="background:none;border:none;cursor:pointer;width:100%;padding:5px 10px;text-align:left;display:block;">
              <span style="font-family:'Special Elite',monospace;font-size:1.2em;letter-spacing:0.04em;vertical-align:middle;">BASKET</span>
              <span id="basketCountMobile" style="font-size:1em;background:#000;color:#fff;border-radius:50%;padding:2px 8px;margin-left:10px;vertical-align:middle;width:24px;height:24px;display:flex;align-items:center;justify-content:center;">0</span>
            </button>
          <div id="basketDropdownMobile" style="display:none;position:absolute;top:100%;left:0;right:0;width:100%;background:#fff;border:1px solid #ddd;border-radius:0 0 15px 15px;box-shadow:0 4px 16px rgba(0,0,0,0.15);z-index:2000;padding:15px 10px 10px 10px;margin-top:5px;">
              <div id="basketDropdownContentMobile" style="padding-top:20px;">Your basket is empty.</div>
          </div>
        </li>
      </ul>
    </nav>
  </header>

  <!-- Search Bar -->
  <section id="search-bar">
    <input type="text" id="searchInput" placeholder="Search caps or hats by name or price..." onkeyup="filterProducts()" />
  </section>

  <!-- Products Section -->
  <section id="caps-hats">
    <h2>AVAILABLE CAPS AND HATS</h2>
    <div class="products" id="products-container">
      <!-- Products will be populated by JavaScript -->
    </div>
  </section>

  <!-- Footer Section -->
  <footer>
    <p>&copy; 2024 Fitrite. All rights reserved.</p>
  </footer>

  <!-- Modal (Pop-up) -->
  <div id="productModal" class="modal">
    <div class="modal-content">
      <span class="close-btn" id="closeModal">&times;</span>
      <img id="modalProductImage" src="" alt="" onerror="this.onerror=null; this.src='Hat1.jpg';">
      <h3 id="modalProductName"></h3>
      <p id="modalProductPrice"></p>
      <p style="margin: 1rem 0;">Would you like to proceed with this product?</p>
      <button id="addToBasket" class="proceed-btn">Add to Basket</button>
      <button id="proceedToPayment" class="proceed-btn">Go to Payment Page</button>
      <select id="sizeSelector" class="size-selector">
        <option value="S (approx. 54-55 cm)">S (approx. 54-55 cm)</option>
        <option value="M (approx. 56-57 cm)" selected>M (approx. 56-57 cm)</option>
        <option value="L (approx. 58-59 cm)">L (approx. 58-59 cm)</option>
        <option value="XL (approx. 60-61 cm)">XL (approx. 60-61 cm)</option>
      </select>
    </div>
  </div>

  <!-- Toast Notification -->
  <div id="toast">Product added to basket!</div>

  <script>
    // Discount Products Data (hardcoded to avoid CORS issues)
    const discountedProducts = [
      {
        "id": "cap/hat1",
        "name": "cap/hat1",
        "category": "hats",
        "imagePath": "https://assets.onecompiler.app/42mhv938c/42mn3wcty/WhatsApp%20Image%202024-12-11%20at%2015.41.06_92c05268.jpg",
        "price": 25,
        "discount": true,
        "discountPercent": 20
      },
      {
        "id": "cap/hat3",
        "name": "cap/hat3",
        "category": "hats",
        "imagePath": "https://assets.onecompiler.app/42mhv938c/42mn3wcty/WhatsApp%20Image%202024-12-11%20at%2015.41.07_0d3af0f4.jpg",
        "price": 10,
        "discount": true,
        "discountPercent": 30
      },
      {
        "id": "cap/hat5",
        "name": "cap/hat5",
        "category": "hats",
        "imagePath": "https://assets.onecompiler.app/42mhv938c/42mn3wcty/WhatsApp%20Image%202024-12-11%20at%2015.41.07_4bcc7afc.jpg",
        "price": 10,
        "discount": true,
        "discountPercent": 60
      },
      {
        "id": "belt1",
        "name": "belt1",
        "category": "belts",
        "imagePath": "https://via.placeholder.com/150?text=Belt+1",
        "price": 50,
        "discount": true,
        "discountPercent": 30
      },
      {
        "id": "belt3",
        "name": "belt3",
        "category": "belts",
        "imagePath": "https://via.placeholder.com/150?text=Belt+3",
        "price": 60,
        "discount": true,
        "discountPercent": 40
      },
      {
        "id": "belt5",
        "name": "belt5",
        "category": "belts",
        "imagePath": "https://via.placeholder.com/150?text=Belt+5",
        "price": 70,
        "discount": true,
        "discountPercent": 65
      },
      {
        "id": "belt7",
        "name": "belt7",
        "category": "belts",
        "imagePath": "https://via.placeholder.com/150?text=Belt+7",
        "price": 80,
        "discount": true,
        "discountPercent": 25
      },
      {
        "id": "footwear1",
        "name": "footwear1",
        "category": "footwear",
        "imagePath": "https://assets.onecompiler.app/42mhv938c/42mn3wcty/WhatsApp%20Image%202024-12-11%20at%2015.41.06_f2708529.jpg",
        "price": 120,
        "discount": true,
        "discountPercent": 50
      },
      {
        "id": "footwear2",
        "name": "footwear2",
        "category": "footwear",
        "imagePath": "https://assets.onecompiler.app/42mhv938c/42mn3wcty/WhatsApp%20Image%202024-12-11%20at%2015.41.07_65068fa5.jpg",
        "price": 25,
        "discount": true,
        "discountPercent": 30
      },
      {
        "id": "footwear3",
        "name": "footwear3",
        "category": "footwear",
        "imagePath": "https://assets.onecompiler.app/42mhv938c/42mn3wcty/WhatsApp%20Image%202024-12-11%20at%2015.41.07_ec433eab.jpg",
        "price": 35,
        "discount": true,
        "discountPercent": 60
      },
      {
        "id": "glove1",
        "name": "glove1",
        "category": "gloves",
        "imagePath": "https://assets.onecompiler.app/42mhv938c/42mn3wcty/WhatsApp%20Image%202025-02-05%20at%2010.56.21_c4614d2d.jpg",
        "price": 35,
        "discount": true,
        "discountPercent": 45
      },
      {
        "id": "leather_jacket1",
        "name": "leather_jacket1",
        "category": "leather jackets",
        "imagePath": "https://assets.onecompiler.app/42mhv938c/42mn3wcty/WhatsApp%20Image%202024-12-11%20at%2015.36.08_4f9bf797.jpg",
        "price": 200,
        "discount": true,
        "discountPercent": 60
      },
      {
        "id": "leather_jacket3",
        "name": "leather_jacket3",
        "category": "leather jackets",
        "imagePath": "https://assets.onecompiler.app/42mhv938c/42mn3wcty/WhatsApp%20Image%202024-12-11%20at%2015.36.08_30f60707.jpg",
        "price": 120,
        "discount": true,
        "discountPercent": 40
      },
      {
        "id": "leather_jacket5",
        "name": "leather_jacket5",
        "category": "leather jackets",
        "imagePath": "https://assets.onecompiler.app/42mhv938c/42mn3wcty/WhatsApp%20Image%202024-12-11%20at%2015.36.08_697b5895.jpg",
        "price": 140,
        "discount": true,
        "discountPercent": 70
      },
      {
        "id": "scarf1",
        "name": "scarf1",
        "category": "scarves",
        "imagePath": "https://via.placeholder.com/150?text=Scarf+1",
        "price": 50,
        "discount": true,
        "discountPercent": 35
      },
      {
        "id": "scarf3",
        "name": "scarf3",
        "category": "scarves",
        "imagePath": "https://via.placeholder.com/150?text=Scarf+3",
        "price": 60,
        "discount": true,
        "discountPercent": 40
      },
      {
        "id": "scarf5",
        "name": "scarf5",
        "category": "scarves",
        "imagePath": "https://via.placeholder.com/150?text=Scarf+5",
        "price": 70,
        "discount": true,
        "discountPercent": 60
      },
      {
        "id": "scarf7",
        "name": "scarf7",
        "category": "scarves",
        "imagePath": "https://via.placeholder.com/150?text=Scarf+7",
        "price": 80,
        "discount": true,
        "discountPercent": 25
      },
      {
        "id": "sunglasses1",
        "name": "sunglasses1",
        "category": "sunglasses",
        "imagePath": "https://assets.onecompiler.app/42mhv938c/42mn3wcty/WhatsApp%20Image%202024-12-11%20at%2015.41.07_15f0a57a.jpg",
        "price": 80,
        "discount": true,
        "discountPercent": 55
      },
      {
        "id": "sunglasses2",
        "name": "sunglasses2",
        "category": "sunglasses",
        "imagePath": "https://assets.onecompiler.app/42mhv938c/42mn3wcty/WhatsApp%20Image%202024-12-11%20at%2015.41.22_0cecf64c.jpg",
        "price": 55,
        "discount": true,
        "discountPercent": 30
      },
      {
        "id": "sunglasses3",
        "name": "sunglasses3",
        "category": "sunglasses",
        "imagePath": "https://assets.onecompiler.app/42mhv938c/42mn3wcty/WhatsApp%20Image%202024-12-11%20at%2015.41.22_03d2784a.jpg",
        "price": 60,
        "discount": true,
        "discountPercent": 65
      },
      {
        "id": "wallet1",
        "name": "wallet1",
        "category": "wallets",
        "imagePath": "https://via.placeholder.com/300x300?text=Wallet+1",
        "price": 40,
        "discount": true,
        "discountPercent": 25
      },
      {
        "id": "wallet2",
        "name": "wallet2",
        "category": "wallets",
        "imagePath": "https://via.placeholder.com/300x300?text=Wallet+2",
        "price": 45,
        "discount": true,
        "discountPercent": 70
      }
    ];
    
    // Create a map of discounted products for easy lookup
    const discountMap = {};
    discountedProducts.forEach(product => {
      discountMap[product.id] = product;
    });
    
    // Caps and Hats Data
    const capsAndHats = [
      // Trilby Hats from Euro Accessories Catalog
      {
        id: "trilby_red",
        name: "Red Wool Felt Trilby Hat",
        price: 28,
        imgUrl: "Hat1.jpg"
      },
      {
        id: "trilby_navy",
        name: "Navy Blue Wool Felt Trilby Hat",
        price: 33.6,
        imgUrl: "Hat2.jpg"
      },
      {
        id: "trilby_purple",
        name: "Purple Wool Felt Trilby Hat",
        price: 30.4,
        imgUrl: "Hat4.jpg"
      },
      {
        id: "trilby_olive",
        name: "Olive Green Wool Felt Trilby Hat",
        price: 36,
        imgUrl: "Hat5.jpg"
      },
      {
        id: "trilby_grey",
        name: "Brown Wool Felt Trilby Hat",
        price: 26.4,
        imgUrl: "Hat7.jpg"
      },
      {
        id: "trilby_brown",
        name: "Cream Wool Felt Trilby Hat",
        price: 32,
        imgUrl: "Hat8.jpg"
      },
      {
        id: "trilby_cream",
        name: "Black Wool Felt Trilby Hat",
        price: 29.6,
        imgUrl: "Hat9.jpg"
      },
      {
        id: "trilby_black",
        name: "Beige Straw Trilby Hat",
        price: 30,
        imgUrl: "Hat10.jpg"
      },
      {
        id: "trilby_black",
        name: "Brown Suede Cowboy Hat ",
        price: 35.2,
        imgUrl: "Hats11.jpg"
      },
      {
        id: "trilby_black",
        name: "Charcoal Grey Wool Felt Trilby Hat ",
        price: 32.8,
        imgUrl: "Hat6.jpg"
      },
   
      // Original Caps and Hats
      {
        id: "cap/hat1",
        name: "Cap/Hat 1",
        price: 22,
        imgUrl: "https://assets.onecompiler.app/42mhv938c/42mn3wcty/WhatsApp%20Image%202024-12-11%20at%2015.41.06_92c05268.jpg"
      },
      {
        id: "cap/hat2",
        name: "Cap/Hat 2",
        price: 28,
        imgUrl: "https://assets.onecompiler.app/42mhv938c/42mn3wcty/WhatsApp%20Image%202024-12-11%20at%2015.41.06_d59aae1e.jpg"
      },
      {
        id: "cap/hat3",
        name: "Cap/Hat 3",
        price: 32,
        imgUrl: "https://assets.onecompiler.app/42mhv938c/42mn3wcty/WhatsApp%20Image%202024-12-11%20at%2015.41.07_0d3af0f4.jpg"
      },
      {
        id: "cap/hat4",
        name: "Cap/Hat 4",
        price: 29,
        imgUrl: "https://assets.onecompiler.app/42mhv938c/42mn3wcty/WhatsApp%20Image%202024-12-11%20at%2015.41.07_2ed29745.jpg"
      },
      {
        id: "cap/hat5",
        name: "Cap/Hat 5",
        price: 28,
        imgUrl: "https://assets.onecompiler.app/42mhv938c/42mn3wcty/WhatsApp%20Image%202024-12-11%20at%2015.41.07_4bcc7afc.jpg"
      },
      {
        id: "cap/hat6",
        name: "Cap/Hat 6",
        price: 27,
        imgUrl: "https://assets.onecompiler.app/42mhv938c/42mn3wcty/WhatsApp%20Image%202024-12-11%20at%2015.41.07_6bf678a6.jpg"
      },
      {
        id: "cap/hat7",
        name: "Cap/Hat 7",
        price: 31,
        imgUrl: "https://assets.onecompiler.app/42mhv938c/42mn3wcty/WhatsApp%20Image%202024-12-11%20at%2015.41.07_7b17512e.jpg"
      },
      {
        id: "cap/hat8",
        name: "Cap/Hat 8",
        price: 30.4,
        imgUrl: "https://assets.onecompiler.app/42mhv938c/42mn3wcty/WhatsApp%20Image%202024-12-11%20at%2015.41.12_0bad76c2.jpg"
      },
      {
        id: "cap/hat9",
        name: "Cap/Hat 9",
        price: 26.4,
        imgUrl: "https://assets.onecompiler.app/42mhv938c/42mn3wcty/WhatsApp%20Image%202024-12-11%20at%2015.41.12_41b2ad03.jpg"
      },
      {
        id: "cap/hat10",
        name: "Cap/Hat 10",
        price: 32,
        imgUrl: "https://assets.onecompiler.app/42mhv938c/42mn3wcty/WhatsApp%20Image%202024-12-11%20at%2015.41.14_1326d9c4.jpg"
      },
      {
        id: "cap/hat11",
        name: "Cap/Hat 11",
        price: 26,
        imgUrl: "https://assets.onecompiler.app/42mhv938c/42mn3wcty/WhatsApp%20Image%202024-12-11%20at%2015.41.15_d9b0e21e.jpg"
      },
      {
        id: "cap/hat12",
        name: "Cap/Hat 12",
        price: 24,
        imgUrl: "https://assets.onecompiler.app/42mhv938c/42mn3wcty/WhatsApp%20Image%202024-12-11%20at%2015.41.16_3a3c5b1e.jpg"
      },
      {
        id: "cap/hat13",
        name: "Cap/Hat 13",
        price: 30,
        imgUrl: "https://assets.onecompiler.app/42mhv938c/42mn3wcty/WhatsApp%20Image%202024-12-11%20at%2015.41.17_766ffa2a.jpg"
      },
      {
        id: "cap/hat14",
        name: "Cap/Hat 14",
        price: 28,
        imgUrl: "https://assets.onecompiler.app/42mhv938c/42mn3wcty/WhatsApp%20Image%202024-12-11%20at%2015.41.17_52975b9e.jpg"
      },
      {
        id: "cap/hat15",
        name: "Cap/Hat 15",
        price: 23,
        imgUrl: "https://assets.onecompiler.app/42mhv938c/42mn3wcty/WhatsApp%20Image%202024-12-11%20at%2015.41.17_57231dbd.jpg"
      },
      {
        id: "cap/hat16",
        name: "Cap/Hat 16",
        price: 29,
        imgUrl: "https://assets.onecompiler.app/42mhv938c/42mn3wcty/WhatsApp%20Image%202024-12-11%20at%2015.41.18_1af4e864.jpg"
      },
      {
        id: "cap/hat17",
        name: "Cap/Hat 17",
        price: 27.2,
        imgUrl: "https://assets.onecompiler.app/42mhv938c/42mn3wcty/WhatsApp%20Image%202024-12-11%20at%2015.41.18_69a127d8.jpg"
      },
      {
        id: "cap/hat18",
        name: "Cap/Hat 18",
        price: 26,
        imgUrl: "https://assets.onecompiler.app/42mhv938c/42mn3wcty/WhatsApp%20Image%202024-12-11%20at%2015.41.19_1e60bd92.jpg"
      },
      {
        id: "cap/hat19",
        name: "Cap/Hat 19",
        price: 31,
        imgUrl: "https://assets.onecompiler.app/42mhv938c/42mn3wcty/WhatsApp%20Image%202024-12-11%20at%2015.41.19_83a921e0.jpg"
      },
      {
        id: "cap/hat20",
        name: "Cap/Hat 20",
        price: 29.6,
        imgUrl: "https://assets.onecompiler.app/42mhv938c/42mn3wcty/WhatsApp%20Image%202024-12-11%20at%2015.41.20_399766ec.jpg"
      },
      {
        id: "cap/hat21",
        name: "Cap/Hat 21",
        price: 25,
        imgUrl: "https://assets.onecompiler.app/42mhv938c/42mn3wcty/WhatsApp%20Image%202024-12-11%20at%2015.41.20_a5aabbae.jpg"
      },
      {
        id: "cap/hat22",
        name: "Cap/Hat 22",
        price: 26.4,
        imgUrl: "https://assets.onecompiler.app/42mhv938c/42mn3wcty/WhatsApp%20Image%202024-12-11%20at%2015.41.21_0fe5753e.jpg"
      },
      {
        id: "cap/hat23",
        name: "Cap/Hat 23",
        price: 28,
        imgUrl: "https://assets.onecompiler.app/42mhv938c/42mn3wcty/WhatsApp%20Image%202024-12-11%20at%2015.41.21_04e5e7f4.jpg"
      },
      {
        id: "cap/hat24",
        name: "Cap/Hat 24",
        price: 28.8,
        imgUrl: "https://assets.onecompiler.app/42mhv938c/42mn3wcty/WhatsApp%20Image%202024-12-11%20at%2015.41.21_2a6d2a2c.jpg"
      },
      {
        id: "cap/hat25",
        name: "Cap/Hat 25",
        price: 30,
        imgUrl: "https://assets.onecompiler.app/42mhv938c/42mn3wcty/WhatsApp%20Image%202024-12-11%20at%2015.41.11_ed92bc2b.jpg"
      },
      {
        id: "cap/hat26",
        name: "Cap/Hat 26",
        price: 28,
        imgUrl: "https://assets.onecompiler.app/42mhv938c/42mn3wcty/WhatsApp%20Image%202024-12-11%20at%2015.41.12_0bad76c2.jpg"
      },
      {
        id: "cap/hat27",
        name: "Cap/Hat 27",
        price: 27,
        imgUrl: "https://assets.onecompiler.app/42mhv938c/42mn3wcty/WhatsApp%20Image%202024-12-11%20at%2015.41.12_41b2ad03.jpg"
      },
      {
        id: "cap/hat28",
        name: "Cap/Hat 28",
        price: 32,
        imgUrl: "https://assets.onecompiler.app/42mhv938c/42mn3wcty/WhatsApp%20Image%202024-12-11%20at%2015.41.12_41b2ad03.jpg"
      },
      {
        id: "cap/hat29",
        name: "Cap/Hat 29",
        price: 31.2,
        imgUrl: "https://assets.onecompiler.app/42mhv938c/42mn3wcty/WhatsApp%20Image%202024-12-11%20at%2015.41.14_1326d9c4.jpg"
      },
      {
        id: "cap/hat30",
        name: "Cap/Hat 30",
        price: 24,
        imgUrl: "https://assets.onecompiler.app/42mhv938c/42mn3wcty/WhatsApp%20Image%202024-12-11%20at%2015.41.15_d9b0e21e.jpg"
      },
      {
        id: "cap/hat31",
        name: "Cap/Hat 31",
        price: 30.4,
        imgUrl: "https://assets.onecompiler.app/42mhv938c/42mn3wcty/WhatsApp%20Image%202024-12-11%20at%2015.41.16_3a3c5b1e.jpg"
      },
      {
        id: "cap/hat32",
        name: "Cap/Hat 32",
        price: 26,
        imgUrl: "https://assets.onecompiler.app/42mhv938c/42mn3wcty/WhatsApp%20Image%202024-12-11%20at%2015.41.17_766ffa2a.jpg"
      },
      {
        id: "cap/hat33",
        name: "Cap/Hat 33",
        price: 27.2,
        imgUrl: "https://assets.onecompiler.app/42mhv938c/42mn3wcty/WhatsApp%20Image%202024-12-11%20at%2015.41.17_52975b9e.jpg"
      },
      {
        id: "cap/hat34",
        name: "Cap/Hat 34",
        price: 29,
        imgUrl: "https://assets.onecompiler.app/42mhv938c/42mn3wcty/WhatsApp%20Image%202024-12-11%20at%2015.41.17_57231dbd.jpg"
      },
      {
        id: "cap/hat35",
        name: "Cap/Hat 35",
        price: 32.8,
        imgUrl: "https://assets.onecompiler.app/42mhv938c/42mn3wcty/WhatsApp%20Image%202024-12-11%20at%2015.41.18_1af4e864.jpg"
      },
      {
        id: "cap/hat36",
        name: "Cap/Hat 36",
        price: 23,
        imgUrl: "https://assets.onecompiler.app/42mhv938c/42mn3wcty/WhatsApp%20Image%202024-12-11%20at%2015.41.18_69a127d8.jpg"
      },
      {
        id: "cap/hat37",
        name: "Cap/Hat 37",
        price: 28.8,
        imgUrl: "https://assets.onecompiler.app/42mhv938c/42mn3wcty/WhatsApp%20Image%202024-12-11%20at%2015.41.19_1e60bd92.jpg"
      },
      {
        id: "cap/hat38",
        name: "Cap/Hat 38",
        price: 31,
        imgUrl: "https://assets.onecompiler.app/42mhv938c/42mn3wcty/WhatsApp%20Image%202024-12-11%20at%2015.41.19_83a921e0.jpg"
      },
      {
        id: "cap/hat39",
        name: "Cap/Hat 39",
        price: 28,
        imgUrl: "https://assets.onecompiler.app/42mhv938c/42mn3wcty/WhatsApp%20Image%202024-12-11%20at%2015.41.20_399766ec.jpg"
      },
      {
        id: "cap/hat40",
        name: "Cap/Hat 40",
        price: 34.4,
        imgUrl: "https://assets.onecompiler.app/42mhv938c/42mn3wcty/WhatsApp%20Image%202024-12-11%20at%2015.41.20_a5aabbae.jpg"
      },
      {
        id: "cap/hat41",
        name: "Cap/Hat 41",
        price: 25,
        imgUrl: "https://assets.onecompiler.app/42mhv938c/42mn3wcty/WhatsApp%20Image%202024-12-11%20at%2015.41.21_0fe5753e.jpg"
      },
      {
        id: "cap/hat42",
        name: "Cap/Hat 42",
        price: 29.6,
        imgUrl: "https://assets.onecompiler.app/42mhv938c/42mn3wcty/WhatsApp%20Image%202024-12-11%20at%2015.41.21_04e5e7f4.jpg"
      },
      {
        id: "cap/hat43",
        name: "Cap/Hat 43",
        price: 26.4,
        imgUrl: "https://assets.onecompiler.app/42mhv938c/42mn3wcty/WhatsApp%20Image%202024-12-11%20at%2015.41.21_2a6d2a2c.jpg"
      },
      {
        id: "cap/hat44",
        name: "Cap/Hat 44",
        price: 32,
        imgUrl: "https://assets.onecompiler.app/42mhv938c/42mn3wcty/WhatsApp%20Image%202024-12-11%20at%2015.41.21_5a63210f.jpg"
      },
      {
        id: "cap/hat45",
        name: "Cap/Hat 45",
        price: 27,
        imgUrl: "https://assets.onecompiler.app/42mhv938c/42mn3wcty/WhatsApp%20Image%202024-12-11%20at%2015.41.21_30e4ffd0.jpg"
      },
      {
        id: "cap/hat46",
        name: "Cap/Hat 46",
        price: 28,
        imgUrl: "https://assets.onecompiler.app/42mhv938c/42mn3wcty/WhatsApp%20Image%202024-12-11%20at%2015.41.21_326946a7.jpg"
      },
      {
        id: "cap/hat47",
        name: "Cap/Hat 47",
        price: 30,
        imgUrl: "https://assets.onecompiler.app/42mhv938c/42mn3wcty/WhatsApp%20Image%202024-12-11%20at%2015.41.21_643c2e96.jpg"
      },
      {
        id: "cap/hat48",
        name: "Cap/Hat 48",
        price: 33.6,
        imgUrl: "https://assets.onecompiler.app/42mhv938c/42mn3wcty/WhatsApp%20Image%202024-12-11%20at%2015.41.21_326946a7.jpg"
      }
    ];
    
    // Populate Products
    function populateProducts() {
      const productsContainer = document.getElementById("products-container");
      productsContainer.innerHTML = '';
      
      // Build render list: keep Trilby/local hats as-is; remove selected caps; assign local images Hat12..Hat33 to the first visible caps and give them proper names
      const removeSet = new Set([
        'cap/hat4','cap/hat7','cap/hat12','cap/hat16','cap/hat24','cap/hat31','cap/hat35','cap/hat37','cap/hat39','cap/hat40','cap/hat41','cap/hat42','cap/hat43','cap/hat44','cap/hat45','cap/hat46','cap/hat48',
        // Newly requested removals
        'cap/hat28','cap/hat29','cap/hat30','cap/hat32','cap/hat33','cap/hat34','cap/hat36','cap/hat38','cap/hat47'
      ]);
      const trilbies = capsAndHats.filter(x => !(typeof x.id === 'string' && x.id.startsWith('cap/hat')));
      const remainingCaps = capsAndHats.filter(x => (typeof x.id === 'string' && x.id.startsWith('cap/hat') && !removeSet.has(x.id)));
      // Assign local images Hat12..Hat33 to the first N caps and set appropriate names (IDs unchanged, discount positions preserved)
      const localCapsImages = Array.from({ length: 22 }, (_, i) => `Hat${12 + i}.jpg`);
      const refinedNames = [
        'Crimson Wool Elegance',
        'Burgundy Faux-Fur Charm',
        'Sand Linen Classic',
        'Amber Straw Flair',
        'Leopard Velvet Icon',
        'Brick Vintage Statement',
        'Midnight Mohair Mood',
        "Steampunk Engineer’s Touch",
        'Jet Black Silhouette',
        'Russet Winter Warmth',
        'Charcoal Newsboy Classic',
        'Burgundy Plaid Revival',
        'Windsor Check Heritage',
        'Forest Tweed Tradition',
        'Oxford Glencheck Legacy',
        'Highland Moss Texture',
        'Navy Wool Sophistication',
        'Ash Tweed Heritage',
        'Rustic Brown Herringbone',
        'Emerald Plush Flair',
        'Dual-Tone Patch Classic',
        'Sky Corduroy Touch'
      ];
      const mappedCaps = remainingCaps.map((capItem, idx) => {
        if (idx < localCapsImages.length) {
          const img = localCapsImages[idx];
          const name = refinedNames[idx] || capItem.name;
          return { ...capItem, imgUrl: img, name };
        }
        return capItem;
      });
      const itemsToRender = [...trilbies, ...mappedCaps];

      itemsToRender.forEach(hat => {
        const productDiv = document.createElement('div');
        productDiv.className = 'product';
        
        // Check if this hat is in the discounted products
        const discountInfo = discountMap[hat.id];
        let productHTML = '';
        let priceDisplay = '';
        let modalParams = '';
        
        if (discountInfo && discountInfo.discount) {
          // Calculate discounted price
          const discountedPrice = hat.price * (1 - discountInfo.discountPercent / 100);
          const formattedOriginalPrice = `£${hat.price}`;
          const formattedDiscountedPrice = `£${discountedPrice.toFixed(2)}`;
          
          // Determine tag type based on discount percentage
          const tagType = discountInfo.discountPercent > 55 ? 'gold' : 'red';
          const tagText = tagType === 'gold' 
            ? `★★ ${discountInfo.discountPercent}% OFF – Bargain of the Day ★★`
            : `★ ${discountInfo.discountPercent}% OFF ★`;
          
          // Add discount tag
          productHTML += `<div class="discount-tag ${tagType}">${tagText}</div>`;
          
          // Price display with original and new price
          priceDisplay = `<p><span class="original-price">${formattedOriginalPrice}</span> <span class="new-price">${formattedDiscountedPrice}</span></p>`;
          
          // Modal parameters
          modalParams = `openProductModal('${hat.name}', '${formattedDiscountedPrice}', '${hat.imgUrl}', true, '${formattedOriginalPrice}')`;
        } else {
          // Regular price display
          priceDisplay = `<p>£${hat.price}</p>`;
          
          // Modal parameters
          modalParams = `openProductModal('${hat.name}', '£${hat.price}', '${hat.imgUrl}')`;
        }
        
        // Check if it's a placeholder image
        const isPlaceholder = hat.imgUrl.includes('placeholder.com');
        const imgStyle = isPlaceholder ? 'style="opacity: 0;"' : '';
        
        // Complete product HTML (with local fallback if image fails)
        productHTML += `
          <img src="${hat.imgUrl}" alt="${hat.name}" ${imgStyle} loading="lazy" onerror="this.onerror=null; this.src='Hat1.jpg';">
          <p>${hat.name}</p>
          ${priceDisplay}
        `;
        
        productDiv.innerHTML = productHTML;
        productDiv.onclick = function() {
          eval(modalParams);
        };
        
        productsContainer.appendChild(productDiv);
      });
    }
    
    // Mobile Menu Toggle, ensure basket dropdown refreshes when opening
    const menuToggle = document.getElementById("menuToggle");
    const mobileNav = document.getElementById("mobileNav");
    if (menuToggle && mobileNav) {
      menuToggle.addEventListener("click", () => {
        mobileNav.classList.toggle("active");
        // When opening the drawer, pre-render the basket so it's ready when tapping
        if (mobileNav.classList.contains('active')) {
          try { window.dispatchEvent(new CustomEvent('cartUpdated')); } catch(_) {}
          if (window.SharedBasketDropdown && typeof window.SharedBasketDropdown.refresh === 'function') {
            try { window.SharedBasketDropdown.refresh(); } catch(_) {}
          }
        }
      });
      document.addEventListener("click", (event) => {
        if (!event.target.closest("#mobileNav") && !event.target.closest("#menuToggle")) {
          if (mobileNav.classList.contains("active")) {
            mobileNav.classList.remove("active");
          }
        }
      });
    }
    
    // Filter Products
    function filterProducts() {
      const searchInput = document.getElementById("searchInput").value.toLowerCase();
      const productElements = document.querySelectorAll(".product");
      productElements.forEach((productEl) => {
        const nameText = productEl.querySelector("p:nth-of-type(1)").textContent.toLowerCase();
        const priceText = productEl.querySelector("p:nth-of-type(2)").textContent.toLowerCase();
        productEl.style.display = (nameText.includes(searchInput) || priceText.includes(searchInput)) ? "flex" : "none";
      });
    }
    
    // Modal Logic
    const modal = document.getElementById("productModal");
    const closeModalBtn = document.getElementById("closeModal");
    const modalProductImage = document.getElementById("modalProductImage");
    const modalProductName = document.getElementById("modalProductName");
    const modalProductPrice = document.getElementById("modalProductPrice");
    const sizeSelector = document.getElementById("sizeSelector"); // Added size selector
    
    function openProductModal(name, price, imgUrl, isDiscounted = false, originalPrice = null) {
      modalProductName.textContent = name;
      
      if (isDiscounted && originalPrice) {
        modalProductPrice.innerHTML = `<span class="original-price">${originalPrice}</span> <span class="new-price">${price}</span>`;
      } else {
        modalProductPrice.textContent = price;
      }
      
      modalProductImage.src = imgUrl;
      modalProductImage.alt = name;
      modal.classList.add("show");
      modal.style.display = "flex";
    }
    
    function closeModal() {
      modal.classList.remove("show");
      setTimeout(() => {
        modal.style.display = "none";
      }, 400);
    }
    closeModalBtn.onclick = closeModal;
    modal.addEventListener("click", (event) => {
      if (!event.target.closest(".modal-content")) {
        closeModal();
      }
    });
    
    // Firebase Cart Integration
    let currentProductData = null;
    
    // Function to extract product data from modal
    function extractProductFromModal() {
      const name = modalProductName.textContent;
      const priceElement = modalProductPrice.querySelector(".new-price");
      const price = priceElement ? priceElement.textContent : modalProductPrice.textContent;
      const imgUrl = modalProductImage.src;
      
      // Convert price to cents (preserve decimals accurately)
      const numericPrice = parseFloat(price.replace(/[£,]/g, ''));
      const priceInCents = Number.isFinite(numericPrice) ? Math.round(numericPrice * 100) : 0;
      
      return {
        id: name.toLowerCase().replace(/\s+/g, '-'),
        name: name,
        price: priceInCents,
        image: imgUrl,
        category: 'caps_and_hats'
      };
    }
    
    // Firebase cart function
    async function addToBasketFirebase() {
      try {
        if (!window.FitRightFirebase) {
          console.error('FitRightFirebase not loaded');
          return;
        }
        
        const productData = extractProductFromModal();
        await window.FitRightFirebase.addProductToCart(productData, 1);
        showToast("Product added to basket!");
        console.log("Product added to Firebase cart:", productData);
      } catch (error) {
        console.error("Error adding to cart:", error);
        showToast("Error adding to basket: " + error.message);
      }
    }
    
    // Basket Handling & Toast Notification
    function addToBasket(name, price, imgUrl, size, showMessage = true) {
      let basket = JSON.parse(localStorage.getItem("basket")) || [];
      const existingIndex = basket.findIndex(item => item.name === name);
      if (existingIndex !== -1) {
        const item = basket[existingIndex];
        item.quantity = (item.quantity || 1) + 1;
        localStorage.setItem("basket", JSON.stringify(basket));
        
        // Immediately update the basket counter
        const totalCount = basket.reduce((sum, item) => sum + (item.quantity || 1), 0);
        basketCount.textContent = totalCount;
        basketCount.style.display = 'inline-block';
        if (basketCountMobile) {
          basketCountMobile.textContent = totalCount;
          basketCountMobile.style.display = 'inline-block';
        }
        
        if (window.SharedBasketDropdown && typeof window.SharedBasketDropdown.refresh === 'function') {
          window.SharedBasketDropdown.refresh();
        }
        try { window.dispatchEvent(new CustomEvent('cartUpdated')); } catch(_) {}
        if (showMessage) showToast("Product quantity updated in basket!");
      } else {
        basket.push({ name, newPrice: price, imgUrl, size, quantity: 1 });
        localStorage.setItem("basket", JSON.stringify(basket));
        
        // Immediately update the basket counter
        const totalCount = basket.reduce((sum, item) => sum + (item.quantity || 1), 0);
        basketCount.textContent = totalCount;
        basketCount.style.display = 'inline-block';
        if (basketCountMobile) {
          basketCountMobile.textContent = totalCount;
          basketCountMobile.style.display = 'inline-block';
        }
        
        if (window.SharedBasketDropdown && typeof window.SharedBasketDropdown.refresh === 'function') {
          window.SharedBasketDropdown.refresh();
        }
        try { window.dispatchEvent(new CustomEvent('cartUpdated')); } catch(_) {}
        if (showMessage) showToast("Product added to basket!");
      }
    }
    
    document.getElementById("addToBasket").onclick = function () {
      // Use Firebase if available, otherwise fallback to localStorage
      if (window.FitRightFirebase) {
        addToBasketFirebase();
        closeModal();
      } else {
        const name = modalProductName.textContent;
        const priceElement = modalProductPrice.querySelector(".new-price");
        const price = priceElement ? priceElement.textContent : modalProductPrice.textContent;
        const imgUrl = modalProductImage.src;
        const selectedSize = sizeSelector.value;
        addToBasket(name, price, imgUrl, selectedSize, true);
        closeModal();
      }
    };
    
    document.getElementById("proceedToPayment").onclick = function() {
      const name = modalProductName.textContent;
      const priceElement = modalProductPrice.querySelector(".new-price");
      const price = priceElement ? priceElement.textContent : modalProductPrice.textContent;
      const imageUrl = modalProductImage.src;
      const selectedSize = sizeSelector.value; // Get selected size
      addToBasket(name, price, imageUrl, selectedSize, false); // Pass selected size, no toast
      const queryString = `?name=${encodeURIComponent(name)}&price=${encodeURIComponent(price)}&imgUrl=${encodeURIComponent(imageUrl)}&size=${encodeURIComponent(selectedSize)}`; // Add size to query string
      window.location.href = "page3.html" + queryString;
    };
    
    function showToast(message) {
      const toastEl = document.getElementById("toast");
      toastEl.textContent = message;
      toastEl.classList.add("show");
      setTimeout(() => {
        toastEl.classList.remove("show");
      }, 2000);
    }
    
    // Initialize page
    document.addEventListener('DOMContentLoaded', populateProducts);

    // Basket Handling
    const basketDropdownBtn = document.getElementById('basketDropdownBtn');
    const basketDropdownBtnMobile = document.getElementById('basketDropdownBtnMobile');
    const basketDropdown = document.getElementById('basketDropdown');
    const basketDropdownContent = document.getElementById('basketDropdownContent');
    // Reuse desktop dropdown for mobile to avoid duplicated render/listeners
    const basketDropdownMobile = basketDropdown;
    const basketDropdownContentMobile = document.getElementById('basketDropdownContent');
    const basketCount = document.getElementById('basketCount');
    const basketCountMobile = document.getElementById('basketCountMobile');

    // Firebase cart rendering
    function renderCart() {
      if (!window.FitRightFirebase) return;
      
      const cartItems = window.FitRightFirebase.getCartItems();
      const cartCount = window.FitRightFirebase.getCartCount();
      
      // Update counters
      basketCount.textContent = cartCount;
      basketCount.style.display = cartCount > 0 ? 'inline-block' : 'none';
      if (basketCountMobile) {
        basketCountMobile.textContent = cartCount;
        basketCountMobile.style.display = cartCount > 0 ? 'inline-block' : 'none';
      }
      
      // Update dropdown content
      if (cartItems.length === 0) {
        basketDropdownContent.innerHTML = '<div style="text-align:center;color:#888;">Your basket is empty.</div>';
        if (basketDropdownContentMobile) {
          basketDropdownContentMobile.innerHTML = '<div style="text-align:center;color:#888;">Your basket is empty.</div>';
        }
        return;
      }
      
      const basketHTML = cartItems.map((item, idx) => `
        <div class="basket-row" data-index="${idx}" data-id="${item.id || item.productId || idx}" style="display:flex;align-items:center;margin-bottom:12px;padding-bottom:8px;position:relative;">
          <div style="width:48px;height:48px;background:#fafafa;border-radius:10px;margin-right:12px;display:flex;align-items:center;justify-content:center;">
            <img src="${item.productImage || item.image || item.imgUrl}" alt="${item.productName || item.name}" style="width:100%;height:100%;object-fit:contain;border-radius:10px;" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
            <div style="display:none;width:100%;height:100%;align-items:center;justify-content:center;color:#999;font-size:12px;text-align:center;line-height:1.2;">📦</div>
          </div>
          <div style="flex:1;">
            <div style="font-family:'Special Elite',monospace;font-size:1em;">${item.productName || item.name}</div>
            <div style="font-size:1em;font-weight:bold;">${window.FitRightFirebase && window.FitRightFirebase.formatPrice && (item.productPrice != null || item.price != null) ? window.FitRightFirebase.formatPrice((item.productPrice ?? item.price)) : (item.newPrice || '£0.00')}</div>
            <div style="font-size:0.95em;color:#555;">Qty: <span class="basket-qty" data-id="${item.id || item.productId || idx}">${item.quantity || 1}</span></div>
            ${item.selectedSize ? `<div style="font-size:0.95em;color:#555;">Size: ${item.selectedSize}</div>` : ''}
          </div>
          <button class="basket-minus-btn" data-index="${idx}" data-id="${item.id || item.productId || idx}" onclick="__removeBasketItem(this); return false;" ontouchend="__removeBasketItem(this); return false;" onpointerup="__removeBasketItem(this); return false;" style="background:#000;color:#fff;border:none;border-radius:50%;width:22px;height:22px;font-size:1em;display:flex;align-items:center;justify-content:center;cursor:pointer;position:absolute;top:8px;right:8px;">&minus;</button>
        </div>
      `).join('');
      
      basketDropdownContent.innerHTML = basketHTML;
      if (basketDropdownContentMobile) {
        basketDropdownContentMobile.innerHTML = basketHTML;
      }
      
      // Add event listeners for basket minus buttons
      // Add event listeners for minus buttons (both desktop and mobile)
      const allBasketContainers = [basketDropdownContent];
      if (basketDropdownContentMobile) {
        allBasketContainers.push(basketDropdownContentMobile);
      }
      
      allBasketContainers.forEach(container => {
        container.querySelectorAll('.basket-minus-btn').forEach(btn => {
          btn.addEventListener('click', function(e) {
            e.stopPropagation();
            e.preventDefault();
            
            const cartItemId = this.getAttribute('data-id');
            const row = this.closest('.basket-row');
            const idx = parseInt(this.getAttribute('data-index'));
            
            let currentBasket = JSON.parse(localStorage.getItem("basket")) || [];
            if (currentBasket[idx] && currentBasket[idx].quantity > 1) {
              currentBasket[idx].quantity -= 1;
              localStorage.setItem("basket", JSON.stringify(currentBasket));
              updateBasketDropdown();
            } else {
              row.classList.remove('basket-fade-in');
              row.classList.add('basket-fade-out');
              setTimeout(() => {
                currentBasket.splice(idx, 1);
                localStorage.setItem("basket", JSON.stringify(currentBasket));
                updateBasketDropdown();
              }, 300);
            }
          });
        });
      });
    }
    
    // Basket data storage
    window.basket = JSON.parse(localStorage.getItem("basket")) || [];
    
    // Listen for cart updates
    window.addEventListener('cartUpdated', renderCart);
    
    // Load cart on page load
    document.addEventListener('DOMContentLoaded', function() {
      if (window.FitRightFirebase && window.SharedBasketDropdown) {
        window.FitRightFirebase.loadCart().then(() => {
          try { window.SharedBasketDropdown.refresh(); } catch(_) {}
        });
      }
    });

    function updateBasketDropdown() {
      // Get cart data from Firebase or localStorage fallback
      let cartItems, cartCount;
      
      if (window.FitRightFirebase && window.FitRightFirebase.isLoggedIn()) {
        cartItems = window.FitRightFirebase.getCartItems();
        cartCount = window.FitRightFirebase.getCartCount();
      } else {
        // Fallback to localStorage for guest mode
        const basket = JSON.parse(localStorage.getItem("basket")) || [];
        cartItems = basket;
        cartCount = basket.reduce((sum, item) => sum + (item.quantity || 1), 0);
      }
      
      if (cartItems.length === 0) {
        basketDropdownContent.innerHTML = '<div style="text-align:center;color:#888;">Your basket is empty.</div>';
        basketCount.style.display = 'none';
        if (basketCountMobile) {
          basketCountMobile.textContent = '0';
          basketCountMobile.style.display = 'none';
        }
        
        // Hide clear basket button when empty
        const basketDropdownFooter = document.getElementById('basketDropdownFooter');
        if (basketDropdownFooter) {
          basketDropdownFooter.style.display = 'none';
        }
        
        return;
      }
      
      basketCount.textContent = cartCount;
      basketCount.style.display = 'inline-block';
      if (basketCountMobile) {
        basketCountMobile.textContent = cartCount;
        basketCountMobile.style.display = (cartCount === 0) ? 'none' : 'inline-block';
      }
      
      const basketHTML = cartItems.map((item, idx) => `
        <div class="basket-row" data-index="${idx}" data-id="${item.id || item.productId}" style="display:flex;align-items:center;margin-bottom:12px;padding-bottom:8px;position:relative;">
          <div style="width:48px;height:48px;background:#fafafa;border-radius:10px;margin-right:12px;display:flex;align-items:center;justify-content:center;">
            <img src="${item.image || item.productImage || item.imgUrl}" alt="${item.name || item.productName}" style="width:100%;height:100%;object-fit:contain;border-radius:10px;" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
            <div style="display:none;width:100%;height:100%;align-items:center;justify-content:center;color:#999;font-size:12px;text-align:center;line-height:1.2;">📦</div>
          </div>
          <div style="flex:1;">
            <div style="font-family:'Special Elite',monospace;font-size:1em;">${item.name || item.productName}</div>
            <div style="font-size:1em;font-weight:bold;">${window.FitRightFirebase && window.FitRightFirebase.formatPrice && (item.productPrice != null || item.price != null) ? window.FitRightFirebase.formatPrice((item.productPrice ?? item.price)) : (item.newPrice || '£0.00')}</div>
            <div style="font-size:0.95em;color:#555;">Qty: <span class="basket-qty" data-id="${item.id || item.productId}">${item.quantity || 1}</span></div>
            ${item.size ? `<div style="font-size:0.95em;color:#555;">Size: ${item.size}</div>` : ''}
          </div>
          <button class="basket-minus-btn" data-index="${idx}" data-id="${item.id || item.productId}" onclick="__removeBasketItem(this); return false;" ontouchend="__removeBasketItem(this); return false;" onpointerup="__removeBasketItem(this); return false;" style="background:#000;color:#fff;border:none;border-radius:50%;width:22px;height:22px;font-size:1em;display:flex;align-items:center;justify-content:center;cursor:pointer;position:absolute;top:8px;right:8px;">&minus;</button>
        </div>
      `).join('');

      basketDropdownContent.innerHTML = basketHTML;

      // Show clear basket button when there are items
      const basketDropdownFooter = document.getElementById('basketDropdownFooter');
      if (basketDropdownFooter) {
        basketDropdownFooter.style.display = 'block';
      }

      // Add event listeners for minus buttons (desktop)
      basketDropdownContent.querySelectorAll('.basket-minus-btn').forEach(btn => {
        btn.addEventListener('click', async function(e) {
          e.stopPropagation();
          e.preventDefault();
          
          const cartItemId = this.getAttribute('data-id');
          const row = this.closest('.basket-row');
          
          if (window.FitRightFirebase && window.FitRightFirebase.isLoggedIn()) {
            // Firebase mode
            try {
              // Get current quantity
              const cartItems = window.FitRightFirebase.getCartItems();
              const currentItem = cartItems.find(item => (item.id || item.productId) === cartItemId);
              
              if (currentItem && currentItem.quantity > 1) {
                // Decrease quantity
                await window.FitRightFirebase.updateQuantity(cartItemId, currentItem.quantity - 1);
                console.log("Quantity decreased for item:", cartItemId);
              } else {
                // Remove item completely
                row.classList.remove('basket-fade-in');
                row.classList.add('basket-fade-out');
                setTimeout(async () => {
                  await window.FitRightFirebase.removeFromCart(cartItemId);
                  console.log("Item removed from cart:", cartItemId);
                }, 300);
              }
            } catch (error) {
              console.error("Error updating cart:", error);
              showToast("Error updating basket: " + error.message);
            }
          } else {
            // localStorage mode
            const idx = parseInt(this.getAttribute('data-index'));
            let basket = JSON.parse(localStorage.getItem("basket")) || [];
            
            if (basket[idx] && basket[idx].quantity > 1) {
              basket[idx].quantity -= 1;
              localStorage.setItem("basket", JSON.stringify(basket));
              // Update only the quantity number in the DOM
              const qtySpan = row.querySelector('.basket-qty');
              if (qtySpan) qtySpan.textContent = basket[idx].quantity;
              // Also update the basket counters
              const basketCount = document.getElementById('basketCount');
              const basketCountMobile = document.getElementById('basketCountMobile');
              const totalCount = basket.reduce((sum, item) => sum + (item.quantity || 1), 0);
              if (basketCount) {
                basketCount.textContent = totalCount;
                basketCount.style.display = totalCount > 0 ? 'inline-block' : 'none';
              }
              if (basketCountMobile) basketCountMobile.textContent = totalCount;
            } else {
              row.classList.remove('basket-fade-in');
              row.classList.add('basket-fade-out');
              setTimeout(() => {
                basket.splice(idx, 1);
                localStorage.setItem("basket", JSON.stringify(basket));
                updateBasketDropdown();
              }, 300);
            }
          }  
        });
      });

      // Add event listeners for minus buttons (mobile)
      // Mobile shares the same dropdown; mobile taps are handled by onclick on the button
    }

    basketDropdownBtn.addEventListener('click', async function(e) {
      e.stopPropagation();
      // Always refresh content before toggling
      try { window.dispatchEvent(new CustomEvent('cartUpdated')); } catch(_) {}
      if (window.SharedBasketDropdown && typeof window.SharedBasketDropdown.refresh === 'function') {
        try { window.SharedBasketDropdown.refresh(); } catch(_) {}
      } else {
        try { updateBasketDropdown(); } catch(_) {}
      }
      const isOpen = basketDropdown.classList.contains('show');
      if (isOpen) {
        basketDropdown.classList.remove('show');
        setTimeout(() => { basketDropdown.style.display = 'none'; }, 300);
      } else {
        basketDropdown.style.display = 'block';
        setTimeout(() => { basketDropdown.classList.add('show'); }, 10);
      }
    });

    if (basketDropdownBtnMobile && basketDropdown) {
      basketDropdownBtnMobile.addEventListener('click', async function(e) {
        e.stopPropagation();
        // Refresh content
        try { window.dispatchEvent(new CustomEvent('cartUpdated')); } catch(_) {}
        if (window.SharedBasketDropdown && typeof window.SharedBasketDropdown.refresh === 'function') {
          try { window.SharedBasketDropdown.refresh(); } catch(_) {}
        } else {
          try { updateBasketDropdown(); } catch(_) {}
        }
        // Move dropdown right under the mobile basket button in the DOM
        const li = basketDropdownBtnMobile.closest('li');
        if (li && li.nextSibling !== basketDropdown) {
          li.parentNode.insertBefore(basketDropdown, li.nextSibling);
        }
        const isOpen = basketDropdown.classList.contains('show');
        if (isOpen) {
          basketDropdown.classList.remove('show');
          setTimeout(() => { basketDropdown.style.display = 'none'; }, 300);
        } else {
          basketDropdown.style.display = 'block';
          setTimeout(() => { basketDropdown.classList.add('show'); }, 10);
        }
      });
    }

    document.addEventListener('click', function(e) {
      const clickedInside = basketDropdown.contains(e.target) ||
        e.target === basketDropdownBtn ||
        e.target === basketDropdownBtnMobile ||
        e.target.closest && (e.target.closest('#basketDropdownBtn') || e.target.closest('#basketDropdownBtnMobile')) ||
        (e.target.classList && e.target.classList.contains('basket-minus-btn'));
      if (!clickedInside && basketDropdown.classList.contains('show')) {
        basketDropdown.classList.remove('show');
        setTimeout(() => { basketDropdown.style.display = 'none'; }, 300);
      }
    });

    // Clear basket button functionality
    const clearBasketBtn = document.getElementById('clearBasketBtn');

    function clearBasket() {
      if (window.FitRightFirebase && window.FitRightFirebase.isLoggedIn()) {
        // Firebase mode
        window.FitRightFirebase.clearCart().then(() => {
          updateBasketDropdown();
          showToast("Basket cleared!");
        }).catch(error => {
          console.error("Error clearing Firebase cart:", error);
          showToast("Error clearing basket: " + error.message);
        });
      } else {
        // localStorage mode
        localStorage.removeItem("basket");
        updateBasketDropdown();
        showToast("Basket cleared!");
      }
    }

    if (clearBasketBtn) {
      clearBasketBtn.addEventListener('click', function(e) {
        e.stopPropagation();
        if (confirm("Are you sure you want to clear your basket?")) {
          clearBasket();
        }
      });
    }
    
    // Firebase cart rendering
    function renderFirebaseCart() {
      if (!window.FitRightFirebase) return;
      
      const cartItems = window.FitRightFirebase.getCartItems();
      const cartCount = window.FitRightFirebase.getCartCount();
      
      console.log("Firebase cart updated:", { items: cartItems, count: cartCount });
      
      // Update basket counters
      const basketCount = document.getElementById('basketCount');
      const basketCountMobile = document.getElementById('basketCountMobile');
      
      if (basketCount) {
        basketCount.textContent = cartCount;
        basketCount.style.display = cartCount > 0 ? 'inline-block' : 'none';
      }
      
      if (basketCountMobile) {
        basketCountMobile.textContent = cartCount;
        basketCountMobile.style.display = cartCount > 0 ? 'inline-block' : 'none';
      }
      
      // Update basket dropdown if it exists
      updateBasketDropdown();
    }
    
    // Listen for Firebase cart updates
    window.addEventListener('cartUpdated', renderFirebaseCart);
    
    // Load Firebase cart on page load
    document.addEventListener('DOMContentLoaded', () => {
      if (window.FitRightFirebase) {
        window.FitRightFirebase.loadCart().then(() => {
          renderFirebaseCart();
        });
      }
    });
    
    // Update basket count on page load
    updateBasketDropdown();
    // Update basket count when basket changes (listen to storage event for multi-tab)
    window.addEventListener('storage', function(e) {
      if (e.key === 'basket') updateBasketDropdown();
    });

    // Load basket items from localStorage on page load
    window.addEventListener('DOMContentLoaded', function() {
      populateProducts();
      updateBasketDropdown();
    });
  </script>

  <!-- Firebase Cart System -->
  <script type="module" src="./firebase.js?v=2"></script>
  <script type="module" src="./fitright-cart-only.js?v=2"></script>
  <script src="./shared-basket-dropdown.js"></script>
  <script>
    // Ensure minus buttons are always captured on mobile via pointer events
    (function(){
      const containerIds = ['basketDropdownContent'];
      function bind(container){
        if (!container || container.__mobileMinusBound) return;
        container.__mobileMinusBound = true;
        container.addEventListener('pointerup', function(e){
          const btn = e.target.closest('.basket-minus-btn');
          if (btn) {
            e.preventDefault();
            e.stopPropagation();
            if (window.__removeBasketItem) window.__removeBasketItem(btn);
          }
        }, { passive: false });
        container.addEventListener('touchend', function(e){
          const btn = e.target.closest('.basket-minus-btn');
          if (btn) {
            e.preventDefault();
            e.stopPropagation();
            if (window.__removeBasketItem) window.__removeBasketItem(btn);
          }
        }, { passive: false });
      }
      document.addEventListener('DOMContentLoaded', function(){
        containerIds.forEach(id => bind(document.getElementById(id)));
      });
      window.addEventListener('cartUpdated', function(){
        containerIds.forEach(id => bind(document.getElementById(id)));
      });
    })();
  </script>
  
  <!-- Basket Button Fix -->

</body>
</html>
